<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Konarak Food & Beverages — HRMS (Frontend Demo)</title>

  <!-- External libraries for later parts (SheetJS, html2canvas, jsPDF will be used later) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ---------- CORE THEME (dark-first) ---------- */
    :root{
      --bg-1: #071026; --bg-2: #0b1830;
      --header: #061426; --card: #071133; --muted: #99a7c0; --accent: #0ea5e9;
      --accent-strong: #00bfff; --text: #e6eef8;
      --danger: #ef4444;
      --glass: rgba(255,255,255,0.02);
    }
    [data-theme="light"]{
      --bg-1:#eef2f3; --bg-2:#d9e4f5; --header:#1f2937; --card:#fff; --muted:#6b7280; --accent:#2563eb; --text:#0f172a; --glass: rgba(0,0,0,0.03);
    }
    html,body{height:100%;}
    body{
      margin:0; font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(135deg,var(--bg-1),var(--bg-2));
      color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* Header */
    .header{
      height:64px; background:var(--header); color:var(--text);
      display:flex; align-items:center; justify-content:space-between;
      padding:0 20px; box-shadow: 0 6px 22px rgba(0,0,0,0.45); position:sticky; top:0; z-index:60;
    }
    .logo-row{display:flex;gap:12px;align-items:center;}
    .logo-image{width:44px;height:44px;object-fit:contain;border-radius:8px;background:var(--glass);padding:6px;}
    .app-title{font-weight:800;font-size:18px;}
    .header-right{display:flex;gap:12px;align-items:center;}

    .menu-icon{font-size:26px;cursor:pointer; user-select:none;}

    /* Side menu */
    .side-menu{
      position:fixed; top:0; left:-320px; width:320px; height:100vh; padding-top:64px;
      background: linear-gradient(180deg, rgba(2,6,23,0.95), rgba(6,10,30,0.95));
      color:var(--muted); transition: left 220ms ease; z-index:70; overflow:auto;
    }
    .side-menu a{display:block;padding:14px 20px;color:var(--muted);text-decoration:none;border-bottom:1px solid rgba(255,255,255,0.02);}
    .side-menu a:hover{background:rgba(255,255,255,0.02); color:var(--text);}

    .menu-backdrop{display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:65;}

    /* App area */
    .app{ padding:28px; margin-left:0; transition: margin-left 220ms ease; min-height:calc(100vh - 64px); }
    .container{ max-width:1180px; margin:0 auto; }

    /* Card grid (home) */
    .grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:22px; margin-top:12px; }

    .card{
      background:var(--card); border-radius:14px; padding:26px 18px; text-align:center; box-shadow: 0 8px 20px rgba(0,0,0,0.18);
      cursor:pointer; transition: transform 180ms ease, box-shadow 180ms ease; overflow:hidden; position:relative;
    }
    .card:hover{ transform:translateY(-6px); box-shadow: 0 18px 40px rgba(0,0,0,0.28); }
    .card .icon{ width:56px;height:56px;margin:0 auto 12px; opacity:0.95; filter:brightness(1.1); }
    .card .label{ font-weight:800; font-size:16px; color:var(--text); }

    /* sections + forms */
    .section{ background:var(--card); border-radius:12px; padding:18px; margin-bottom:18px; box-shadow: 0 8px 18px rgba(0,0,0,0.12); }
    .section-title{ font-weight:800; font-size:16px; margin-bottom:6px; color:var(--accent-strong); }
    .row{ display:flex; gap:12px; align-items:center; }
    .col{ flex:1; }

    .field{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--text); }
    .field.small{ padding:8px; font-size:13px; }

    .btn{ padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
    .btn.primary{ background:var(--accent-strong); color:#002033; }
    .btn.ghost{ background:transparent; color:var(--text); border:1px solid rgba(255,255,255,0.04); }

    table{ width:100%; border-collapse:collapse; margin-top:8px; }
    th,td{ text-align:left; padding:10px; border-bottom:1px solid rgba(255,255,255,0.03); font-size:13px; color:var(--text); }
    th{ font-weight:700; color:white; background:linear-gradient(90deg, rgba(10,20,40,0.95), rgba(5,15,30,0.9)); }

    .muted{ color:var(--muted); font-size:13px; }
    .mini{ font-size:12px; color:var(--muted); }

    /* login modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:120; }
    .modal{ width:420px; background:var(--card); border-radius:12px; padding:18px; box-shadow: 0 20px 60px rgba(0,0,0,0.6); }

    /* responsive */
    @media(max-width:900px){ .row{ flex-direction:column; } .side-menu{ width:260px; } }

  </style>
</head>
<body data-theme="dark">

  <!-- HEADER -->
  <div class="header">
    <div class="logo-row">
      <img src="logo.png" alt="Konarak Logo" class="logo-image" onerror="this.style.display='none'">
      <div>
        <div class="app-title">Konarak Food & Beverages — HRMS (Frontend)</div>
        <div class="mini muted">Local demo — secure your production deployment</div>
      </div>
    </div>

    <div class="header-right">
      <div class="muted" id="headerUser">Not signed in</div>
      <div class="menu-icon" onclick="toggleMenu()">☰</div>
    </div>
  </div>

  <!-- SIDE MENU -->
  <nav id="sideMenu" class="side-menu" aria-hidden="true">
    <a href="#" onclick="route('home')">Home</a>
    <a href="#" onclick="route('dashboard')">Dashboard</a>
    <a href="#" onclick="route('employees')">Employee Central</a>
    <a href="#" onclick="route('recruitment')">Recruitment</a>
    <a href="#" onclick="route('attendance')">Attendance</a>
    <a href="#" onclick="route('leave')">Leave Management</a>
    <a href="#" onclick="route('payroll')">Payroll</a>
    <a href="#" onclick="route('documents')">Documents</a>
    <a href="#" onclick="route('performance')">Performance</a>
    <a href="#" onclick="route('idcards')">ID Cards</a>
    <a href="#" onclick="route('letters')">Letters & Templates</a>
    <a href="#" onclick="route('reports')">Reports</a>
    <a href="#" onclick="route('settings')">Settings</a>
    <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:8px 0;">
    <a href="#" onclick="signOut()">Sign out</a>
  </nav>
  <div id="menuBackdrop" class="menu-backdrop" onclick="toggleMenu()"></div>

  <!-- APP -->
  <div class="app">
    <div class="container" id="appContainer">

      <!-- HOME VIEW -->
      <div id="homeView">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-size:20px;font-weight:800">Welcome to Konarak HRMS (Frontend)</div>
            <div class="muted">Dark theme enabled. All data stored locally (localStorage).</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="btn ghost" onclick="openLogin()">Sign in</button>
            <button class="btn ghost" onclick="downloadBackup()">Download Backup</button>
            <label style="display:inline-block;">
              <input type="file" id="uploadBackup" class="mini" style="display:none" onchange="importBackup(event)">
              <button class="btn ghost" onclick="document.getElementById('uploadBackup').click()">Upload Backup</button>
            </label>
          </div>
        </div>

        <div class="grid" style="margin-top:18px;">
          <div class="card" onclick="route('dashboard')">
            <img class="icon" src="https://img.icons8.com/ios-filled/100/ffffff/dashboard.png" alt="">
            <div class="label">Dashboard</div>
          </div>
          <div class="card" onclick="route('employees')">
            <img class="icon" src="https://img.icons8.com/ios-filled/100/ffffff/user-group-man-man.png" alt="">
            <div class="label">Employee Central</div>
          </div>
          <div class="card" onclick="route('recruitment')">
            <img class="icon" src="https://img.icons8.com/ios-filled/100/ffffff/resume.png" alt="">
            <div class="label">Recruitment</div>
          </div>
          <div class="card" onclick="route('attendance')">
            <img class="icon" src="https://img.icons8.com/ios-filled/100/ffffff/clock.png" alt="">
            <div class="label">Attendance</div>
          </div>
          <div class="card" onclick="route('payroll')">
            <img class="icon" src="https://img.icons8.com/ios-filled/100/ffffff/money-bag.png" alt="">
            <div class="label">Payroll</div>
          </div>
          <div class="card" onclick="route('documents')">
            <img class="icon" src="https://img.icons8.com/ios-filled/100/ffffff/document--v1.png" alt="">
            <div class="label">Documents</div>
          </div>
          <div class="card" onclick="route('idcards')">
            <img class="icon" src="https://img.icons8.com/ios-filled/100/ffffff/id-card.png" alt="">
            <div class="label">ID Cards</div>
          </div>
          <div class="card" onclick="route('letters')">
            <img class="icon" src="https://img.icons8.com/ios-filled/100/ffffff/new-post.png" alt="">
            <div class="label">Letters & Templates</div>
          </div>
        </div>
      </div>

      <!-- PLACEHOLDER VIEWS (will be replaced as part 2+) -->
      <div id="dashboardView" class="section" style="display:none;">
        <div class="section-title">Dashboard</div>
        <div class="row" style="margin-top:8px;">
          <div class="col section">
            <div class="mini">Total employees</div>
            <div style="font-weight:900;font-size:22px;" id="kpiEmployees">0</div>
            <div class="mini">Use Employee Central to add new employees</div>
          </div>
          <div class="col section">
            <div class="mini">Pending leaves</div>
            <div style="font-weight:900;font-size:22px;" id="kpiLeaves">0</div>
            <div class="mini">Leave management will show approvals</div>
          </div>
          <div class="col section">
            <div class="mini">Attendance logs</div>
            <div style="font-weight:900;font-size:22px;" id="kpiAttendance">0</div>
            <div class="mini">Attendance module will show IN/OUT</div>
          </div>
        </div>

        <div style="margin-top:14px;" id="recentActivity" class="small muted">No activity yet</div>
      </div>

      <!-- Employee central simple placeholder -->
    <!-- ========== EMPLOYEE CENTRAL (Replace the old employeesView block with this) ========== -->
<div id="employeesView" style="display:none;">
  <div class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div class="section-title">Employee Central</div>
        <div class="mini muted">Full employee master (SAP-style). Admin only: create/edit/delete employees.</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn primary" onclick="emp_openForm()">+ New Employee</button>
        <button class="btn ghost" onclick="emp_exportExcel()">Export Excel</button>
        <button class="btn ghost" onclick="emp_exportPdfAll()">Export PDF (All)</button>
        <button class="btn ghost" onclick="seedDemoData()">Seed Demo Data</button>
      </div>
    </div>

    <!-- SEARCH & FILTERS -->
    <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
      <input id="empSearch" class="field small" placeholder="Search by name,code,email,dept..." oninput="emp_renderList()" />
      <select id="empFilterDept" class="field small" onchange="emp_renderList()">
        <option value="">All Departments</option>
      </select>
      <select id="empFilterType" class="field small" onchange="emp_renderList()">
        <option value="">All Types</option>
        <option value="Permanent">Permanent</option>
        <option value="Contract">Contract</option>
      </select>
      <div style="margin-left:auto"><span class="mini muted">Total: <strong id="empTotal">0</strong></span></div>
    </div>

    <!-- FORM (collapsible) -->
    <div id="empFormWrap" class="section" style="margin-top:12px; display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:800" id="empFormTitle">New Employee</div>
        <div class="mini muted">Fields marked * are required</div>
      </div>

      <div style="margin-top:10px;">
        <!-- Row 1 -->
        <div class="row">
          <div class="col"><input id="f_fullname" class="field" placeholder="Full name *"></div>
          <div style="width:220px"><input id="f_code" class="field" placeholder="Employee code (EMP...)" ></div>
        </div>

        <!-- Row 2 -->
        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="f_email" class="field" placeholder="Email *"></div>
          <div class="col"><input id="f_phone" class="field" placeholder="Mobile"></div>
        </div>

        <!-- Row 3 -->
        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="f_department" class="field" placeholder="Department"></div>
          <div class="col"><input id="f_designation" class="field" placeholder="Designation"></div>
        </div>

        <!-- Row 4 -->
        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="f_doj" type="date" class="field" placeholder="Date of Joining"></div>
          <div class="col"><input id="f_dob" type="date" class="field" placeholder="Date of Birth"></div>
        </div>

        <!-- Row 5 (System & Type) -->
        <div class="row" style="margin-top:8px;">
          <div class="col">
            <select id="f_type" class="field">
              <option value="Permanent">Permanent</option>
              <option value="Contract">Contract</option>
            </select>
          </div>
          <div class="col"><input id="f_manager" class="field" placeholder="Reporting manager (code or name)"></div>
        </div>

        <!-- Salary block -->
        <div style="margin-top:10px; font-weight:800;">Salary & Payroll</div>
        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="f_basic" type="number" class="field" placeholder="Basic salary"></div>
          <div class="col"><input id="f_hra" type="number" class="field" placeholder="HRA"></div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="f_convey" type="number" class="field" placeholder="Conveyance"></div>
          <div class="col"><input id="f_special" type="number" class="field" placeholder="Special allowance"></div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="col"><label class="mini muted">PF Applicable</label><select id="f_pf" class="field small"><option value="yes">Yes</option><option value="no">No</option></select></div>
          <div class="col"><label class="mini muted">ESI Applicable</label><select id="f_esi" class="field small"><option value="yes">Yes</option><option value="no">No</option></select></div>
        </div>

        <!-- KYC & Bank -->
        <div style="margin-top:10px; font-weight:800;">KYC & Bank</div>
        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="f_aadhaar" class="field" placeholder="Aadhaar number"></div>
          <div class="col"><input id="f_pan" class="field" placeholder="PAN number"></div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="f_bank" class="field" placeholder="Bank name"></div>
          <div class="col"><input id="f_account" class="field" placeholder="Bank account number"></div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="f_ifsc" class="field" placeholder="IFSC"></div>
          <div class="col"><input id="f_location" class="field" placeholder="Branch / Location"></div>
        </div>

        <!-- Address -->
        <div style="margin-top:10px; font-weight:800;">Address</div>
        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="f_present" class="field" placeholder="Present address"></div>
          <div class="col"><input id="f_permanent" class="field" placeholder="Permanent address"></div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="f_city" class="field" placeholder="City"></div>
          <div class="col"><input id="f_state" class="field" placeholder="State"></div>
        </div>

        <!-- Photo & docs -->
        <div style="margin-top:10px;" class="mini muted">Photo & Documents</div>
        <div class="row" style="margin-top:6px;">
          <div class="col"><input id="f_photo" type="file" accept="image/*" class="field small"></div>
          <div class="col"><input id="f_docs" type="file" accept=".pdf,.jpg,.png" multiple class="field small"></div>
        </div>

        <!-- Buttons -->
        <div style="display:flex;gap:8px;margin-top:12px;">
          <button class="btn primary" id="empSaveBtn" onclick="emp_save()">Save employee</button>
          <button class="btn ghost" onclick="emp_cancel()">Cancel</button>
          <div style="margin-left:auto" class="mini muted">Password will be auto-generated and shown once.</div>
        </div>
      </div>
    </div>

    <!-- Employee list -->
    <div id="empListWrap" class="section" style="margin-top:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:800">Employees</div>
        <div class="mini muted">Actions: View • Edit • Delete • Export • Create login</div>
      </div>

      <div style="margin-top:8px; overflow:auto; max-height:420px;">
        <table id="empTable">
          <thead>
            <tr><th>Name</th><th>Code</th><th>Dept</th><th>Desig</th><th>Phone</th><th>Salary</th><th>Actions</th></tr>
          </thead>
          <tbody id="empTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<!-- ========== END EMPLOYEE CENTRAL ========== -->


      <!-- Recruitment placeholder -->
     <!-- ========== RECRUITMENT MODULE (PART 3) ========== -->
<div id="recruitmentView" style="display:none;">
  <div class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div class="section-title">Recruitment</div>
        <div class="mini muted">Candidates, stages, offers & hire (Offer → Accept → Hire)</div>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn primary" onclick="cand_openForm()">+ New Candidate</button>
        <button class="btn ghost" onclick="cand_exportExcel()">Export Candidates</button>
      </div>
    </div>

    <!-- Filters -->
    <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
      <input id="candSearch" class="field small" placeholder="Search candidate name, email, phone, position..." oninput="cand_renderList()" />
      <select id="candFilterStage" class="field small" onchange="cand_renderList()">
        <option value="">All Stages</option>
        <option value="New">New</option>
        <option value="Screening">Screening</option>
        <option value="Interview">Interview</option>
        <option value="Selected">Selected</option>
        <option value="Offer Generated">Offer Generated</option>
        <option value="Offer Accepted">Offer Accepted</option>
        <option value="Hired">Hired</option>
        <option value="Rejected">Rejected</option>
      </select>
      <select id="candFilterSource" class="field small" onchange="cand_renderList()">
        <option value="">All Sources</option>
        <option>LinkedIn</option><option>Referral</option><option>Website</option><option>Walk-in</option>
      </select>
      <div style="margin-left:auto" class="mini muted">Total candidates: <strong id="candTotal">0</strong></div>
    </div>

    <!-- Add / Edit Candidate Form -->
    <div id="candFormWrap" class="section" style="margin-top:12px; display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:800" id="candFormTitle">New Candidate</div>
        <div class="mini muted">Resume upload, expected salary, position</div>
      </div>

      <div style="margin-top:10px;">
        <div class="row">
          <div class="col"><input id="c_name" class="field" placeholder="Full name *"></div>
          <div style="width:220px"><input id="c_phone" class="field" placeholder="Phone"></div>
        </div>

        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="c_email" class="field" placeholder="Email *"></div>
          <div class="col"><input id="c_position" class="field" placeholder="Position applied"></div>
        </div>

        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="c_source" class="field" placeholder="Source (LinkedIn / Referral / Website)"></div>
          <div class="col"><input id="c_expected_salary" type="number" class="field" placeholder="Expected salary (annual)"></div>
        </div>

        <div style="margin-top:8px;">
          <label class="mini muted">Resume (PDF preferred)</label>
          <input id="c_resume" type="file" accept=".pdf,.doc,.docx" class="field small" />
        </div>

        <div style="margin-top:8px;">
          <textarea id="c_notes" class="field" rows="3" placeholder="Notes / interview feedback"></textarea>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px;">
          <button class="btn primary" id="candSaveBtn" onclick="cand_save()">Save Candidate</button>
          <button class="btn ghost" onclick="cand_cancel()">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Candidate List -->
    <div id="candListWrap" class="section" style="margin-top:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:800">Candidates</div>
        <div class="mini muted">Actions: View • Progress Stage • Generate Offer • Mark Accepted • Hire</div>
      </div>

      <div style="margin-top:8px; overflow:auto; max-height:440px;">
        <table id="candTable">
          <thead><tr><th>Name</th><th>Position</th><th>Phone</th><th>Expected (₹/yr)</th><th>Stage</th><th>Actions</th></tr></thead>
          <tbody id="candTableBody"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>
<!-- ========== END RECRUITMENT MODULE ========== -->


      <!-- Attendance placeholder -->
   <!-- ========== ATTENDANCE MODULE (PART 4) ========== -->
<div id="attendanceView" style="display:none;">
  <div class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div class="section-title">Attendance</div>
        <div class="mini muted">Check-In / Check-Out • Calendar + Table • Admin manual entries</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;">
        <div id="attendanceAdminControls" style="display:none;">
          <label class="mini muted">Employee</label>
          <select id="attendanceEmpSelect" class="field small"></select>
        </div>

        <button class="btn ghost" onclick="att_toggleView()">Switch View</button>
        <button class="btn ghost" onclick="att_exportExcel()">Export Excel</button>
        <button class="btn ghost" onclick="att_exportPdf()">Export PDF</button>
      </div>
    </div>

    <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
      <div id="attControlsLeft" style="display:flex;gap:8px;align-items:center;">
        <div id="attCheckWrap">
          <button class="btn primary" id="btnCheckIn" onclick="att_checkIn()">Check In</button>
          <button class="btn ghost" id="btnCheckOut" onclick="att_checkOut()">Check Out</button>
        </div>
      </div>

      <div style="margin-left:auto; display:flex; gap:10px; align-items:center;">
        <div class="mini muted">Selected Date</div>
        <input id="attSelectedDate" type="date" class="field small" onchange="att_renderAll()" />
      </div>
    </div>

    <!-- Calendar + Table container -->
    <div id="attViewWrap" style="margin-top:12px;">
      <!-- Calendar header -->
      <div id="attCalendar" class="section" style="display:block;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="font-weight:800">Attendance Calendar</div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="btn ghost" onclick="att_prevMonth()">◀</button>
            <div id="attMonthLabel" class="mini muted">Month</div>
            <button class="btn ghost" onclick="att_nextMonth()">▶</button>
          </div>
        </div>
        <div id="attCalendarGrid" style="margin-top:12px;"></div>
      </div>

      <!-- Table view -->
      <div id="attTable" class="section" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="font-weight:800">Attendance Table</div>
          <div class="mini muted">Date | In | Out | Hours | Late | Early | OT | Status</div>
        </div>
        <div style="margin-top:8px; overflow:auto; max-height:440px;">
          <table id="attTableBodyTable">
            <thead><tr><th>Date</th><th>Employee</th><th>Check In</th><th>Check Out</th><th>Hours</th><th>Late</th><th>Early</th><th>OT</th><th>Note</th><th>Actions</th></tr></thead>
            <tbody id="attTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Manual entry modal placeholder (created dynamically) -->
  </div>
</div>
<!-- ========== END ATTENDANCE MODULE ========== -->
<!-- ========== LEAVE MANAGEMENT MODULE (PART 5) ========== -->
<div id="leaveView" style="display:none;">
  <div class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div class="section-title">Leave Management</div>
        <div class="mini muted">Apply, Approve, Balances • Integrated with Attendance</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn primary" onclick="leave_openApply()">Apply Leave</button>
        <button class="btn ghost" onclick="leave_openTypeManager()">Leave Types</button>
        <button class="btn ghost" onclick="leave_exportExcel()">Export Leave Register</button>
      </div>
    </div>

    <!-- Top summary -->
    <div style="display:flex;gap:12px;margin-top:12px;">
      <div class="section" style="flex:1">
        <div class="mini muted">My Balance (if employee) / Company Summary</div>
        <div id="leaveBalanceSummary" style="margin-top:8px;"></div>
      </div>
      <div class="section" style="flex:1">
        <div class="mini muted">Pending Approvals</div>
        <div id="leavePendingCount" style="font-weight:900;font-size:22px;margin-top:8px;">0</div>
      </div>
    </div>

    <!-- Filter and list -->
    <div style="margin-top:12px" class="section">
      <div style="display:flex;gap:8px;align-items:center;">
        <input id="leaveSearch" class="field small" placeholder="Search by employee, date, type..." oninput="leave_renderList()" />
        <select id="leaveFilterStatus" class="field small" onchange="leave_renderList()">
          <option value="">All Statuses</option>
          <option value="Pending">Pending</option>
          <option value="Approved">Approved</option>
          <option value="Rejected">Rejected</option>
          <option value="Cancelled">Cancelled</option>
        </select>
        <select id="leaveFilterType" class="field small" onchange="leave_renderList()"><option value="">All Types</option></select>
        <div style="margin-left:auto" class="mini muted">Total leaves: <strong id="leaveTotal">0</strong></div>
      </div>

      <div style="margin-top:10px; overflow:auto; max-height:420px;">
        <table id="leaveTable">
          <thead><tr><th>Employee</th><th>Type</th><th>From</th><th>To</th><th>Days</th><th>Status</th><th>Applied</th><th>Actions</th></tr></thead>
          <tbody id="leaveTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<!-- ========== END LEAVE MANAGEMENT MODULE ========== -->


      
<!-- ========== PAYROLL & PAYSLIP MODULE (PART 6) ========== -->
<div id="payrollView" style="display:none;">
  <div class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div class="section-title">Payroll</div>
        <div class="mini muted">Run payroll • Payslip generation • Payroll register</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn primary" onclick="pay_openPayrollRun()">Run Payroll</button>
        <button class="btn ghost" onclick="pay_exportRegister()">Export Register</button>
        <button class="btn ghost" onclick="pay_viewLast()">Last Payroll</button>
      </div>
    </div>

    <!-- payroll filters -->
    <div style="margin-top:12px; display:flex;gap:8px;align-items:center;">
      <select id="pay_filter_emp" class="field small">
        <option value="">All Employees</option>
      </select>
      <input id="pay_filter_month" type="month" class="field small" />
      <div style="margin-left:auto" class="mini muted">Total payroll records: <strong id="payTotal">0</strong></div>
    </div>

    <!-- payroll table -->
    <div style="margin-top:12px;" class="section">
      <div style="font-weight:800">Payroll Register</div>
      <div style="margin-top:8px; overflow:auto; max-height:420px;">
        <table>
          <thead><tr><th>Month</th><th>Employee</th><th>Gross</th><th>Deductions</th><th>Net</th><th>Actions</th></tr></thead>
          <tbody id="payrollTableBody"></tbody>
        </table>
      </div>
    </div>

    <div id="payDetailsWrap" style="display:none;"></div>
  </div>
</div>
<!-- ========== END PAYROLL MODULE ========== -->

<!-- ========== LETTERS & TEMPLATES MODULE (PART 7) ========== -->
<div id="lettersView" style="display:none;">
  <div class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div class="section-title">Letters & Templates</div>
        <div class="mini muted">Offer, Appointment, Experience, Relieving, Salary Certificates, Hike letters — editable templates</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn primary" onclick="letters_openCreate()">New Letter (Single)</button>
        <button class="btn ghost" onclick="letters_openBulk()">Bulk Generate</button>
        <button class="btn ghost" onclick="letters_exportHistory()">Export History</button>
        <button class="btn ghost" onclick="letters_openTemplateManager()">Manage Templates</button>
      </div>
    </div>

    <!-- Search / Filters -->
    <div style="margin-top:12px; display:flex;gap:8px;align-items:center;">
      <input id="lettersSearch" class="field small" placeholder="Search letters or employee..." oninput="letters_renderHistory()" />
      <select id="lettersFilterType" class="field small" onchange="letters_renderHistory()">
        <option value="">All Types</option>
      </select>
      <select id="lettersFilterEmp" class="field small" onchange="letters_renderHistory()">
        <option value="">All Employees</option>
      </select>
      <div style="margin-left:auto" class="mini muted">Total: <strong id="lettersTotal">0</strong></div>
    </div>

    <!-- History -->
    <div style="margin-top:12px;" class="section">
      <div style="font-weight:800">Generated Letters</div>
      <div style="margin-top:8px; overflow:auto; max-height:420px;">
        <table>
          <thead><tr><th>Type</th><th>Employee</th><th>Date</th><th>Template</th><th>Actions</th></tr></thead>
          <tbody id="lettersHistoryBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<!-- ========== END LETTERS MODULE ========== -->


<!-- ========== PART 8: ID CARD ENGINE + EMPLOYEE SELF-SERVICE PORTAL (ESS) ========== -->
<!-- ID CARD VIEW -->
<div id="idcardView" style="display:none;">
  <div class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div class="section-title">ID Card Generator</div>
        <div class="mini muted">Premium vertical ID card • Gradient header • QR (Code + Name)</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn primary" onclick="id_openGenerator()">Generate ID Card</button>
        <button class="btn ghost" onclick="id_bulkGenerateAll()">Bulk Generate HTML</button>
      </div>
    </div>

    <div style="margin-top:12px; display:flex;gap:12px; align-items:center;">
      <select id="id_emp_select" class="field small" style="min-width:260px;"></select>
      <input id="id_file_name" class="field small" placeholder="Custom file name (optional)" />
      <button class="btn ghost" onclick="id_preview()">Preview</button>
      <button class="btn ghost" onclick="id_downloadPdf()">Download PDF</button>
      <button class="btn ghost" onclick="id_downloadHtml()">Download Profile HTML</button>
    </div>

    <div id="idPreviewWrap" style="margin-top:16px;"></div>

    <div style="margin-top:12px" class="section">
      <div style="font-weight:800">Generated ID Cards</div>
      <div class="mini muted">Use "Bulk Generate HTML" to create individual HTML files for employees (for GitHub Pages)</div>
    </div>
  </div>
</div>

<!-- ESS (Employee Self Service) VIEW -->
<div id="essView" style="display:none;">
  <div class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div class="section-title">Employee Portal (ESS)</div>
        <div class="mini muted">Profile, Attendance, Leaves, Payroll, Letters, ID Card</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <span class="mini muted">Employee login (code)</span>
        <input id="ess_login_code" class="field small" placeholder="Employee code (e.g., EMP123)" />
        <input id="ess_login_pass" type="password" class="field small" placeholder="Password" />
        <button class="btn primary" onclick="ess_login()">Sign In</button>
        <button class="btn ghost" onclick="ess_logout()">Sign Out</button>
      </div>
    </div>

    <div id="essContent" style="margin-top:12px;display:none;">
      <div style="display:flex;gap:12px;">
        <div style="width:260px;">
          <div id="essProfileCard" class="card" style="padding:12px;"></div>
          <div style="margin-top:12px;">
            <button class="btn ghost" onclick="ess_view('profile')">Profile</button>
            <button class="btn ghost" onclick="ess_view('attendance')">Attendance</button>
            <button class="btn ghost" onclick="ess_view('leaves')">Leaves</button>
            <button class="btn ghost" onclick="ess_view('payroll')">Payroll</button>
            <button class="btn ghost" onclick="ess_view('letters')">Letters</button>
            <button class="btn ghost" onclick="ess_view('idcard')">ID Card</button>
          </div>
        </div>

        <div style="flex:1;">
          <div id="essMainPane" class="section"></div>
        </div>
      </div>
    </div>

  </div>
</div>
<!-- ========== END PART 8 ========== -->



<!-- ========== PART 9: REPORTS (R2) ========== -->
<div id="reportsView" style="display:none;">
  <div class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div class="section-title">Reports & Analytics</div>
        <div class="mini muted">Standard Corporate Dashboard — charts: Dept, Employee Type, Attendance trend</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn ghost" onclick="reports_refreshAll()">Refresh</button>
        <button class="btn ghost" onclick="reports_exportPdf()">Export Dashboard (PDF)</button>
      </div>
    </div>

    <div style="margin-top:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
      <div class="card">
        <div style="font-weight:800">Total Employees</div>
        <div id="r_totalEmployees" style="font-size:26px;margin-top:8px">0</div>
      </div>
      <div class="card">
        <div style="font-weight:800">Active Today</div>
        <div id="r_activeToday" style="font-size:26px;margin-top:8px">0</div>
      </div>
      <div class="card">
        <div style="font-weight:800">On Leave Today</div>
        <div id="r_onLeaveToday" style="font-size:26px;margin-top:8px">0</div>
      </div>
    </div>

    <div style="margin-top:12px;display:grid;grid-template-columns:2fr 1fr;gap:12px;">
      <div class="card" style="padding:16px;">
        <div style="font-weight:800">Employees by Department</div>
        <canvas id="chartDept" style="max-height:320px;margin-top:12px"></canvas>
      </div>

      <div style="display:flex;flex-direction:column;gap:12px;">
        <div class="card" style="padding:12px;">
          <div style="font-weight:800">Employee Type</div>
          <canvas id="chartType" style="max-height:220px;margin-top:12px"></canvas>
        </div>
        <div class="card" style="padding:12px;">
          <div style="font-weight:800">Attendance (Month Avg)</div>
          <canvas id="chartAttendance" style="max-height:140px;margin-top:12px"></canvas>
        </div>
      </div>
    </div>

    <div style="margin-top:12px;" class="section">
      <div style="font-weight:800">Quick Table — Dept Summary</div>
      <div style="margin-top:8px;overflow:auto">
        <table id="r_dept_table">
          <thead><tr><th>Department</th><th>Employees</th><th>On Leave</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<!-- ========== END REPORTS ========== -->

<!-- ========== PART 10: DOCUMENTS (D2) ========== -->
<div id="documentsView" style="display:none;">
  <div class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div class="section-title">Documents Repository</div>
        <div class="mini muted">Categorized repository — Company Policies / HR Forms / Salary / Legal / Misc</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <input id="doc_search" class="field small" placeholder="Search documents..." oninput="docs_renderList()" />
        <button class="btn primary" onclick="docs_openUpload()">Upload Document</button>
        <button class="btn ghost" onclick="docs_exportList()">Export List</button>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:12px;">
      <div style="width:220px;">
        <div style="font-weight:800">Categories</div>
        <div style="margin-top:8px" id="doc_categories"></div>
        <div style="margin-top:12px">
          <input id="doc_new_cat" class="field small" placeholder="Add category" />
          <button class="btn ghost" onclick="docs_addCategory()">Add</button>
        </div>
      </div>

      <div style="flex:1;">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div style="font-weight:800">Documents</div>
            <div class="mini muted">Click to view • Admin can mark Public/Private</div>
          </div>
          <div style="margin-top:8px;overflow:auto;max-height:420px">
            <table id="docs_table" style="width:100%;border-collapse:collapse">
              <thead><tr><th>Title</th><th>Category</th><th>Visibility</th><th>Uploaded</th><th>Actions</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
<!-- ========== END DOCUMENTS ========== -->

<!-- ========== PART 11: SETTINGS (S3) ========== -->
<div id="settingsView" style="display:none;">
  <div class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div class="section-title">Settings</div>
        <div class="mini muted">Full system configuration • Modules • Theme • Attendance / Leave / Payroll rules • Backup & Audit</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn ghost" onclick="settings_exportBackup()">Export Backup</button>
        <input id="settings_import_file" type="file" style="display:none" onchange="settings_importBackup(event)" />
        <button class="btn ghost" onclick="document.getElementById('settings_import_file').click()">Import Backup</button>
      </div>
    </div>

    <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="card">
        <div style="font-weight:800">Company</div>
        <div style="margin-top:8px">
          <div class="mini muted">Name</div>
          <input id="set_company_name" class="field small" />
          <div class="mini muted" style="margin-top:8px">Logo (file)</div>
          <input id="set_company_logo" type="file" accept="image/*" onchange="settings_uploadLogo(event)" />
          <div style="margin-top:8px">
            <div class="mini muted">Primary Color</div>
            <input id="set_color_primary" class="field small" placeholder="#3b82f6" />
          </div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:800">Modules & Features</div>
        <div style="margin-top:8px">
          <label><input type="checkbox" id="mod_recruit"/> Recruitment</label><br/>
          <label><input type="checkbox" id="mod_attendance"/> Attendance</label><br/>
          <label><input type="checkbox" id="mod_leave"/> Leave</label><br/>
          <label><input type="checkbox" id="mod_payroll"/> Payroll</label><br/>
          <label><input type="checkbox" id="mod_ess"/> ESS</label><br/>
          <label><input type="checkbox" id="mod_documents"/> Documents</label>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:800">Attendance / Leave Rules</div>
        <div style="margin-top:8px">
          <div class="mini muted">Late threshold (HH:MM)</div>
          <input id="set_late_threshold" class="field small" placeholder="09:15" />
          <div class="mini muted" style="margin-top:8px">Work hours per day</div>
          <input id="set_work_hours" class="field small" placeholder="8" type="number" />
          <div style="margin-top:8px">
            <div class="mini muted">Weekly off (comma separated 0=Sun..6=Sat)</div>
            <input id="set_weekly_off" class="field small" placeholder="0" />
          </div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:800">Payroll & PF/ESI</div>
        <div style="margin-top:8px">
          <label><input type="checkbox" id="set_global_pf" /> Enable global PF default</label>
          <div class="mini muted" style="margin-top:8px">ESI threshold (gross)</div>
          <input id="set_esi_thr" class="field small" placeholder="21000" />
        </div>
      </div>

      <div class="card">
        <div style="font-weight:800">Department & Holiday Masters</div>
        <div style="margin-top:8px">
          <div class="mini muted">Departments (comma separated)</div>
          <input id="set_departments" class="field small" placeholder="Sales,Operations,HR" />
          <div style="margin-top:8px" class="mini muted">Holidays (YYYY-MM-DD,comma)</div>
          <input id="set_holidays" class="field small" placeholder="2025-01-26,2025-08-15" />
        </div>
      </div>

      <div class="card">
        <div style="font-weight:800">Audit Log</div>
        <div style="margin-top:8px">
          <div style="max-height:180px;overflow:auto;border:1px solid rgba(255,255,255,0.03);padding:8px" id="audit_log"></div>
          <div style="margin-top:8px"><button class="btn ghost" onclick="settings_clearAudit()">Clear Audit</button></div>
        </div>
      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn primary" onclick="settings_save()">Save Settings</button>
      <button class="btn ghost" onclick="settings_load()">Reload Settings</button>
    </div>

  </div>
</div>
<!-- ========== END SETTINGS ========== -->


      <!-- Settings placeholder -->
      <div id="settingsView" style="display:none;">
        <div class="section">
          <div class="section-title">Settings</div>
          <div style="display:flex;gap:12px;align-items:center;">
            <div>
              <div class="mini muted">Theme</div>
              <select id="themeSelect" class="field small" onchange="applyThemeLocal()">
                <option value="dark">Dark</option>
                <option value="light">Light</option>
                <option value="purple">Purple Accent</option>
                <option value="blue">Blue Accent</option>
              </select>
            </div>
            <div>
              <div class="mini muted">Admin account</div>
              <div class="mini">Admin: <strong>konarakfb@gmail.com</strong></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- LOGIN MODAL (reusable) -->
  <div id="loginModal" style="display:none;" class="modal-backdrop">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:800">Sign in</div>
        <div class="mini muted">Konarak HRMS</div>
      </div>

      <div style="margin-top:12px;">
        <div class="mini muted">Sign in as</div>
        <select id="loginRole" class="field small" style="margin-top:6px;">
          <option value="admin">Admin</option>
          <option value="employee">Employee</option>
        </select>

        <div id="adminLoginFields" style="margin-top:8px;">
          <input id="adminEmail" class="field small" placeholder="Email" value="konarakfb@gmail.com">
          <input id="adminPass" type="password" class="field small" placeholder="Password" value="Money@123">
        </div>

        <div id="empLoginFields" style="display:none;margin-top:8px;">
          <input id="empCode" class="field small" placeholder="Employee Code (e.g. EMP1001)">
          <input id="empPass" type="password" class="field small" placeholder="Password">
        </div>

        <div style="display:flex;gap:8px;margin-top:10px;">
          <button class="btn primary" onclick="performLogin()">Sign in</button>
          <button class="btn ghost" onclick="closeLogin()">Cancel</button>
        </div>

        <div class="mini muted" style="margin-top:8px;">Admin credentials: konarakfb@gmail.com / Money@123</div>
      </div>
    </div>
  </div>

<script>
/* ===========================
   Part 1: Core framework JS
   STORE structure and helpers
   =========================== */

const STORE_KEY = 'konarak_sf_complete_v1';

/* Default store template (safe seed) */
const DEFAULT_STORE = {
  meta: {
    createdAt: new Date().toISOString(),
    theme: 'dark',
    admins: [
      // seeded admin (your requested credentials)
      { email: 'konarakfb@gmail.com', password: 'Money@123', name: 'Konarak Admin', role: 'superadmin' }
    ]
  },
  employees: [],
  candidates: [],
  attendance: [],
  leaves: [],
  payroll: [],
  documents: [],
  goals: [],
  logs: [] // activity logs
};

let STORE = {};

/* Utility: safe load/save */
function loadStore(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw){ STORE = DEFAULT_STORE; saveStore(); return; }
    STORE = JSON.parse(raw);
    // ensure keys exist
    for(const k of Object.keys(DEFAULT_STORE)){
      if(typeof STORE[k] === 'undefined') STORE[k] = DEFAULT_STORE[k];
    }
  } catch(e){
    console.error('loadStore error', e);
    STORE = DEFAULT_STORE;
    saveStore();
  }
}
function saveStore(){
  localStorage.setItem(STORE_KEY, JSON.stringify(STORE));
}

/* UID generator */
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }

/* File to base64 helper (returns dataURL) */
function fileToBase64(file){ return new Promise((res,rej)=>{ const fr = new FileReader(); fr.onload = ()=> res(fr.result); fr.onerror = rej; fr.readAsDataURL(file); }); }

/* Escape for HTML insertion */
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"'`=\/]/g, function (c) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[c]; }); }

/* Logging helper */
function logActivity(text){
  STORE.logs = STORE.logs || [];
  STORE.logs.push({ text, time: new Date().toISOString() });
  if(STORE.logs.length > 5000) STORE.logs.shift();
  saveStore();
}

/* Initialize */
loadStore();

/* ===========================
   Theme engine
   =========================== */
function applyThemeLocal(){
  const sel = document.getElementById('themeSelect');
  const val = sel ? sel.value : (STORE.meta && STORE.meta.theme ? STORE.meta.theme : 'dark');
  if(val === 'light'){ document.body.setAttribute('data-theme','light'); STORE.meta.theme = 'light'; document.documentElement.style.setProperty('--accent-strong','#2563eb'); }
  else if(val === 'purple'){ document.body.setAttribute('data-theme','dark'); STORE.meta.theme = 'purple'; document.documentElement.style.setProperty('--accent-strong','#7c3aed'); }
  else if(val === 'blue'){ document.body.setAttribute('data-theme','dark'); STORE.meta.theme = 'blue'; document.documentElement.style.setProperty('--accent-strong','#0ea5e9'); }
  else { document.body.setAttribute('data-theme','dark'); STORE.meta.theme = 'dark'; document.documentElement.style.setProperty('--accent-strong','#0ea5e9'); }
  saveStore();
}
function applyThemeInitial(){
  const t = (STORE.meta && STORE.meta.theme) || 'dark';
  const sel = document.getElementById('themeSelect');
  if(sel) sel.value = t;
  applyThemeLocal();
}
applyThemeInitial();

/* ===========================
   Navigation + menu
   =========================== */
function toggleMenu(){
  const menu = document.getElementById('sideMenu');
  const backdrop = document.getElementById('menuBackdrop');
  if(menu.style.left === '0px'){ menu.style.left = '-320px'; backdrop.style.display = 'none'; }
  else { menu.style.left = '0px'; backdrop.style.display = 'block'; }
}
function route(view){
  // hide menu
  document.getElementById('sideMenu').style.left = '-320px';
  document.getElementById('menuBackdrop').style.display = 'none';
  // hide all views inside appContainer (direct children)
  const container = document.getElementById('appContainer');
  Array.from(container.children).forEach(ch => ch.style.display = 'none');

  // map view to id
  const map = {
    home: 'homeView',
    dashboard: 'dashboardView',
    employees: 'employeesView',
    recruitment: 'recruitmentView',
    attendance: 'attendanceView',
    leave: 'leaveView',
    payroll: 'payrollView',
    documents: 'documentsView',
    performance: 'performanceView',
    idcards: 'idcardsView',
    letters: 'lettersView',
    reports: 'reportsView',
    settings: 'settingsView'
  };
  const id = map[view] || 'homeView';
  const el = document.getElementById(id);
  if(el) el.style.display = 'block';
  // call renderers for specific pages (if available)
  try{ if(view === 'dashboard') renderDashboard(); if(view === 'employees') renderEmployeesShort(); } catch(e){ console.warn('route render error', e); }
  window.scrollTo({top:0, behavior:'smooth'});
}

/* ===========================
   AUTH: Login / session
   - Front-end session only
   - Admin and employee
   =========================== */

let SESSION = { user: null, role: null }; // role: admin | employee

function openLogin(){
  document.getElementById('loginModal').style.display = 'flex';
  // reset fields
  document.getElementById('loginRole').value = 'admin';
  document.getElementById('adminLoginFields').style.display = 'block';
  document.getElementById('empLoginFields').style.display = 'none';
}
function closeLogin(){ document.getElementById('loginModal').style.display = 'none'; }
document.getElementById('loginRole').addEventListener('change', function(e){
  const v = e.target.value;
  document.getElementById('adminLoginFields').style.display = v === 'admin' ? 'block' : 'none';
  document.getElementById('empLoginFields').style.display = v === 'employee' ? 'block' : 'none';
});

/* Perform login */
function performLogin(){
  const role = document.getElementById('loginRole').value;
  if(role === 'admin'){
    const email = (document.getElementById('adminEmail').value || '').trim();
    const pass = (document.getElementById('adminPass').value || '').trim();
    const found = (STORE.meta && STORE.meta.admins || []).find(a => a.email === email && a.password === pass);
    if(!found){ alert('Invalid admin credentials'); return; }
    SESSION = { user: found, role: 'admin' };
    closeLogin(); onSignedIn();
  } else {
    const code = (document.getElementById('empCode').value || '').trim();
    const pass = (document.getElementById('empPass').value || '').trim();
    if(!code || !pass){ alert('Employee code and password required'); return; }
    const emp = STORE.employees.find(e => (e.code === code || e.email === code) && e.password === pass);
    if(!emp){ alert('Invalid employee credentials'); return; }
    SESSION = { user: emp, role: 'employee' };
    closeLogin(); onSignedIn();
  }
}

/* Sign out */
function signOut(){
  SESSION = { user: null, role: null };
  document.getElementById('headerUser').innerText = 'Not signed in';
  route('home');
}

/* On sign-in */
function onSignedIn(){
  const role = SESSION.role;
  const name = SESSION.user && (SESSION.user.name || SESSION.user.fullname || SESSION.user.email) || 'user';
  document.getElementById('headerUser').innerText = `${name} (${role})`;
  logActivity(`${name} signed in as ${role}`);
  if(role === 'admin'){ route('dashboard'); }
  else { route('dashboard'); showEmployeeDashboard(); }
}

/* If a page needs to show employee-specific views, use this helper */
function requireAdmin(actionIfOk){
  if(SESSION.role !== 'admin') { alert('Admin access required'); return; }
  actionIfOk();
}

/* ===========================
   Simple UI renderers for Part1
   (will be expanded in later parts)
   =========================== */

function renderDashboard(){
  document.getElementById('kpiEmployees').innerText = (STORE.employees || []).length;
  document.getElementById('kpiLeaves').innerText = (STORE.leaves || []).filter(l=>l.status==='pending').length;
  document.getElementById('kpiAttendance').innerText = (STORE.attendance || []).length;
  // recent activity
  const recent = (STORE.logs || []).slice(-10).reverse();
  const out = recent.map(r => `<div class="mini" style="margin-bottom:6px">${escapeHtml(new Date(r.time).toLocaleString())} — ${escapeHtml(r.text)}</div>`).join('') || '<div class="mini muted">No recent activity</div>';
  document.getElementById('recentActivity').innerHTML = out;
}

/* Short employees render used on dashboard route */
function renderEmployeesShort(){
  const el = document.getElementById('empListPlaceholder');
  if(!el) return;
  if((STORE.employees||[]).length === 0) { el.innerHTML = '<div class="mini muted">No employees yet. Use Recruitment to add candidates and hire.</div>'; return; }
  const rows = STORE.employees.map(e => `<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.02)"><div><strong>${escapeHtml(e.fullname)}</strong><div class="mini muted">${escapeHtml(e.designation||'')} — ${escapeHtml(e.department||'')}</div></div><div class="mini muted">${escapeHtml(e.code||'')}</div></div>`).join('');
  el.innerHTML = rows;
}

/* Employee dashboard view for employees after login (basic) */
function showEmployeeDashboard(){
  // Ensure employee logged in
  if(!SESSION || SESSION.role !== 'employee') return;
  route('dashboard');
  // Add a custom welcome message for employee
  document.getElementById('recentActivity').innerHTML = `<div class="mini">Welcome ${escapeHtml(SESSION.user.fullname || SESSION.user.email)}. Use the left menu to view your data.</div>`;
}

/* ===========================
   Backup / Restore (single JSON)
   =========================== */
function downloadBackup(){
  const data = JSON.stringify(STORE, null, 2);
  const a = document.createElement('a');
  a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(data);
  a.download = `konarak_hrms_backup_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'_')}.json`;
  a.click();
  logActivity('Downloaded backup');
}
function importBackup(e){
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = () => {
    try{
      const parsed = JSON.parse(r.result);
      // Very small validation
      if(!parsed || typeof parsed !== 'object' || !parsed.meta) return alert('Invalid backup file');
      if(!confirm('Import backup will overwrite current local data. Continue?')) return;
      STORE = parsed;
      saveStore();
      renderDashboard();
      alert('Backup imported successfully.');
      logActivity('Imported backup');
    } catch(err){ alert('Invalid JSON file'); }
  };
  r.readAsText(f);
}

/* ===========================
   Prevent duplicate hires (recruitment safety)
   - Example usage in recruitment module (Part 3)
   =========================== */
function isDuplicateCandidate(candidate){
  // crude duplicate check: same email or phone or name+source
  const c = (STORE.candidates || []).find(x => (x.email && x.email === candidate.email) || (x.phone && x.phone === candidate.phone));
  if(c) return true;
  // also check employees
  const e = (STORE.employees || []).find(x => (x.email && x.email === candidate.email) || (x.phone && x.phone === candidate.phone));
  if(e) return true;
  return false;
}

/* ===========================
   Helper: seed sample data (for testing) - only when store empty and on admin action
   =========================== */
function seedDemoData(){
  if((STORE.employees||[]).length>0) { alert('Store already contains employees'); return; }
  // create 6 demo employees with passwords
  const demo = [
    {fullname:'Rahul Kumar', code:'EMP1001', email:'rahul@example.com', phone:'9876500011', department:'Operations', designation:'Manager', basic:30000},
    {fullname:'Asha Rani', code:'EMP1002', email:'asha@example.com', phone:'9876500022', department:'Sales', designation:'Executive', basic:22000},
    {fullname:'Siva Prasad', code:'EMP1003', email:'siva@example.com', phone:'9876500033', department:'Production', designation:'Supervisor', basic:25000},
    {fullname:'Maya Singh', code:'EMP1004', email:'maya@example.com', phone:'9876500044', department:'HR', designation:'HR Executive', basic:24000},
    {fullname:'Vikram Rao', code:'EMP1005', email:'vikram@example.com', phone:'9876500055', department:'Logistics', designation:'Lead', basic:26000},
    {fullname:'Neha Gupta', code:'EMP1006', email:'neha@example.com', phone:'9876500066', department:'Finance', designation:'Accountant', basic:27000}
  ];
  demo.forEach(d=>{
    const pwd = 'Welcome@' + Math.floor(Math.random()*900 + 100);
    const e = {...d, id: uid('emp'), password: pwd, photo:null, docs: [], doj: new Date().toISOString().slice(0,10), hra: Math.round(d.basic*0.2)};
    STORE.employees.push(e);
    logActivity(`Seed employee ${e.fullname} created (pwd:${pwd})`);
  });
  saveStore();
  alert('Demo employees seeded. Use Employee Central to see details. Default passwords created and logged to activity.');
  renderEmployeesShort();
}

/* Expose seed function to admin in console */
window.seedDemoData = seedDemoData;

/* ===========================
   Initial render
   =========================== */
renderDashboard();
renderEmployeesShort();
populateInitialUIState();

/* small helper to wire UI state on load */
function populateInitialUIState(){
  // header
  document.getElementById('headerUser').innerText = 'Not signed in';
  // set theme selector
  const sel = document.getElementById('themeSelect');
  if(sel) sel.value = STORE.meta.theme || 'dark';
  // route home
  route('home');
}


/* ===========================
   PART 2: Employee Central - Full SAP-style master
   Paste this block BEFORE the "End of Part 1 core file" comment
   It uses the existing STORE, saveStore(), uid(), fileToBase64(), escapeHtml(), logActivity(), requireAdmin()
   =========================== */

/* --- internal helper: get employee by id --- */
function emp_find(id){ return (STORE.employees||[]).find(e=>e.id===id); }

/* --- open form to create or edit --- */
function emp_openForm(editId){
  // Admin only
  if(SESSION.role !== 'admin') return alert('Admin access required');
  document.getElementById('empFormWrap').style.display = 'block';
  document.getElementById('empFormTitle').innerText = editId ? 'Edit Employee' : 'New Employee';
  // clear fields
  const ids = ['f_fullname','f_code','f_email','f_phone','f_department','f_designation','f_doj','f_dob','f_type','f_manager','f_basic','f_hra','f_convey','f_special','f_pf','f_esi','f_aadhaar','f_pan','f_bank','f_account','f_ifsc','f_location','f_present','f_permanent','f_city','f_state'];
  ids.forEach(i=> { const el=document.getElementById(i); if(el) el.value=''; });
  document.getElementById('f_photo').value=''; document.getElementById('f_docs').value='';
  // set defaults
  document.getElementById('f_type').value = 'Permanent';
  // store edit id on save button
  const saveBtn = document.getElementById('empSaveBtn');
  if(editId) saveBtn.dataset.edit = editId; else saveBtn.removeAttribute('data-edit');
  // preload existing when editing
  if(editId){
    const e = emp_find(editId);
    if(!e) return alert('Employee not found');
    document.getElementById('f_fullname').value = e.fullname || '';
    document.getElementById('f_code').value = e.code || '';
    document.getElementById('f_email').value = e.email || '';
    document.getElementById('f_phone').value = e.phone || '';
    document.getElementById('f_department').value = e.department || '';
    document.getElementById('f_designation').value = e.designation || '';
    document.getElementById('f_doj').value = e.doj || '';
    document.getElementById('f_dob').value = e.dob || '';
    document.getElementById('f_type').value = e.type || 'Permanent';
    document.getElementById('f_manager').value = e.manager || '';
    document.getElementById('f_basic').value = e.basic || 0;
    document.getElementById('f_hra').value = e.hra || 0;
    document.getElementById('f_convey').value = e.convey || 0;
    document.getElementById('f_special').value = e.special || 0;
    document.getElementById('f_pf').value = e.pf || 'yes';
    document.getElementById('f_esi').value = e.esi || 'no';
    document.getElementById('f_aadhaar').value = e.aadhaar || '';
    document.getElementById('f_pan').value = e.pan || '';
    document.getElementById('f_bank').value = e.bank || '';
    document.getElementById('f_account').value = e.account || '';
    document.getElementById('f_ifsc').value = e.ifsc || '';
    document.getElementById('f_location').value = e.location || '';
    document.getElementById('f_present').value = e.present_address || '';
    document.getElementById('f_permanent').value = e.permanent_address || '';
    document.getElementById('f_city').value = e.city || '';
    document.getElementById('f_state').value = e.state || '';
  }
  // scroll to form
  document.getElementById('empFormWrap').scrollIntoView({behavior:'smooth'});
}

/* --- cancel form --- */
function emp_cancel(){
  document.getElementById('empFormWrap').style.display = 'none';
  const saveBtn = document.getElementById('empSaveBtn'); if(saveBtn) saveBtn.removeAttribute('data-edit');
}

/* --- validate email basic --- */
function emp_isEmailValid(e){ return /\S+@\S+\.\S+/.test(e); }

/* --- generate secure password --- */
function emp_generatePassword(){
  const part = Math.random().toString(36).slice(-6);
  const special = ['@','!','#','$','%'][Math.floor(Math.random()*5)];
  return 'KF' + Math.floor(100+Math.random()*899) + part + special;
}

/* --- save employee (create/update) --- */
async function emp_save(){
  if(SESSION.role !== 'admin') return alert('Admin only');
  const saveBtn = document.getElementById('empSaveBtn');
  const editId = saveBtn && saveBtn.dataset && saveBtn.dataset.edit ? saveBtn.dataset.edit : null;

  // collect fields
  const data = {
    fullname: document.getElementById('f_fullname').value.trim(),
    code: document.getElementById('f_code').value.trim() || ('EMP' + Math.floor(1000 + Math.random()*8999)),
    email: document.getElementById('f_email').value.trim(),
    phone: document.getElementById('f_phone').value.trim(),
    department: document.getElementById('f_department').value.trim(),
    designation: document.getElementById('f_designation').value.trim(),
    doj: document.getElementById('f_doj').value,
    dob: document.getElementById('f_dob').value,
    type: document.getElementById('f_type').value,
    manager: document.getElementById('f_manager').value.trim(),
    basic: Number(document.getElementById('f_basic').value || 0),
    hra: Number(document.getElementById('f_hra').value || 0),
    convey: Number(document.getElementById('f_convey').value || 0),
    special: Number(document.getElementById('f_special').value || 0),
    pf: document.getElementById('f_pf').value,
    esi: document.getElementById('f_esi').value,
    aadhaar: document.getElementById('f_aadhaar').value.trim(),
    pan: document.getElementById('f_pan').value.trim(),
    bank: document.getElementById('f_bank').value.trim(),
    account: document.getElementById('f_account').value.trim(),
    ifsc: document.getElementById('f_ifsc').value.trim(),
    location: document.getElementById('f_location').value.trim(),
    present_address: document.getElementById('f_present').value.trim(),
    permanent_address: document.getElementById('f_permanent').value.trim(),
    city: document.getElementById('f_city').value.trim(),
    state: document.getElementById('f_state').value.trim()
  };

  // basic validation
  if(!data.fullname) return alert('Full name required');
  if(!data.email || !emp_isEmailValid(data.email)) return alert('Valid email required');

  // duplicate checks (code/email)
  const dupCode = (STORE.employees||[]).find(e => e.code === data.code && (!editId || e.id !== editId));
  if(dupCode) return alert('Employee code already exists');
  const dupEmail = (STORE.employees||[]).find(e => e.email === data.email && (!editId || e.id !== editId));
  if(dupEmail) return alert('Employee email already exists');

  // handle photo and docs
  const photoInput = document.getElementById('f_photo');
  if(photoInput && photoInput.files && photoInput.files[0]){
    data.photo = await fileToBase64(photoInput.files[0]);
  }

  const docsInput = document.getElementById('f_docs');
  data.docs = [];
  if(docsInput && docsInput.files && docsInput.files.length){
    for(const f of docsInput.files){
      const b = await fileToBase64(f);
      data.docs.push({ id: uid('doc'), name: f.name, data: b, uploadedAt: new Date().toISOString() });
    }
  }

  const now = new Date().toISOString();

  if(editId){
    // update
    const idx = (STORE.employees||[]).findIndex(x=>x.id===editId);
    if(idx === -1) return alert('Employee not found for update');
    const prev = STORE.employees[idx];
    // merge values, append docs if any
    const merged = {...prev, ...data, updatedAt: now};
    if(data.photo) merged.photo = data.photo;
    if(data.docs && data.docs.length) merged.docs = (prev.docs||[]).concat(data.docs);
    STORE.employees[idx] = merged;
    saveStore();
    emp_cancel();
    emp_renderList();
    emp_showMessage('Employee updated');
    logActivity(`Employee updated: ${merged.fullname} (${merged.code})`);
  } else {
    // create
    const id = uid('emp');
    const password = emp_generatePassword();
    const employee = {...data, id, createdAt: now, updatedAt: now, docs: data.docs || [], photo: data.photo || null, password};
    STORE.employees.push(employee);
    saveStore();
    emp_cancel();
    emp_renderList();
    emp_showMessage(`Employee created. Password: ${password}\n(Share with employee once)`);
    logActivity(`Employee created: ${employee.fullname} (${employee.code})`);
  }
  // refresh selects/filters
  emp_buildDeptFilter();
}

/* --- show transient message (small popup using alert fallback) --- */
function emp_showMessage(txt){
  // simple non-blocking toast
  try{
    const t = document.createElement('div');
    t.style.position='fixed'; t.style.right='20px'; t.style.bottom='20px'; t.style.background='var(--accent-strong)'; t.style.color='#001'; t.style.padding='10px 14px'; t.style.borderRadius='8px'; t.style.zIndex=9999; t.style.fontWeight=700; t.innerText = txt;
    document.body.appendChild(t);
    setTimeout(()=> t.remove(), 6000);
  } catch(e){ alert(txt); }
}

/* --- render employee list table --- */
function emp_renderList(){
  const tbody = document.getElementById('empTableBody');
  tbody.innerHTML = '';
  const q = (document.getElementById('empSearch').value || '').trim().toLowerCase();
  const deptFilter = document.getElementById('empFilterDept').value || '';
  const typeFilter = document.getElementById('empFilterType').value || '';
  let list = (STORE.employees||[]).slice().reverse(); // latest first
  if(q) list = list.filter(e => (e.fullname||'').toLowerCase().includes(q) || (e.code||'').toLowerCase().includes(q) || (e.email||'').toLowerCase().includes(q) || (e.department||'').toLowerCase().includes(q));
  if(deptFilter) list = list.filter(e=> (e.department||'') === deptFilter);
  if(typeFilter) list = list.filter(e=> (e.type||'') === typeFilter);
  list.forEach(e=>{
    const salary = Number(e.basic||0) + Number(e.hra||0) + Number(e.convey||0) + Number(e.special||0);
    tbody.insertAdjacentHTML('beforeend', `<tr>
      <td>${escapeHtml(e.fullname||'')}</td>
      <td>${escapeHtml(e.code||'')}</td>
      <td>${escapeHtml(e.department||'')}</td>
      <td>${escapeHtml(e.designation||'')}</td>
      <td>${escapeHtml(e.phone||'')}</td>
      <td>₹${salary.toFixed(2)}</td>
      <td>
        <button class="btn ghost" onclick="emp_view('${e.id}')">View</button>
        <button class="btn ghost" onclick="emp_edit('${e.id}')">Edit</button>
        <button class="btn ghost" onclick="emp_delete('${e.id}')">Delete</button>
        <button class="btn ghost" onclick="emp_exportPdf('${e.id}')">Export</button>
      </td>
    </tr>`);
  });
  document.getElementById('empTotal').innerText = (STORE.employees||[]).length;
}

/* --- view employee profile (modal) --- */
function emp_view(id){
  const e = emp_find(id);
  if(!e) return alert('Employee not found');
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  const html = `<div class="modal" style="width:760px;max-width:94vw;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:900">${escapeHtml(e.fullname)} (${escapeHtml(e.code||'')})</div>
      <div><button class="btn ghost" id="empCloseBtn">Close</button></div>
    </div>
    <div style="display:flex;gap:12px;margin-top:12px;">
      <div style="width:160px;height:200px;border-radius:8px;overflow:hidden;background:rgba(255,255,255,0.02);">
        ${e.photo ? `<img src="${e.photo}" style="width:100%;height:100%;object-fit:cover" />` : `<div style="padding:12px" class="mini muted">No photo</div>`}
      </div>
      <div style="flex:1">
        <div class="mini muted"><strong>Email:</strong> ${escapeHtml(e.email||'')}</div>
        <div class="mini muted"><strong>Phone:</strong> ${escapeHtml(e.phone||'')}</div>
        <div class="mini muted"><strong>Dept:</strong> ${escapeHtml(e.department||'')} • <strong>Desig:</strong> ${escapeHtml(e.designation||'')}</div>
        <div class="mini muted"><strong>Joining:</strong> ${escapeHtml(e.doj||'')} • <strong>Type:</strong> ${escapeHtml(e.type||'')}</div>
        <div style="margin-top:8px">
          <button class="btn primary" onclick="emp_downloadJson('${e.id}')">Download JSON</button>
          <button class="btn ghost" onclick="emp_exportPdf('${e.id}')">Download PDF</button>
        </div>
      </div>
      <div style="width:220px">
        <div class="mini muted"><strong>Salary</strong></div>
        <div class="mini">Basic: ₹${Number(e.basic||0).toFixed(2)}</div>
        <div class="mini">HRA: ₹${Number(e.hra||0).toFixed(2)}</div>
        <div class="mini">Conveyance: ₹${Number(e.convey||0).toFixed(2)}</div>
        <div style="margin-top:8px"><button class="btn ghost" onclick="emp_createPayslip('${e.id}')">Create Payslip</button></div>
      </div>
    </div>
    <div style="margin-top:12px;">
      <div style="font-weight:800;margin-bottom:6px">KYC & Bank</div>
      <div class="mini muted">Aadhaar: ${escapeHtml(e.aadhaar||'')}</div>
      <div class="mini muted">PAN: ${escapeHtml(e.pan||'')}</div>
      <div class="mini muted">Bank: ${escapeHtml(e.bank||'')} / ${escapeHtml(e.account||'')} / IFSC: ${escapeHtml(e.ifsc||'')}</div>
      <div style="margin-top:8px">
        <div style="font-weight:800;margin-bottom:6px">Documents</div>
        ${(e.docs || []).map(d=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(0,0,0,0.04)">${escapeHtml(d.name)}<div><button class="btn ghost" onclick="emp_downloadDoc('${e.id}','${d.id}')">Download</button></div></div>`).join('') || '<div class="mini muted">No documents</div>'}
      </div>
    </div>
  </div>`;
  modal.innerHTML = html;
  document.body.appendChild(modal);
  document.getElementById('empCloseBtn').addEventListener('click', ()=> modal.remove());
}

/* --- edit employee --- */
function emp_edit(id){
  requireAdmin(()=> {
    emp_openForm(id);
    // set dataset on save button
    document.getElementById('empSaveBtn').dataset.edit = id;
  });
}

/* --- delete employee --- */
function emp_delete(id){
  requireAdmin(()=> {
    if(!confirm('Delete employee and associated records?')) return;
    STORE.employees = (STORE.employees || []).filter(x=>x.id !== id);
    // purge attendance, leaves, payroll pointing to this employee
    STORE.attendance = (STORE.attendance||[]).filter(a=>a.employeeId !== id);
    STORE.leaves = (STORE.leaves||[]).filter(l=>l.employeeId !== id);
    STORE.payroll = (STORE.payroll||[]).filter(p=>p.employeeId !== id);
    saveStore();
    emp_renderList();
    logActivity(`Employee deleted: ${id}`);
  });
}

/* --- download employee JSON --- */
function emp_downloadJson(id){
  const e = emp_find(id);
  if(!e) return alert('Not found');
  const a = document.createElement('a');
  a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(e,null,2));
  a.download = `${e.code||e.id}.json`;
  a.click();
}

/* --- download employee document --- */
function emp_downloadDoc(empId, docId){
  const e = emp_find(empId);
  if(!e) return alert('Employee not found');
  const d = (e.docs||[]).find(x=>x.id===docId);
  if(!d) return alert('Document not found');
  const a = document.createElement('a');
  a.href = d.data;
  a.download = d.name;
  a.click();
}

/* --- export single employee as PDF --- */
async function emp_exportPdf(id){
  const e = emp_find(id);
  if(!e) return alert('Employee not found');
  // build a printable node
  const node = document.createElement('div');
  node.style.width = '800px';
  node.style.padding = '18px';
  node.style.background = '#fff';
  node.style.color = '#000';
  node.innerHTML = `
    <div style="display:flex;gap:12px;align-items:center;">
      <img src="logo.png" style="width:90px;height:90px;object-fit:contain" onerror="this.style.display='none'">
      <div>
        <div style="font-weight:900;font-size:20px">Konarak Food & Beverages</div>
        <div style="font-size:14px">Employee Profile</div>
      </div>
    </div>
    <hr style="margin:10px 0;border:none;border-top:1px solid #ddd">
    <div style="display:flex;gap:12px;">
      <div style="width:160px;height:160px;border:1px solid #ddd">${e.photo ? `<img src="${e.photo}" style="width:100%;height:100%;object-fit:cover">` : ''}</div>
      <div style="flex:1;">
        <div style="font-weight:800;font-size:18px">${escapeHtml(e.fullname)}</div>
        <div class="mini">Code: ${escapeHtml(e.code||'')}</div>
        <div class="mini">Email: ${escapeHtml(e.email||'')}</div>
        <div class="mini">Phone: ${escapeHtml(e.phone||'')}</div>
        <div style="margin-top:8px">
          <div class="mini"><strong>Department:</strong> ${escapeHtml(e.department||'')}</div>
          <div class="mini"><strong>Designation:</strong> ${escapeHtml(e.designation||'')}</div>
          <div class="mini"><strong>Joining:</strong> ${escapeHtml(e.doj||'')}</div>
          <div class="mini"><strong>Type:</strong> ${escapeHtml(e.type||'')}</div>
        </div>
      </div>
    </div>
    <hr style="margin:10px 0;border:none;border-top:1px solid #ddd">
    <div>
      <div style="font-weight:800;margin-bottom:6px">Salary & Bank</div>
      <div class="mini">Basic: ₹${Number(e.basic||0).toFixed(2)} • HRA: ₹${Number(e.hra||0).toFixed(2)} • Convey: ₹${Number(e.convey||0).toFixed(2)}</div>
      <div class="mini">Bank: ${escapeHtml(e.bank||'')} • A/C: ${escapeHtml(e.account||'')} • IFSC: ${escapeHtml(e.ifsc||'')}</div>
    </div>
  `;
  document.body.appendChild(node);
  const canvas = await html2canvas(node, { scale: 2 });
  const img = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
  const pageW = pdf.internal.pageSize.getWidth();
  const imgW = pageW - 40;
  pdf.addImage(img, 'PNG', 20, 20, imgW, 0);
  pdf.save(`Employee_${e.code||e.id}.pdf`);
  document.body.removeChild(node);
}

/* --- export all employees to Excel --- */
function emp_exportExcel(){
  const rows = (STORE.employees||[]).map(e => ({ Code: e.code, Name: e.fullname, Email: e.email, Dept: e.department, Desig: e.designation, Basic: e.basic }));
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'Employees');
  XLSX.writeFile(wb, 'Employees.xlsx');
}

/* --- export pdf for all (simple concatenation) --- */
async function emp_exportPdfAll(){
  const all = STORE.employees || [];
  if(all.length === 0) return alert('No employees');
  // For each employee create a small pdf page and combine (simple sequential saves to multiple PDFs is heavy)
  // We'll create a single PDF with pages appended
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit: 'pt', format: 'a4' });
  for(let i=0;i<all.length;i++){
    const e=all[i];
    const node = document.createElement('div');
    node.style.width='800px'; node.style.padding='18px'; node.style.background='#fff'; node.style.color='#000';
    node.innerHTML = `<div style="font-weight:800;font-size:18px">${escapeHtml(e.fullname)} — ${escapeHtml(e.code||'')}</div>
      <div class="mini">Email: ${escapeHtml(e.email||'')} • Dept: ${escapeHtml(e.department||'')}</div>
      <div style="margin-top:8px">Basic: ₹${Number(e.basic||0).toFixed(2)}</div>`;
    document.body.appendChild(node);
    // render
    // eslint-disable-next-line no-await-in-loop
    const canvas = await html2canvas(node, { scale: 2 });
    const img = canvas.toDataURL('image/png');
    const w = pdf.internal.pageSize.getWidth() - 40;
    if(i>0) pdf.addPage();
    pdf.addImage(img, 'PNG', 20, 20, w, 0);
    document.body.removeChild(node);
  }
  pdf.save('Employees_All.pdf');
}

/* --- create payslip for employee (basic) --- */
function emp_createPayslip(empId){
  const e = emp_find(empId);
  if(!e) return alert('Employee not found');
  // simple net calculation (similar to Part1 payroll)
  const basic = Number(e.basic||0);
  const hra = Number(e.hra||0);
  const conv = Number(e.convey||0);
  const special = Number(e.special||0);
  const gross = basic + hra + conv + special;
  const pf = e.pf === 'yes' ? Math.round(basic*0.12) : 0;
  const net = gross - pf;
  const rec = { id: uid('pay'), employeeId: empId, month: new Date().toISOString().slice(0,7), basic, hra, conv, special, gross, pf, net, generatedAt: new Date().toISOString() };
  STORE.payroll = STORE.payroll || [];
  STORE.payroll.push(rec);
  saveStore();
  emp_showMessage('Payslip created (Payroll record saved)');
  logActivity(`Payslip created for ${e.fullname}`);
}

/* --- build department filter options --- */
function emp_buildDeptFilter(){
  const sel = document.getElementById('empFilterDept');
  if(!sel) return;
  const depts = Array.from(new Set((STORE.employees||[]).map(e => e.department).filter(Boolean)));
  sel.innerHTML = '<option value="">All Departments</option>' + depts.map(d=>`<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`).join('');
}

/* --- create employee login page (not creating files — creates credentials only) --- */
function emp_generateLoginCredentials(empId){
  const e = emp_find(empId);
  if(!e) return alert('Employee not found');
  // set or reset password
  const pwd = emp_generatePassword();
  e.password = pwd;
  saveStore();
  emp_showMessage(`Password set for ${e.fullname}: ${pwd}`);
  logActivity(`Password generated for ${e.code}`);
  // NOTE: you'll need to distribute the password to the employee securely
}

/* initial render hook */
(function emp_init(){
  emp_buildDeptFilter();
  emp_renderList();
}());

/* expose some functions to global for button onclicks */
window.emp_openForm = emp_openForm;
window.emp_cancel = emp_cancel;
window.emp_save = emp_save;
window.emp_renderList = emp_renderList;
window.emp_view = emp_view;
window.emp_edit = emp_edit;
window.emp_delete = emp_delete;
window.emp_exportPdf = emp_exportPdf;
window.emp_exportExcel = emp_exportExcel;
window.emp_exportPdfAll = emp_exportPdfAll;
window.emp_createPayslip = emp_createPayslip;
window.emp_downloadJson = emp_downloadJson;
window.emp_generateLoginCredentials = emp_generateLoginCredentials;

/* ===========================
   End PART 2 code block
   =========================== */
/* ===========================
   PART 3: Recruitment Module (Offer-first workflow, Option C)
   Paste this block BEFORE the "End of Part 1 core file" comment.
   Depends on: STORE, saveStore(), uid(), fileToBase64(), escapeHtml(), logActivity(), emp_openForm(), emp_generateLoginCredentials(), isDuplicateCandidate()
   =========================== */

/* --- Candidate helper --- */
function cand_find(id){ return (STORE.candidates||[]).find(c=>c.id===id); }

/* --- open new candidate form --- */
function cand_openForm(editId){
  // admin only
  if(SESSION.role !== 'admin') return alert('Admin access required');
  document.getElementById('candFormWrap').style.display = 'block';
  document.getElementById('candFormTitle').innerText = editId ? 'Edit Candidate' : 'New Candidate';
  // clear fields
  ['c_name','c_phone','c_email','c_position','c_source','c_expected_salary','c_resume','c_notes'].forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; });
  const saveBtn = document.getElementById('candSaveBtn');
  if(editId) saveBtn.dataset.edit = editId; else saveBtn.removeAttribute('data-edit');
}

/* --- cancel candidate form --- */
function cand_cancel(){ document.getElementById('candFormWrap').style.display='none'; const s=document.getElementById('candSaveBtn'); if(s) s.removeAttribute('data-edit'); }

/* --- duplicate check for candidate creation --- */
function cand_isDuplicate(candidate){
  // duplicate if email or phone already in candidates or employees
  const email = (candidate.email || '').toLowerCase();
  const phone = (candidate.phone || '').toString().trim();
  if(!email && !phone) return false;
  const dup1 = (STORE.candidates||[]).find(c => (c.email && c.email.toLowerCase() === email) || (c.phone && c.phone === phone));
  if(dup1) return true;
  const dup2 = (STORE.employees||[]).find(e => (e.email && e.email.toLowerCase() === email) || (e.phone && e.phone === phone));
  if(dup2) return true;
  return false;
}

/* --- save candidate --- */
async function cand_save(){
  if(SESSION.role !== 'admin') return alert('Admin access required');
  const saveBtn = document.getElementById('candSaveBtn');
  const editId = saveBtn && saveBtn.dataset && saveBtn.dataset.edit ? saveBtn.dataset.edit : null;

  const candidate = {
    name: (document.getElementById('c_name').value || '').trim(),
    phone: (document.getElementById('c_phone').value || '').trim(),
    email: (document.getElementById('c_email').value || '').trim(),
    position: (document.getElementById('c_position').value || '').trim(),
    source: (document.getElementById('c_source').value || '').trim(),
    expectedSalary: Number(document.getElementById('c_expected_salary').value || 0),
    notes: (document.getElementById('c_notes').value || '').trim(),
    resume: null,
    stage: 'New',
    createdAt: new Date().toISOString(),
    offer: null,
    hired: false
  };

  // basic validation
  if(!candidate.name) return alert('Candidate name required');
  if(!candidate.email || !/\S+@\S+\.\S+/.test(candidate.email)) return alert('Valid email required');

  // resume file
  const resumeInput = document.getElementById('c_resume');
  if(resumeInput && resumeInput.files && resumeInput.files[0]){
    candidate.resume = { name: resumeInput.files[0].name, data: await fileToBase64(resumeInput.files[0]) };
  }

  // duplicate prevention (exclude edit)
  if(!editId && cand_isDuplicate(candidate)) return alert('Duplicate candidate or candidate already exists as employee (email/phone).');

  if(editId){
    // update
    const idx = (STORE.candidates||[]).findIndex(x=>x.id===editId);
    if(idx === -1) return alert('Candidate not found');
    const prev = STORE.candidates[idx];
    const merged = {...prev, ...candidate, updatedAt: new Date().toISOString()};
    // keep existing resume if not replaced
    if(!candidate.resume) merged.resume = prev.resume || null;
    // stage and offer preserved unless changed through actions
    merged.stage = prev.stage || merged.stage;
    STORE.candidates[idx] = merged;
    saveStore();
    cand_cancel();
    cand_renderList();
    logActivity(`Candidate updated: ${merged.name}`);
    cand_showToast('Candidate updated');
  } else {
    // create new candidate
    const id = uid('cand');
    candidate.id = id;
    candidate.createdAt = new Date().toISOString();
    STORE.candidates = STORE.candidates || [];
    STORE.candidates.push(candidate);
    saveStore();
    cand_cancel();
    cand_renderList();
    logActivity(`Candidate created: ${candidate.name}`);
    cand_showToast('Candidate added');
  }
}

/* --- transient toast --- */
function cand_showToast(t){
  const el = document.createElement('div');
  el.style.position='fixed'; el.style.left='20px'; el.style.bottom='20px'; el.style.background='var(--accent-strong)'; el.style.color='#001'; el.style.padding='10px 14px'; el.style.borderRadius='8px'; el.style.zIndex=9999; el.innerText = t;
  document.body.appendChild(el);
  setTimeout(()=> el.remove(), 4500);
}

/* --- render candidate list --- */
function cand_renderList(){
  const body = document.getElementById('candTableBody');
  if(!body) return;
  body.innerHTML = '';
  const q = (document.getElementById('candSearch').value || '').trim().toLowerCase();
  const stageFilter = (document.getElementById('candFilterStage').value || '');
  const srcFilter = (document.getElementById('candFilterSource').value || '');
  let list = (STORE.candidates||[]).slice().reverse();
  if(q) list = list.filter(c => (c.name||'').toLowerCase().includes(q) || (c.email||'').toLowerCase().includes(q) || (c.phone||'').toLowerCase().includes(q) || (c.position||'').toLowerCase().includes(q));
  if(stageFilter) list = list.filter(c => c.stage === stageFilter);
  if(srcFilter) list = list.filter(c => (c.source||'') === srcFilter);
  list.forEach(c=>{
    body.insertAdjacentHTML('beforeend', `<tr>
      <td>${escapeHtml(c.name)}</td>
      <td>${escapeHtml(c.position||'')}</td>
      <td>${escapeHtml(c.phone||'')}</td>
      <td>${c.expectedSalary ? '₹' + Number(c.expectedSalary).toLocaleString() : '-'}</td>
      <td>${escapeHtml(c.stage||'New')}</td>
      <td>
        <button class="btn ghost" onclick="cand_view('${c.id}')">View</button>
        ${c.stage !== 'Hired' && c.stage !== 'Rejected' ? `<button class="btn ghost" onclick="cand_nextStagePrompt('${c.id}')">Next</button>` : ''}
        ${c.stage !== 'Offer Generated' ? `<button class="btn ghost" onclick="cand_generateOfferModal('${c.id}')">Offer</button>` : `<button class="btn ghost" onclick="cand_viewOffer('${c.id}')">View Offer</button>`}
        ${c.stage === 'Offer Accepted' && !c.hired ? `<button class="btn primary" onclick="cand_hire('${c.id}')">Hire</button>` : ''}
        ${c.stage !== 'Hired' ? `<button class="btn ghost" onclick="cand_reject('${c.id}')">Reject</button>` : ''}
      </td>
    </tr>`);
  });
  document.getElementById('candTotal').innerText = (STORE.candidates||[]).length;
}

/* --- view candidate modal --- */
function cand_view(id){
  const c = cand_find(id);
  if(!c) return alert('Candidate not found');
  const modal = document.createElement('div'); modal.className = 'modal-backdrop';
  const resumeHtml = c.resume ? `<div style="margin-top:8px"><button class="btn ghost" onclick="cand_previewResume('${id}')">Preview Resume</button></div>` : '<div class="mini muted">No resume</div>';
  modal.innerHTML = `<div class="modal" style="width:720px;max-width:96vw;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:900">${escapeHtml(c.name)}</div>
      <div><button class="btn ghost" id="candCloseBtn">Close</button></div>
    </div>
    <div style="margin-top:8px">
      <div class="mini muted">Email: ${escapeHtml(c.email)} • Phone: ${escapeHtml(c.phone)} • Position: ${escapeHtml(c.position||'')}</div>
      <div style="margin-top:8px">${escapeHtml(c.notes||'')}</div>
      ${resumeHtml}
      <div style="margin-top:10px" class="mini muted">Stage: ${escapeHtml(c.stage||'New')}</div>
      ${c.offer ? `<div style="margin-top:8px"><strong>Offer:</strong> ${escapeHtml(c.offer.status||'')} • Gross CTC: ₹${Number(c.offer.grossAnnual||0).toLocaleString()}</div>` : ''}
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button class="btn ghost" onclick="cand_edit('${id}')">Edit</button>
        ${c.stage !== 'Hired' && c.stage !== 'Rejected' ? `<button class="btn ghost" onclick="cand_nextStagePrompt('${id}')">Next Stage</button>` : ''}
        ${c.stage === 'Offer Generated' ? `<button class="btn primary" onclick="cand_sendOffer('${id}')">Mark Offer Sent</button>` : ''}
        ${c.stage === 'Offer Generated' ? `<button class="btn ghost" onclick="cand_viewOffer('${id}')">View Offer</button>` : ''}
        ${c.stage === 'Offer Accepted' && !c.hired ? `<button class="btn primary" onclick="cand_hire('${id}')">Hire</button>` : ''}
      </div>
    </div>
  </div>`;
  document.body.appendChild(modal);
  document.getElementById('candCloseBtn').addEventListener('click', ()=> modal.remove());
}

/* --- preview resume in new window --- */
function cand_previewResume(id){
  const c = cand_find(id);
  if(!c || !c.resume) return alert('No resume available');
  const w = window.open('');
  if(c.resume.data.startsWith('data:application/pdf')) {
    w.document.write(`<iframe src="${c.resume.data}" style="width:100%;height:100vh;border:none;"></iframe>`);
  } else {
    // display as link
    const a = `<a href="${c.resume.data}" download="${escapeHtml(c.resume.name)}">Download Resume</a>`;
    w.document.write(a);
  }
}

/* --- next stage prompt & action --- */
function cand_nextStagePrompt(id){
  const c = cand_find(id);
  if(!c) return;
  const stages = ['New','Screening','Interview','Selected','Offer Generated','Offer Accepted','Hired','Rejected'];
  const nextIndex = Math.min(stages.indexOf(c.stage || 'New') + 1, stages.length - 1);
  if(nextIndex < 0) return;
  const nextStage = stages[nextIndex];
  if(!confirm(`Move candidate ${c.name} to stage: ${nextStage}?`)) return;
  c.stage = nextStage;
  saveStore();
  cand_renderList();
  logActivity(`Candidate ${c.name} moved to ${nextStage}`);
  cand_showToast(`Moved to ${nextStage}`);
}

/* --- reject candidate --- */
function cand_reject(id){
  if(!confirm('Reject candidate?')) return;
  const c = cand_find(id);
  if(!c) return;
  c.stage = 'Rejected';
  saveStore();
  cand_renderList();
  logActivity(`Candidate rejected: ${c.name}`);
}

/* --- generate offer modal (collect offer params) --- */
function cand_generateOfferModal(id){
  const c = cand_find(id);
  if(!c) return;
  const modal = document.createElement('div'); modal.className='modal-backdrop';
  modal.innerHTML = `<div class="modal" style="width:760px;max-width:96vw;">
    <div style="display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:900">Generate Offer — ${escapeHtml(c.name)}</div><div><button class="btn ghost" id="offerCloseBtn">Close</button></div></div>
    <div style="margin-top:8px;">
      <div class="mini muted">Fill salary breakup & terms (annual amounts)</div>
      <div style="margin-top:8px" class="row">
        <div class="col"><input id="offer_basic" class="field small" placeholder="Basic (annual)"></div>
        <div class="col"><input id="offer_hra" class="field small" placeholder="HRA (annual)"></div>
      </div>
      <div style="margin-top:8px" class="row">
        <div class="col"><input id="offer_convey" class="field small" placeholder="Conveyance (annual)"></div>
        <div class="col"><input id="offer_special" class="field small" placeholder="Special allowance (annual)"></div>
      </div>
      <div style="margin-top:8px" class="row">
        <div class="col"><input id="offer_bonus" class="field small" placeholder="Variable / Bonus (annual)"></div>
        <div class="col"><input id="offer_employer_pf" class="field small" placeholder="Employer PF contribution (annual)"></div>
      </div>
      <div style="margin-top:8px" class="row">
        <div class="col"><input id="offer_probation" class="field small" placeholder="Probation period (months)"></div>
        <div class="col"><input id="offer_notice" class="field small" placeholder="Notice period (months)"></div>
      </div>
      <div style="margin-top:8px"><input id="offer_joining" type="date" class="field small" placeholder="Proposed joining date"></div>
      <div style="margin-top:8px"><textarea id="offer_notes" class="field small" rows="3" placeholder="Additional clauses (e.g., confidentiality, leaves summary)"></textarea></div>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button class="btn primary" onclick="cand_generateOffer('${id}')">Generate Offer PDF & Save</button>
        <button class="btn ghost" id="offerCancel">Cancel</button>
      </div>
    </div>
  </div>`;
  document.body.appendChild(modal);
  document.getElementById('offerCloseBtn').addEventListener('click', ()=> modal.remove());
  document.getElementById('offerCancel').addEventListener('click', ()=> modal.remove());
}

/* --- actually generate offer (save to candidate + produce PDF) --- */
async function cand_generateOffer(id){
  const c = cand_find(id);
  if(!c) return alert('Candidate not found');
  // read inputs
  const basicA = Number(document.getElementById('offer_basic').value || 0);
  const hraA = Number(document.getElementById('offer_hra').value || 0);
  const conveyA = Number(document.getElementById('offer_convey').value || 0);
  const specialA = Number(document.getElementById('offer_special').value || 0);
  const bonusA = Number(document.getElementById('offer_bonus').value || 0);
  const employerPfA = Number(document.getElementById('offer_employer_pf').value || 0);
  const probationMonths = Number(document.getElementById('offer_probation').value || 0);
  const noticeMonths = Number(document.getElementById('offer_notice').value || 0);
  const joiningDate = document.getElementById('offer_joining').value || '';
  const notes = document.getElementById('offer_notes').value || '';

  if(!basicA || !joiningDate) return alert('Basic annual and joining date required');

  // calculations (annual)
  const grossAnnual = basicA + hraA + conveyA + specialA + bonusA;
  const monthlyGross = Math.round(grossAnnual / 12);
  const employeePfDeductionMonthly = Math.round((basicA * 0.12) / 12); // employee PF deduction monthly
  const employerPfMonthly = Math.round((employerPfA || (basicA * 0.12)) / 12); // use provided employer PF or default 12%
  const esiApplicable = false; // can extend with toggle

  // prepare offer object
  const offer = {
    id: uid('offer'),
    generatedAt: new Date().toISOString(),
    basicAnnual: basicA,
    hraAnnual: hraA,
    conveyAnnual: conveyA,
    specialAnnual: specialA,
    bonusAnnual: bonusA,
    employerPfAnnual: employerPfA,
    grossAnnual,
    monthlyGross,
    employeePfDeductionMonthly,
    employerPfMonthly,
    probationMonths,
    noticeMonths,
    joiningDate,
    notes,
    status: 'Offer Generated'
  };

  // attach to candidate record
  c.offer = offer;
  c.stage = 'Offer Generated';
  saveStore();
  cand_renderList();
  logActivity(`Offer generated for ${c.name} (Gross ₹${grossAnnual})`);

  // create a printable offer HTML node
  const node = document.createElement('div');
  node.style.width='800px'; node.style.padding='18px'; node.style.background='#fff'; node.style.color='#000';
  node.innerHTML = `
    <div style="display:flex;gap:12px;align-items:center;">
      <img src="logo.png" style="width:90px;height:90px;object-fit:contain" onerror="this.style.display='none'">
      <div>
        <div style="font-weight:900;font-size:20px">Konarak Food & Beverages</div>
        <div style="font-size:14px">Offer of Employment</div>
      </div>
    </div>
    <hr style="margin:10px 0;border:none;border-top:1px solid #ddd">
    <div style="margin-top:8px">
      <div>Date: ${new Date().toLocaleDateString()}</div>
      <div style="margin-top:12px">To, <strong>${escapeHtml(c.name)}</strong></div>
      <div style="margin-top:6px">Subject: Offer of employment for the role of <strong>${escapeHtml(c.position || 'Employee')}</strong></div>
      <div style="margin-top:12px">Dear ${escapeHtml(c.name)},</div>
      <div style="margin-top:8px">We are pleased to offer you the position of <strong>${escapeHtml(c.position || '')}</strong> at Konarak Food & Beverages. Below are the terms:</div>
      <div style="margin-top:10px">
        <strong>Compensation (Annual)</strong>
        <table style="width:100%;border-collapse:collapse;margin-top:6px;">
          <tr><td style="padding:6px;border:1px solid #eee">Basic (annual)</td><td style="padding:6px;border:1px solid #eee">₹${basicA.toLocaleString()}</td></tr>
          <tr><td style="padding:6px;border:1px solid #eee">HRA (annual)</td><td style="padding:6px;border:1px solid #eee">₹${hraA.toLocaleString()}</td></tr>
          <tr><td style="padding:6px;border:1px solid #eee">Conveyance (annual)</td><td style="padding:6px;border:1px solid #eee">₹${conveyA.toLocaleString()}</td></tr>
          <tr><td style="padding:6px;border:1px solid #eee">Special Allowance (annual)</td><td style="padding:6px;border:1px solid #eee">₹${specialA.toLocaleString()}</td></tr>
          <tr><td style="padding:6px;border:1px solid #eee">Variable / Bonus (annual)</td><td style="padding:6px;border:1px solid #eee">₹${bonusA.toLocaleString()}</td></tr>
          <tr><td style="padding:6px;border:1px solid #eee"><strong>Gross CTC (annual)</strong></td><td style="padding:6px;border:1px solid #eee"><strong>₹${grossAnnual.toLocaleString()}</strong></td></tr>
        </table>
      </div>
      <div style="margin-top:10px">
        <strong>Monthly Take-Home Estimate</strong>
        <div class="mini">Estimated monthly gross: ₹${monthlyGross.toLocaleString()} • Employee PF (monthly): ₹${employeePfDeductionMonthly.toLocaleString()} • Employer PF (monthly): ₹${employerPfMonthly.toLocaleString()}</div>
      </div>
      <div style="margin-top:10px">
        <strong>Employment Terms</strong>
        <ul>
          <li>Probation: ${probationMonths} month(s).</li>
          <li>Notice period: ${noticeMonths} month(s) after confirmation.</li>
          <li>Joining date: ${escapeHtml(offer.joiningDate)}</li>
          <li>Leaves, confidentiality, and code of conduct apply as per company policy.</li>
        </ul>
      </div>
      <div style="margin-top:10px">
        ${escapeHtml(notes || 'You are requested to acknowledge this offer by signing and returning a copy.')}
      </div>
      <div style="margin-top:20px">Sincerely,<br><strong>Konarak Food & Beverages</strong><br>HR Team</div>
      <div style="margin-top:20px;font-size:12px;color:#666">This offer is based on the information you have provided and is subject to verification of documents and references.</div>
    </div>
  `;

  document.body.appendChild(node);
  const canvas = await html2canvas(node, { scale: 2 });
  const img = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit: 'pt', format: 'a4' });
  const pageW = pdf.internal.pageSize.getWidth();
  const imgW = pageW - 40;
  pdf.addImage(img, 'PNG', 20, 20, imgW, 0);
  // attach offer PDF data URI to candidate.offer
  offer.pdf = pdf.output('datauristring');
  // mark offer saved
  c.offer = offer;
  c.stage = 'Offer Generated';
  saveStore();
  pdf.save(`Offer_${c.name.replace(/\s+/g,'_')}.pdf`);
  document.body.removeChild(node);
  cand_renderList();
  cand_showToast('Offer generated and saved');
}

/* --- view saved offer for candidate --- */
function cand_viewOffer(id){
  const c = cand_find(id);
  if(!c || !c.offer) return alert('No offer found');
  // open pdf in new window
  const w = window.open('');
  if(c.offer.pdf) w.document.write(`<iframe src="${c.offer.pdf}" style="width:100%;height:100vh;border:none"></iframe>`);
  else alert('Offer PDF not available');
}

/* --- mark offer sent or accepted manually --- */
function cand_sendOffer(id){
  const c = cand_find(id);
  if(!c || !c.offer) return alert('Offer not found');
  c.offer.status = 'Offer Sent';
  c.stage = 'Offer Generated';
  saveStore();
  cand_renderList();
  logActivity(`Offer sent to ${c.name}`);
  if(confirm('Mark offer as ACCEPTED now? (Choose OK to mark accepted)')) {
    c.offer.status = 'Offer Accepted';
    c.stage = 'Offer Accepted';
    saveStore();
    cand_renderList();
    logActivity(`Offer accepted by ${c.name}`);
    cand_showToast('Offer marked accepted');
  }
}

/* --- mark offer accepted (simulate candidate acceptance) --- */
function cand_markAccepted(id){
  const c = cand_find(id);
  if(!c || !c.offer) return alert('Offer not found');
  c.offer.status = 'Offer Accepted';
  c.stage = 'Offer Accepted';
  saveStore();
  cand_renderList();
  logActivity(`Offer accepted: ${c.name}`);
}

/* --- Hire candidate (only after offer accepted) --- */
function cand_hire(id){
  if(SESSION.role !== 'admin') return alert('Admin only');
  const c = cand_find(id);
  if(!c) return alert('Candidate not found');
  if(c.stage !== 'Offer Accepted') return alert('Candidate must accept offer before hiring');
  if(c.hired) return alert('Candidate already hired');
  // duplicate protection again
  if(cand_isDuplicate(c)) return alert('Candidate email/phone already exists in system (employee or candidate)');
  // create employee record automatically
  const now = new Date().toISOString();
  const empId = uid('emp');
  const code = 'EMP' + Math.floor(1000 + Math.random()*8999);
  const password = emp_generatePassword();
  const emp = {
    id: empId,
    fullname: c.name,
    code,
    email: c.email,
    phone: c.phone,
    department: c.position || '',
    designation: c.position || '',
    doj: c.offer && c.offer.joiningDate ? c.offer.joiningDate : now.slice(0,10),
    dob: '',
    type: 'Permanent',
    manager: '',
    basic: c.offer ? Math.round(c.offer.basicAnnual || 0 / 1) : Math.round((c.expectedSalary || 0)/12),
    hra: c.offer ? Math.round(c.offer.hraAnnual || 0) : 0,
    convey: c.offer ? Math.round(c.offer.conveyAnnual || 0) : 0,
    special: c.offer ? Math.round(c.offer.specialAnnual || 0) : 0,
    pf: 'yes',
    esi: 'no',
    aadhaar: '',
    pan: '',
    bank: '',
    account: '',
    ifsc: '',
    location: '',
    present_address: '',
    permanent_address: '',
    city: '',
    state: '',
    photo: null,
    docs: c.resume ? [{ id: uid('doc'), name: c.resume.name, data: c.resume.data, uploadedAt: new Date().toISOString() }] : [],
    createdAt: now,
    updatedAt: now,
    password
  };
  STORE.employees = STORE.employees || [];
  STORE.employees.push(emp);
  // mark candidate hired
  c.hired = true;
  c.stage = 'Hired';
  saveStore();
  cand_renderList();
  emp_renderList(); // refresh employee table
  logActivity(`Candidate hired: ${c.name} → employee ${code}`);
  cand_showToast(`Candidate hired. Employee code: ${code} • Password: ${password}`);
  // show employee modal
  emp_showMessage(`Employee created: ${emp.fullname} (Code: ${emp.code}) — Password: ${password}`);
}

/* --- edit candidate (open form prefilled) --- */
function cand_edit(id){
  if(SESSION.role !== 'admin') return alert('Admin required');
  const c = cand_find(id);
  if(!c) return alert('Candidate not found');
  cand_openForm(id);
  document.getElementById('c_name').value = c.name || '';
  document.getElementById('c_phone').value = c.phone || '';
  document.getElementById('c_email').value = c.email || '';
  document.getElementById('c_position').value = c.position || '';
  document.getElementById('c_source').value = c.source || '';
  document.getElementById('c_expected_salary').value = c.expectedSalary || '';
  document.getElementById('c_notes').value = c.notes || '';
  document.getElementById('candSaveBtn').dataset.edit = id;
}

/* --- export candidates to Excel --- */
function cand_exportExcel(){
  const rows = (STORE.candidates||[]).map(c => ({ Name: c.name, Email: c.email, Phone: c.phone, Position: c.position, Stage: c.stage, Expected: c.expectedSalary }));
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'Candidates');
  XLSX.writeFile(wb, 'Candidates.xlsx');
}

/* --- send offer (placeholder to simulate sending) --- */
function cand_sendOfferEmail(id){
  const c = cand_find(id);
  if(!c || !c.offer) return alert('Offer missing');
  c.offer.status = 'Offer Sent';
  c.stage = 'Offer Generated';
  saveStore();
  cand_renderList();
  logActivity(`Offer emailed to ${c.name}`);
  cand_showToast('Offer marked Sent (simulate email)');
}

/* --- expose functions globally --- */
window.cand_openForm = cand_openForm;
window.cand_cancel = cand_cancel;
window.cand_save = cand_save;
window.cand_renderList = cand_renderList;
window.cand_view = cand_view;
window.cand_edit = cand_edit;
window.cand_nextStagePrompt = cand_nextStagePrompt;
window.cand_reject = cand_reject;
window.cand_generateOfferModal = cand_generateOfferModal;
window.cand_generateOffer = cand_generateOffer;
window.cand_viewOffer = cand_viewOffer;
window.cand_sendOffer = cand_sendOffer;
window.cand_hire = cand_hire;
window.cand_exportExcel = cand_exportExcel;

/* --- initialize render --- */
(function cand_init(){ STORE.candidates = STORE.candidates || []; cand_renderList(); }());

/* ===========================
   END PART 3
   =========================== */

/* ===========================
   PART 4: Attendance Module
   - Local time only (no mandatory geo)
   - View: Calendar + Table
   - Late: after 09:15 (L2)
   - Daily required hours: 8
   - Auto-close dangling check-ins at 18:00 on page load
   =========================== */

(function(){
  // Configuration (based on your choices)
  const LATE_AFTER = { hour:9, minute:15 }; // L2
  const REQUIRED_HOURS = 8; // H8
  const AUTO_CHECKOUT_HOUR = 18; // 18:00 auto checkout
  const WEEKLY_OFF = [0]; // Sunday as weekly off (0=Sunday)

  // Internal state for this module
  let att_state = {
    view: 'calendar', // or 'table'
    curYear: new Date().getFullYear(),
    curMonth: new Date().getMonth() // 0-indexed
  };

  /* -------------------------
     Helper date/time utilities
     ------------------------- */
  function toDateKey(d){ // d: Date or ISO string or y-m-d
    const dt = (d instanceof Date) ? d : new Date(d);
    return dt.toISOString().slice(0,10); // YYYY-MM-DD
  }
  function nowTimeStr(){ const d=new Date(); return d.toTimeString().slice(0,8); } // HH:MM:SS
  function timeToMinutes(t){ // "HH:MM:SS" or "HH:MM"
    if(!t) return 0;
    const parts = t.split(':').map(Number);
    return parts[0]*60 + (parts[1]||0);
  }
  function minutesToHhMm(m){
    const h = Math.floor(m/60); const mm = m % 60;
    return `${h}:${mm.toString().padStart(2,'0')}`;
  }
  function computeHours(inT, outT){
    if(!inT || !outT) return 0;
    const mins = timeToMinutes(outT) - timeToMinutes(inT);
    return Math.max(0, Math.round((mins/60) * 100)/100); // hours with 2 decimals
  }

  /* -------------------------
     Store access helpers
     ------------------------- */
  function att_getRecordsForDate(dateKey){
    STORE.attendance = STORE.attendance || [];
    return STORE.attendance.filter(a=>a.date === dateKey);
  }
  function att_getRecord(employeeId, dateKey){
    STORE.attendance = STORE.attendance || [];
    return STORE.attendance.find(r=> r.employeeId === employeeId && r.date === dateKey);
  }
  function att_saveRecord(rec){
    STORE.attendance = STORE.attendance || [];
    const idx = STORE.attendance.findIndex(r=> r.id === rec.id);
    if(idx === -1) STORE.attendance.push(rec); else STORE.attendance[idx] = rec;
    saveStore();
  }

  /* -------------------------
     Auto-close dangling check-ins at 18:00 (run on init)
     ------------------------- */
  function att_autoCloseDangling(){
    const todayKey = toDateKey(new Date());
    const now = new Date();
    STORE.attendance = STORE.attendance || [];
    let changed = false;
    STORE.attendance.forEach(rec=>{
      // if no checkOut and same-day and checkIn exists and date <= today
      if(rec.checkIn && !rec.checkOut){
        const recDate = new Date(rec.date + 'T00:00:00');
        // auto close only for past dates or today after AUTO_CHECKOUT_HOUR
        const shouldClose = (toDateKey(recDate) < todayKey) || (toDateKey(recDate) === todayKey && now.getHours() >= AUTO_CHECKOUT_HOUR);
        if(shouldClose){
          rec.checkOut = `${AUTO_CHECKOUT_HOUR}:00:00`;
          rec.hours = computeHours(rec.checkIn, rec.checkOut);
          rec.overtime = Math.max(0, Math.round((rec.hours - REQUIRED_HOURS)*100)/100);
          rec.earlyExit = rec.hours < REQUIRED_HOURS;
          rec.late = timeToMinutes(rec.checkIn) > (LATE_AFTER.hour*60 + LATE_AFTER.minute);
          rec.updatedAt = new Date().toISOString();
          changed = true;
        }
      }
    });
    if(changed) { saveStore(); logActivity('Auto-checked out dangling attendance entries'); }
  }

  /* -------------------------
     UI wiring & rendering
     ------------------------- */
  function att_initUI(){
    // Show admin controls if admin
    const adminControls = document.getElementById('attendanceAdminControls');
    const empSelect = document.getElementById('attendanceEmpSelect');
    if(SESSION && SESSION.role === 'admin') {
      adminControls.style.display = 'block';
      // populate employees
      empSelect.innerHTML = '<option value="">-- Select Employee --</option>' + (STORE.employees||[]).map(e=>`<option value="${e.id}">${escapeHtml(e.fullname || e.email)} (${escapeHtml(e.code||'')})</option>`).join('');
      // default selection
      if(empSelect.options.length>1) empSelect.selectedIndex = 1;
    } else {
      adminControls.style.display = 'none';
    }
    // selected date default = today
    document.getElementById('attSelectedDate').value = new Date().toISOString().slice(0,10);
    // init month label
    att_state.curYear = new Date().getFullYear();
    att_state.curMonth = new Date().getMonth();
    att_renderAll();
  }

  function att_toggleView(){
    att_state.view = att_state.view === 'calendar' ? 'table' : 'calendar';
    document.getElementById('attCalendar').style.display = att_state.view === 'calendar' ? 'block' : 'none';
    document.getElementById('attTable').style.display = att_state.view === 'table' ? 'block' : 'none';
    att_renderAll();
  }

  /* Month navigation */
  function att_prevMonth(){ att_state.curMonth--; if(att_state.curMonth<0){ att_state.curMonth=11; att_state.curYear--; } att_renderCalendar(); }
  function att_nextMonth(){ att_state.curMonth++; if(att_state.curMonth>11){ att_state.curMonth=0; att_state.curYear++; } att_renderCalendar(); }

  /* Render both calendar + table */
  function att_renderAll(){
    emp_renderList && emp_renderList(); // refresh employee list if available
    att_renderCalendar();
    att_renderTable();
    // manage button state
    att_updateCheckButtons();
  }

  function att_updateCheckButtons(){
    // If employee logged in, show check-in/out buttons; else if admin, show manual functions
    const btnIn = document.getElementById('btnCheckIn');
    const btnOut = document.getElementById('btnCheckOut');
    if(SESSION && SESSION.role === 'employee'){
      btnIn.style.display = 'inline-block';
      btnOut.style.display = 'inline-block';
    } else if(SESSION && SESSION.role === 'admin'){
      // admin can choose employee in select
      btnIn.style.display = 'inline-block';
      btnOut.style.display = 'inline-block';
    } else {
      btnIn.style.display = 'none'; btnOut.style.display = 'none';
    }
  }

  /* Calendar rendering: simple month grid */
  function att_renderCalendar(){
    const grid = document.getElementById('attCalendarGrid');
    grid.innerHTML = '';
    const year = att_state.curYear;
    const month = att_state.curMonth;
    const first = new Date(year, month, 1);
    const startDay = first.getDay();
    const daysInMonth = new Date(year, month+1, 0).getDate();
    // header days
    const header = document.createElement('div');
    header.style.display='grid'; header.style.gridTemplateColumns='repeat(7,1fr)'; header.style.gap='6px';
    ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{ const h=document.createElement('div'); h.className='mini muted'; h.style.textAlign='center'; h.innerText=d; header.appendChild(h); });
    grid.appendChild(header);
    // cells
    const cells = document.createElement('div');
    cells.style.display='grid'; cells.style.gridTemplateColumns='repeat(7,1fr)'; cells.style.gap='8px'; cells.style.marginTop='8px';
    // blanks
    for(let i=0;i<startDay;i++){
      const blank=document.createElement('div'); blank.style.minHeight='70px'; blank.style.background='transparent'; cells.appendChild(blank);
    }
    for(let d=1; d<=daysInMonth; d++){
      const dt = new Date(year, month, d);
      const key = toDateKey(dt);
      const cell = document.createElement('div');
      cell.style.minHeight='70px'; cell.style.borderRadius='8px'; cell.style.padding='8px'; cell.style.background='var(--card)';
      // find attendance for date
      const recs = att_getRecordsForDate(key);
      // simple status priority: Hired employees present - we color if selected employee present
      const todayKey = new Date().toISOString().slice(0,10);
      const isToday = (key === todayKey);
      let cellInner = `<div style="display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:800">${d}</div><div class="mini muted">${new Date(year,month,d).toLocaleDateString(undefined,{weekday:'short'})}</div></div>`;
      // list present counts
      if(recs.length>0){
        // compute counts of present
        const presentCount = recs.filter(r=>r.checkIn).length;
        const lateCount = recs.filter(r=>r.late).length;
        cellInner += `<div class="mini" style="margin-top:6px">Present: ${presentCount}</div>`;
        if(lateCount) cellInner += `<div class="mini" style="color:var(--accent-strong)">Late: ${lateCount}</div>`;
      } else {
        // if weekend/holiday mark muted
        if(WEEKLY_OFF.includes(dt.getDay())) cellInner += `<div class="mini muted" style="margin-top:6px">Weekly off</div>`;
      }
      cell.innerHTML = cellInner;
      if(isToday){ cell.style.boxShadow = '0 6px 18px rgba(0,0,0,0.25)'; }
      cells.appendChild(cell);
    }
    grid.appendChild(cells);
    // month label
    const label = document.getElementById('attMonthLabel');
    const mname = new Date(year, month, 1).toLocaleString(undefined, { month: 'long', year: 'numeric' });
    label.innerText = mname;
  }

  /* Table rendering */
  function att_renderTable(){
    const tbody = document.getElementById('attTableBody');
    tbody.innerHTML = '';
    const selDate = document.getElementById('attSelectedDate').value || new Date().toISOString().slice(0,10);
    const records = (STORE.attendance||[]).filter(r=> r.date === selDate);
    // if admin and employee selected, filter by that employee
    const empSelect = document.getElementById('attendanceEmpSelect');
    const selectedEmp = empSelect && empSelect.value ? empSelect.value : null;
    const list = records.filter(r => !selectedEmp || r.employeeId === selectedEmp);
    // show for all employees if admin; for employee user show own
    let rows = list;
    // sort by time
    rows.sort((a,b)=> (a.checkIn||'') < (b.checkIn||'') ? -1 : 1);
    rows.forEach(r=>{
      const e = emp_find(r.employeeId) || { fullname: r.employeeName || '—', code: r.employeeCode || '' };
      tbody.insertAdjacentHTML('beforeend', `<tr>
        <td>${escapeHtml(r.date)}</td>
        <td>${escapeHtml(e.fullname || '')} ${escapeHtml(e.code||'')}</td>
        <td>${escapeHtml(r.checkIn || '-')}</td>
        <td>${escapeHtml(r.checkOut || '-')}</td>
        <td>${r.hours !== undefined ? Number(r.hours).toFixed(2) : '-'}</td>
        <td>${r.late ? 'Yes' : 'No'}</td>
        <td>${r.earlyExit ? 'Yes' : 'No'}</td>
        <td>${r.overtime || 0}</td>
        <td>${escapeHtml(r.note || '')}</td>
        <td>
          <button class="btn ghost" onclick="att_editRecord('${r.id}')">Edit</button>
        </td>
      </tr>`);
    });
  }

  /* -------------------------
     Check-in / Check-out functions (web)
     ------------------------- */
  function att_getActiveEmployeeForAction(){
    if(SESSION && SESSION.role === 'employee') return SESSION.user.id;
    if(SESSION && SESSION.role === 'admin'){
      const sel = document.getElementById('attendanceEmpSelect');
      if(sel && sel.value) return sel.value;
      return null;
    }
    return null;
  }

  function att_checkIn(){
    const empId = att_getActiveEmployeeForAction();
    if(!empId) return alert('Select employee (admin) or sign in as employee to check-in.');
    const dateKey = document.getElementById('attSelectedDate').value || new Date().toISOString().slice(0,10);
    let rec = att_getRecord(empId, dateKey);
    const timeNow = nowTimeStr();
    if(rec && rec.checkIn){
      return alert('Already checked in for this date.');
    }
    if(!rec){
      const e = emp_find(empId) || {};
      rec = {
        id: uid('att'),
        employeeId: empId,
        employeeName: e.fullname || e.email || '',
        employeeCode: e.code || '',
        date: dateKey,
        checkIn: timeNow,
        checkOut: null,
        hours: null,
        late: timeToMinutes(timeNow) > (LATE_AFTER.hour*60 + LATE_AFTER.minute),
        earlyExit: false,
        overtime: 0,
        note: '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
    } else {
      rec.checkIn = timeNow;
      rec.late = timeToMinutes(timeNow) > (LATE_AFTER.hour*60 + LATE_AFTER.minute);
      rec.updatedAt = new Date().toISOString();
    }
    att_saveRecord(rec);
    att_renderAll();
    logActivity(`Check-in: ${rec.employeeName} (${rec.employeeCode}) on ${rec.date} at ${rec.checkIn}`);
    alert(`Checked in at ${rec.checkIn}`);
  }

  function att_checkOut(){
    const empId = att_getActiveEmployeeForAction();
    if(!empId) return alert('Select employee (admin) or sign in as employee to check-out.');
    const dateKey = document.getElementById('attSelectedDate').value || new Date().toISOString().slice(0,10);
    let rec = att_getRecord(empId, dateKey);
    const timeNow = nowTimeStr();
    if(!rec || !rec.checkIn){
      return alert('No check-in found for today. If employee was present, admin can add manual entry.');
    }
    if(rec.checkOut){
      return alert('Already checked out for this date.');
    }
    rec.checkOut = timeNow;
    rec.hours = computeHours(rec.checkIn, rec.checkOut);
    rec.overtime = Math.max(0, Math.round((rec.hours - REQUIRED_HOURS)*100)/100);
    rec.earlyExit = rec.hours < REQUIRED_HOURS;
    rec.late = rec.late || (timeToMinutes(rec.checkIn) > (LATE_AFTER.hour*60 + LATE_AFTER.minute));
    rec.updatedAt = new Date().toISOString();
    att_saveRecord(rec);
    att_renderAll();
    logActivity(`Check-out: ${rec.employeeName} (${rec.employeeCode}) on ${rec.date} at ${rec.checkOut}`);
    alert(`Checked out at ${rec.checkOut} (Hours: ${rec.hours})`);
  }

  /* -------------------------
     Admin: edit record (modal)
     ------------------------- */
  function att_editRecord(id){
    if(SESSION.role !== 'admin') return alert('Admin only');
    const rec = (STORE.attendance||[]).find(r=>r.id===id);
    if(!rec) return alert('Record not found');
    // build modal
    const modal = document.createElement('div'); modal.className='modal-backdrop';
    modal.innerHTML = `<div class="modal" style="width:560px;max-width:94vw;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:900">Edit Attendance — ${escapeHtml(rec.employeeName || '')} (${escapeHtml(rec.employeeCode||'')})</div>
        <div><button class="btn ghost" id="attEditClose">Close</button></div>
      </div>
      <div style="margin-top:8px;">
        <div class="mini muted">Date</div>
        <input id="att_edit_date" type="date" class="field small" value="${escapeHtml(rec.date)}" />
        <div class="mini muted" style="margin-top:8px">Check In</div>
        <input id="att_edit_in" class="field small" value="${escapeHtml(rec.checkIn||'')}" placeholder="HH:MM:SS" />
        <div class="mini muted" style="margin-top:8px">Check Out</div>
        <input id="att_edit_out" class="field small" value="${escapeHtml(rec.checkOut||'')}" placeholder="HH:MM:SS" />
        <div class="mini muted" style="margin-top:8px">Note</div>
        <input id="att_edit_note" class="field small" value="${escapeHtml(rec.note||'')}" />
        <div style="display:flex;gap:8px;margin-top:10px;">
          <button class="btn primary" id="attEditSave">Save</button>
          <button class="btn ghost" id="attEditCancel">Cancel</button>
        </div>
      </div>
    </div>`;
    document.body.appendChild(modal);
    document.getElementById('attEditClose').addEventListener('click', ()=> modal.remove());
    document.getElementById('attEditCancel').addEventListener('click', ()=> modal.remove());
    document.getElementById('attEditSave').addEventListener('click', ()=>{
      const newDate = document.getElementById('att_edit_date').value;
      const newIn = document.getElementById('att_edit_in').value;
      const newOut = document.getElementById('att_edit_out').value;
      const note = document.getElementById('att_edit_note').value;
      rec.date = newDate;
      rec.checkIn = newIn || null;
      rec.checkOut = newOut || null;
      rec.hours = rec.checkIn && rec.checkOut ? computeHours(rec.checkIn, rec.checkOut) : (rec.checkIn && !rec.checkOut ? 0 : rec.hours);
      rec.late = rec.checkIn ? (timeToMinutes(rec.checkIn) > (LATE_AFTER.hour*60 + LATE_AFTER.minute)) : false;
      rec.earlyExit = rec.hours ? rec.hours < REQUIRED_HOURS : false;
      rec.overtime = rec.hours ? Math.max(0, Math.round((rec.hours - REQUIRED_HOURS)*100)/100) : 0;
      rec.note = note;
      rec.updatedAt = new Date().toISOString();
      saveStore();
      modal.remove();
      att_renderAll();
      logActivity(`Attendance record edited: ${rec.employeeName} (${rec.date})`);
      alert('Attendance updated');
    });
  }

  /* -------------------------
     Export functions (Excel & PDF)
     ------------------------- */
  function att_exportExcel(){
    const selDate = document.getElementById('attSelectedDate').value || new Date().toISOString().slice(0,10);
    const records = (STORE.attendance||[]).filter(r=> r.date === selDate);
    const rows = records.map(r => ({ Date: r.date, Employee: r.employeeName, Code: r.employeeCode, CheckIn: r.checkIn || '-', CheckOut: r.checkOut || '-', Hours: r.hours || 0, Late: r.late ? 'Yes' : 'No', EarlyExit: r.earlyExit ? 'Yes' : 'No', OT: r.overtime || 0 }));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, 'Attendance');
    XLSX.writeFile(wb, `Attendance_${selDate}.xlsx`);
  }

  async function att_exportPdf(){
    // build printable table for selected date
    const selDate = document.getElementById('attSelectedDate').value || new Date().toISOString().slice(0,10);
    const rows = (STORE.attendance||[]).filter(r=> r.date === selDate);
    const node = document.createElement('div');
    node.style.width='800px'; node.style.padding='18px'; node.style.background='#fff'; node.style.color='#000';
    node.innerHTML = `<div style="font-weight:900;font-size:18px">Konarak Food & Beverages — Attendance ${selDate}</div><div style="margin-top:8px">Generated: ${new Date().toLocaleString()}</div>`;
    let html = `<table style="width:100%;border-collapse:collapse;margin-top:8px;"><thead><tr><th style="border:1px solid #ddd;padding:6px">Employee</th><th style="border:1px solid #ddd;padding:6px">Check In</th><th style="border:1px solid #ddd;padding:6px">Check Out</th><th style="border:1px solid #ddd;padding:6px">Hours</th><th style="border:1px solid #ddd;padding:6px">Late</th><th style="border:1px solid #ddd;padding:6px">OT</th></tr></thead><tbody>`;
    rows.forEach(r => { html += `<tr><td style="border:1px solid #eee;padding:6px">${escapeHtml(r.employeeName)}</td><td style="border:1px solid #eee;padding:6px">${escapeHtml(r.checkIn||'-')}</td><td style="border:1px solid #eee;padding:6px">${escapeHtml(r.checkOut||'-')}</td><td style="border:1px solid #eee;padding:6px">${r.hours||0}</td><td style="border:1px solid #eee;padding:6px">${r.late? 'Yes':'No'}</td><td style="border:1px solid #eee;padding:6px">${r.overtime||0}</td></tr>`; });
    html += `</tbody></table>`;
    node.innerHTML += html;
    document.body.appendChild(node);
    const canvas = await html2canvas(node, { scale: 2 });
    const img = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit: 'pt', format: 'a4' });
    const pageW = pdf.internal.pageSize.getWidth();
    const imgW = pageW - 40;
    pdf.addImage(img, 'PNG', 20, 20, imgW, 0);
    pdf.save(`Attendance_${selDate}.pdf`);
    document.body.removeChild(node);
  }

  /* -------------------------
     Initialization & hooks
     ------------------------- */
  // auto-close dangling entries once
  att_autoCloseDangling();

  // expose functions globally used by HTML
  window.att_toggleView = att_toggleView;
  window.att_prevMonth = att_prevMonth;
  window.att_nextMonth = att_nextMonth;
  window.att_checkIn = att_checkIn;
  window.att_checkOut = att_checkOut;
  window.att_renderAll = att_renderAll;
  window.att_exportExcel = att_exportExcel;
  window.att_exportPdf = att_exportPdf;
  window.att_editRecord = att_editRecord;

  // initialize UI when Attendance view opened by route
  const origRoute = route;
  // wrap route to hook attendance view display (safe: route is defined in Part1)
  route = function(v){
    origRoute(v);
    try{
      if(v === 'attendance'){
        att_initUI();
      }
    }catch(e){ console.error('att route err', e); }
  };

  // If already on attendance view, init now
  if(document.getElementById('attendanceView').style.display !== 'none'){
    att_initUI();
  }

}());
/* ===========================
   END PART 4
   =========================== */
/* ===========================
   PART 5: Leave Management Module
   - Leave types, apply, approve, balances
   - Integrates with STORE.leaves and Attendance (STORE.attendance)
   - Requires: STORE, saveStore(), uid(), emp_find(), logActivity(), escapeHtml()
   =========================== */

(function(){
  // Default leave types (editable)
  const DEFAULT_TYPES = [
    { id: 'annual', name: 'Annual Leave', entitlement: 18, carryForward: true },
    { id: 'sick', name: 'Sick Leave', entitlement: 12, carryForward: false },
    { id: 'casual', name: 'Casual Leave', entitlement: 8, carryForward: false },
    { id: 'unpaid', name: 'Unpaid Leave', entitlement: 0, carryForward: false }
  ];

  // Initialize types in STORE if not present
  if(!STORE.leaveTypes || !Array.isArray(STORE.leaveTypes) || STORE.leaveTypes.length === 0) {
    STORE.leaveTypes = JSON.parse(JSON.stringify(DEFAULT_TYPES));
    saveStore();
  }

  /* -------------------------
     Utility helpers
     ------------------------- */
  function leave_daysBetween(fromDate, toDate){
    const f = new Date(fromDate + 'T00:00:00');
    const t = new Date(toDate + 'T00:00:00');
    const ms = t - f;
    return Math.round(ms / (1000*60*60*24)) + 1;
  }

  function leave_getType(id){ return (STORE.leaveTypes||[]).find(x=>x.id===id) || null; }

  /* -------------------------
     Apply leave (employee) modal
     ------------------------- */
  function leave_openApply(){
    if(!SESSION || !SESSION.user) return alert('Sign in to apply for leave');
    const modal = document.createElement('div'); modal.className='modal-backdrop';
    // build types options
    const typesHtml = (STORE.leaveTypes||[]).map(t=>`<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`).join('');
    modal.innerHTML = `<div class="modal" style="width:640px;max-width:96vw;">
      <div style="display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:900">Apply Leave</div><div><button class="btn ghost" id="leaveApplyClose">Close</button></div></div>
      <div style="margin-top:8px;">
        <div class="mini muted">Employee: ${escapeHtml(SESSION.user.fullname || SESSION.user.email)}</div>
        <div style="margin-top:8px"><select id="leave_type_sel" class="field small">${typesHtml}</select></div>
        <div style="margin-top:8px" class="row"><div class="col"><input id="leave_from" type="date" class="field small"></div><div class="col"><input id="leave_to" type="date" class="field small"></div></div>
        <div style="margin-top:8px"><input id="leave_reason" class="field small" placeholder="Reason / Notes"></div>
        <div style="display:flex;gap:8px;margin-top:10px;"><button class="btn primary" id="leaveApplySave">Apply</button><button class="btn ghost" id="leaveApplyCancel">Cancel</button></div>
      </div>
    </div>`;
    document.body.appendChild(modal);
    document.getElementById('leaveApplyClose').addEventListener('click', ()=> modal.remove());
    document.getElementById('leaveApplyCancel').addEventListener('click', ()=> modal.remove());
    document.getElementById('leaveApplySave').addEventListener('click', ()=>{
      const type = document.getElementById('leave_type_sel').value;
      const from = document.getElementById('leave_from').value;
      const to = document.getElementById('leave_to').value;
      const reason = document.getElementById('leave_reason').value || '';
      if(!type || !from || !to) return alert('Please select type and dates');
      if(new Date(to) < new Date(from)) return alert('To date cannot be before From date');
      // compute days
      const days = leave_daysBetween(from,to);
      const rec = {
        id: uid('leave'),
        employeeId: SESSION.user.id,
        employeeName: SESSION.user.fullname || SESSION.user.email,
        type,
        from,
        to,
        days,
        reason,
        status: 'Pending',
        appliedAt: new Date().toISOString(),
        decidedAt: null,
        decidedBy: null
      };
      STORE.leaves = STORE.leaves || [];
      STORE.leaves.push(rec);
      saveStore();
      modal.remove();
      leave_renderList();
      logActivity(`Leave applied by ${rec.employeeName}: ${rec.type} ${rec.from}→${rec.to} (${rec.days})`);
      alert('Leave applied successfully (Pending approval)');
    });
  }

  /* -------------------------
     Leave type manager modal (admin)
     ------------------------- */
  function leave_openTypeManager(){
    if(!SESSION || SESSION.role !== 'admin') return alert('Admin only');
    const modal = document.createElement('div'); modal.className='modal-backdrop';
    const types = STORE.leaveTypes || [];
    const rows = types.map(t=>`<div style="display:flex;gap:8px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.02)"><input value="${escapeHtml(t.id)}" readonly class="field small" style="width:140px"/><input value="${escapeHtml(t.name)}" class="field small type_name" data-id="${escapeHtml(t.id)}"/><input value="${escapeHtml(t.entitlement)}" class="field small type_ent" data-id="${escapeHtml(t.id)}"/><button class="btn ghost" onclick="leave_deleteType('${escapeHtml(t.id)}')">Delete</button></div>`).join('');
    modal.innerHTML = `<div class="modal" style="width:760px;max-width:96vw;">
      <div style="display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:900">Leave Types</div><div><button class="btn ghost" id="leaveTypesClose">Close</button></div></div>
      <div style="margin-top:8px;">
        <div style="font-weight:800">Existing Types</div>
        <div style="margin-top:6px">${rows}</div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;">
          <input id="new_type_id" placeholder="id (e.g., comp-off)" class="field small" />
          <input id="new_type_name" placeholder="Type name" class="field small" />
          <input id="new_type_ent" type="number" placeholder="Entitlement (days/year)" class="field small" />
          <button class="btn primary" id="newTypeAdd">Add</button>
        </div>
        <div style="margin-top:8px"><button class="btn ghost" id="saveTypeChanges">Save Changes</button></div>
      </div>
    </div>`;
    document.body.appendChild(modal);
    document.getElementById('leaveTypesClose').addEventListener('click', ()=> modal.remove());
    document.getElementById('newTypeAdd').addEventListener('click', ()=>{
      const id = (document.getElementById('new_type_id').value || '').trim();
      const name = (document.getElementById('new_type_name').value || '').trim();
      const ent = Number(document.getElementById('new_type_ent').value || 0);
      if(!id || !name) return alert('Provide id and name');
      if((STORE.leaveTypes||[]).find(x=>x.id===id)) return alert('Type id already exists');
      STORE.leaveTypes.push({ id, name, entitlement: ent, carryForward: false });
      saveStore();
      modal.remove();
      leave_openTypeManager(); // reopen to refresh
    });
    document.getElementById('saveTypeChanges').addEventListener('click', ()=>{
      // capture modified names/entitlements
      const names = modal.querySelectorAll('.type_name');
      const ents = modal.querySelectorAll('.type_ent');
      names.forEach(n => {
        const id = n.dataset.id;
        const t = STORE.leaveTypes.find(x=>x.id===id);
        if(t) t.name = n.value;
      });
      ents.forEach(en => {
        const id = en.dataset.id;
        const t = STORE.leaveTypes.find(x=>x.id===id);
        if(t) t.entitlement = Number(en.value||0);
      });
      saveStore();
      alert('Leave types updated');
      modal.remove();
    });
  }

  function leave_deleteType(id){
    if(!confirm('Delete leave type? Existing leaves will keep the type text.')) return;
    STORE.leaveTypes = (STORE.leaveTypes||[]).filter(x=>x.id !== id);
    saveStore();
    logActivity(`Leave type deleted: ${id}`);
    leave_openTypeManager();
  }

  /* -------------------------
     Render leave list
     ------------------------- */
  function leave_renderList(){
    const tbody = document.getElementById('leaveTableBody');
    if(!tbody) return;
    tbody.innerHTML = '';
    const q = (document.getElementById('leaveSearch').value || '').trim().toLowerCase();
    const statusFilter = (document.getElementById('leaveFilterStatus').value || '');
    const typeFilter = (document.getElementById('leaveFilterType').value || '');
    let list = (STORE.leaves || []).slice().reverse();
    // if employee role, show only own
    if(SESSION && SESSION.role === 'employee') list = list.filter(l => l.employeeId === SESSION.user.id);
    if(q) list = list.filter(l => (l.employeeName||'').toLowerCase().includes(q) || (l.reason||'').toLowerCase().includes(q));
    if(statusFilter) list = list.filter(l => l.status === statusFilter);
    if(typeFilter) list = list.filter(l => l.type === typeFilter);
    list.forEach(l=>{
      const typeName = (leave_getType(l.type) || {}).name || l.type || '';
      tbody.insertAdjacentHTML('beforeend', `<tr>
        <td>${escapeHtml(l.employeeName)}</td>
        <td>${escapeHtml(typeName)}</td>
        <td>${escapeHtml(l.from)}</td>
        <td>${escapeHtml(l.to)}</td>
        <td>${escapeHtml(String(l.days))}</td>
        <td>${escapeHtml(l.status)}</td>
        <td>${new Date(l.appliedAt).toLocaleDateString()}</td>
        <td>
          ${l.status === 'Pending' && SESSION && SESSION.role === 'admin' ? `<button class="btn primary" onclick="leave_approve('${l.id}')">Approve</button><button class="btn ghost" onclick="leave_reject('${l.id}')">Reject</button>` : ''}
          ${l.status === 'Approved' && SESSION && SESSION.role === 'admin' ? `<button class="btn ghost" onclick="leave_cancelApproval('${l.id}')">Cancel Approval</button>` : ''}
          ${SESSION && l.employeeId === (SESSION.user && SESSION.user.id) && l.status === 'Pending' ? `<button class="btn ghost" onclick="leave_withdraw('${l.id}')">Withdraw</button>` : ''}
        </td>
      </tr>`);
    });
    document.getElementById('leaveTotal').innerText = (STORE.leaves||[]).length;
    // update filters types
    const typeSel = document.getElementById('leaveFilterType');
    typeSel.innerHTML = '<option value="">All Types</option>' + (STORE.leaveTypes||[]).map(t=>`<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`).join('');
    // update pending count
    const pending = (STORE.leaves||[]).filter(l=> l.status === 'Pending').length;
    document.getElementById('leavePendingCount').innerText = pending;
    // update balances summary
    leave_renderBalanceSummary();
  }

  /* -------------------------
     Approve / Reject / Withdraw / Cancel approval
     ------------------------- */
  function leave_approve(id){
    if(!SESSION || SESSION.role !== 'admin') return alert('Admin only');
    const l = (STORE.leaves||[]).find(x=>x.id===id);
    if(!l) return alert('Leave not found');
    if(l.status !== 'Pending') return alert('Only pending leaves can be approved');
    // deduct from balances if entitlement exists
    const type = leave_getType(l.type);
    // compute days
    const days = l.days || leave_daysBetween(l.from, l.to);
    // update record
    l.status = 'Approved';
    l.decidedAt = new Date().toISOString();
    l.decidedBy = SESSION.user.email || SESSION.user.name || 'admin';
    saveStore();
    // write to attendance: mark those dates as leave so calendar shows yellow
    for(let d=0; d<days; d++){
      const date = new Date(l.from); date.setDate(date.getDate() + d);
      const key = date.toISOString().slice(0,10);
      // create attendance record for this employee/date marked as leave
      const rec = att_getRecord ? att_getRecord(l.employeeId, key) : null;
      if(rec){
        rec.note = (rec.note || '') + ' Leave approved';
        rec.leaveType = l.type;
        rec.status = 'Leave';
        rec.updatedAt = new Date().toISOString();
        att_saveRecord(rec);
      } else {
        const newRec = {
          id: uid('att'),
          employeeId: l.employeeId,
          employeeName: l.employeeName,
          employeeCode: (emp_find(l.employeeId) || {}).code || '',
          date: key,
          checkIn: null, checkOut: null, hours: 0, late:false, earlyExit:false, overtime:0,
          note: 'Leave approved',
          leaveType: l.type,
          status: 'Leave',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        STORE.attendance = STORE.attendance || [];
        STORE.attendance.push(newRec);
      }
    }
    saveStore();
    leave_renderList();
    att_renderAll && att_renderAll();
    logActivity(`Leave approved: ${l.employeeName} ${l.from}→${l.to} (${l.days}) by ${SESSION.user.email||SESSION.user.name}`);
    alert('Leave approved');
  }

  function leave_reject(id){
    if(!SESSION || SESSION.role !== 'admin') return alert('Admin only');
    const l = (STORE.leaves||[]).find(x=>x.id===id);
    if(!l) return alert('Leave not found');
    l.status = 'Rejected';
    l.decidedAt = new Date().toISOString();
    l.decidedBy = SESSION.user.email || SESSION.user.name || 'admin';
    saveStore();
    leave_renderList();
    logActivity(`Leave rejected: ${l.employeeName} ${l.from}→${l.to}`);
    alert('Leave rejected');
  }

  function leave_withdraw(id){
    // employee withdraw pending leave
    if(!SESSION || !SESSION.user) return alert('Sign in');
    const l = (STORE.leaves||[]).find(x=>x.id===id);
    if(!l) return alert('Leave not found');
    if(l.employeeId !== SESSION.user.id) return alert('Not allowed');
    if(l.status !== 'Pending') return alert('Only pending leaves can be withdrawn');
    l.status = 'Cancelled';
    l.decidedAt = new Date().toISOString();
    saveStore();
    leave_renderList();
    logActivity(`Leave withdrawn by ${SESSION.user.email || SESSION.user.fullname}`);
    alert('Leave withdrawn');
  }

  function leave_cancelApproval(id){
    if(!SESSION || SESSION.role !== 'admin') return alert('Admin only');
    const l = (STORE.leaves||[]).find(x=>x.id===id);
    if(!l) return alert('Leave not found');
    if(l.status !== 'Approved') return alert('Only approved leaves can be cancelled here');
    // remove leave marks from attendance for the date range
    const days = l.days || leave_daysBetween(l.from, l.to);
    for(let d=0; d<days; d++){
      const date = new Date(l.from); date.setDate(date.getDate() + d);
      const key = date.toISOString().slice(0,10);
      STORE.attendance = (STORE.attendance||[]).filter(r => !(r.employeeId === l.employeeId && r.date === key && r.status === 'Leave'));
    }
    l.status = 'Cancelled';
    l.decidedAt = new Date().toISOString();
    saveStore();
    leave_renderList();
    att_renderAll && att_renderAll();
    logActivity(`Leave approval cancelled: ${l.employeeName} ${l.from}→${l.to}`);
    alert('Leave approval cancelled and attendance adjusted');
  }

  /* -------------------------
     Leave balances summary & quick view
     ------------------------- */
  function leave_renderBalanceSummary(){
    const summaryEl = document.getElementById('leaveBalanceSummary');
    if(!summaryEl) return;
    // If employee, show only their balances
    if(SESSION && SESSION.role === 'employee'){
      const empId = SESSION.user.id;
      const entitlements = (STORE.leaveTypes||[]).map(t => {
        // compute used days for this employee and type for current year
        const year = new Date().getFullYear();
        const used = (STORE.leaves||[]).filter(l => l.employeeId === empId && l.type === t.id && l.status === 'Approved' && new Date(l.from).getFullYear() === year).reduce((s,x)=>s + (x.days||0), 0);
        const balance = t.entitlement - used;
        return `<div class="mini">${escapeHtml(t.name)}: <strong>${balance}</strong> / ${t.entitlement}</div>`;
      }).join('');
      summaryEl.innerHTML = entitlements;
    } else {
      // admin/company view summary: total leaves by type (year)
      const counts = (STORE.leaveTypes||[]).map(t => {
        const used = (STORE.leaves||[]).filter(l=> l.type === t.id && l.status === 'Approved').reduce((s,x)=>s + (x.days||0),0);
        return `<div class="mini">${escapeHtml(t.name)} used: <strong>${used}</strong> days</div>`;
      }).join('');
      summaryEl.innerHTML = counts;
    }
  }

  /* -------------------------
     Export leave register to Excel
     ------------------------- */
  function leave_exportExcel(){
    const rows = (STORE.leaves||[]).map(l => ({ Employee: l.employeeName, Type: (leave_getType(l.type)||{}).name || l.type, From: l.from, To: l.to, Days: l.days, Status: l.status, Applied: l.appliedAt }));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, 'Leaves');
    XLSX.writeFile(wb, 'LeaveRegister.xlsx');
  }

  /* -------------------------
     Init and renders
     ------------------------- */
  function leave_init(){
    // ensure arrays
    STORE.leaves = STORE.leaves || [];
    // populate filter type select
    const sel = document.getElementById('leaveFilterType');
    if(sel) sel.innerHTML = '<option value="">All Types</option>' + (STORE.leaveTypes || []).map(t => `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`).join('');
    leave_renderList();
  }

  // expose global functions
  window.leave_openApply = leave_openApply;
  window.leave_openTypeManager = leave_openTypeManager;
  window.leave_renderList = leave_renderList;
  window.leave_approve = leave_approve;
  window.leave_reject = leave_reject;
  window.leave_withdraw = leave_withdraw;
  window.leave_cancelApproval = leave_cancelApproval;
  window.leave_exportExcel = leave_exportExcel;

  // hook into route to initialize when view opened
  const prevRouteLeave = route;
  route = function(v){
    prevRouteLeave(v);
    try{
      if(v === 'leave') leave_init();
    }catch(e){ console.error('leave route err', e); }
  };

  // initial call if on leave view
  if(document.getElementById('leaveView').style.display !== 'none'){
    leave_init();
  }

}());
/* ===========================
   END PART 5
   =========================== */

/* ===========================
   PART 6: Payroll & Payslip Engine
   Rules chosen:
     - OT Rate: none (D)
     - PF: optional per-employee (PF2) -> employee.pf === 'yes'
     - ESI: apply if gross < 21000 (ESI1)
     - Payslip format: Premium (P3)
   Dependencies: STORE, saveStore(), uid(), emp_find(), logActivity(), escapeHtml(), html2canvas, jspdf, XLSX
   =========================== */

(function(){
  // Configuration constants
  const ESI_THRESHOLD = 21000; // gross < threshold -> ESI applicable
  const EMPLOYEE_PF_PERCENT = 0.12; // 12% employee PF if applicable
  const EMPLOYER_PF_PERCENT = 0.12; // employer contribution
  const ESI_EMP_PERCENT = 0.0075; // 0.75%
  const ESI_EMPLOYER_PERCENT = 0.0325; // 3.25%
  const DAYS_IN_MONTH = 30; // payroll day basis
  const OT_MULTIPLIER = 0; // OT disabled (D)

  /* utility: format currency */
  function fmt(v){ return '₹' + Number(v || 0).toFixed(2); }

  /* payroll: compute for a single employee and month */
  function pay_computeForEmployee(employee, monthYYYYMM){
    // monthYYYYMM like '2025-12'
    const empId = employee.id;
    // gather salary components from employee record
    const basic = Number(employee.basic || 0);
    const hra = Number(employee.hra || 0);
    const convey = Number(employee.convey || 0);
    const special = Number(employee.special || 0);
    const bonus = Number(employee.bonus || 0);
    const grossMonthly = basic + hra + convey + special + (bonus ? (bonus/12) : 0);

    // attendance summary for that month -> compute presents, approved leaves, absent (LWP)
    const monthStart = new Date(monthYYYYMM + '-01');
    const month = monthStart.getMonth();
    const year = monthStart.getFullYear();
    const daysInMonth = new Date(year, month+1, 0).getDate();

    const attendanceRecords = (STORE.attendance||[]).filter(r=>{
      if(r.employeeId !== empId) return false;
      const d = new Date(r.date + 'T00:00:00');
      return d.getMonth() === month && d.getFullYear() === year;
    });

    // count presents: records with checkIn and (checkOut or hours>0) and not status 'Leave'
    let presentDays = 0;
    let approvedLeaveDays = 0;
    let absentDays = 0;
    for(let d=1; d<=daysInMonth; d++){
      const key = new Date(year, month, d).toISOString().slice(0,10);
      const rec = attendanceRecords.find(r=> r.date === key);
      if(rec){
        if(rec.status === 'Leave' || rec.leaveType) approvedLeaveDays++;
        else if(rec.checkIn) presentDays++;
        else absentDays++;
      } else {
        // no record => absent
        absentDays++;
      }
    }

    // leaves from STORE.leaves approved in that month for this emp
    const leaves = (STORE.leaves||[]).filter(l => l.employeeId === empId && l.status === 'Approved');
    let leavesInMonth = 0;
    leaves.forEach(l=>{
      const from = new Date(l.from + 'T00:00:00');
      const to = new Date(l.to + 'T00:00:00');
      // iterate overlap with month
      for(let dt = new Date(from); dt <= to; dt.setDate(dt.getDate()+1)){
        if(dt.getFullYear() === year && dt.getMonth() === month) leavesInMonth++;
      }
    });

    // LWP (loss of pay) days = absentDays - approvedLeaveDays (cannot be negative)
    const lwpDays = Math.max(0, absentDays - leavesInMonth);

    // Salary per day based on grossMonthly
    const perDay = grossMonthly / DAYS_IN_MONTH;
    const lopDeduction = perDay * lwpDays;

    // PF deduction if employee.pf === 'yes' per PF2
    const pfEmployee = (employee.pf === 'yes') ? Math.round(basic * EMPLOYEE_PF_PERCENT) : 0;
    const pfEmployer = (employee.pf === 'yes') ? Math.round(basic * EMPLOYER_PF_PERCENT) : 0;

    // ESI applicable if grossMonthly < ESI_THRESHOLD
    const esiEmployee = (grossMonthly < ESI_THRESHOLD) ? Math.round(grossMonthly * ESI_EMP_PERCENT) : 0;
    const esiEmployer = (grossMonthly < ESI_THRESHOLD) ? Math.round(grossMonthly * ESI_EMPLOYER_PERCENT) : 0;

    // Income tax (not implemented) → 0 by default
    const incomeTax = 0;

    // OT is disabled (per your choice D) → 0
    const overtimePay = 0;

    // Total earnings and deductions
    const gross = grossMonthly + overtimePay;
    const totalDeductions = Number(lopDeduction) + Number(pfEmployee) + Number(esiEmployee) + Number(incomeTax);
    const net = Math.round((gross - totalDeductions) * 100) / 100;

    // payroll record
    const rec = {
      id: uid('payrec'),
      employeeId: empId,
      employeeCode: employee.code || '',
      employeeName: employee.fullname || '',
      month: monthYYYYMM,
      year,
      monthIndex: month,
      basic, hra, convey, special, bonusMonthly: (bonus ? (bonus/12) : 0),
      grossMonthly,
      presentDays,
      approvedLeaveDays: leavesInMonth,
      absentDays,
      lwpDays,
      lopDeduction,
      pfEmployee,
      pfEmployer,
      esiEmployee,
      esiEmployer,
      incomeTax,
      overtimePay,
      gross,
      totalDeductions,
      net,
      generatedAt: new Date().toISOString()
    };
    return rec;
  }

  /* Run payroll for either a single employee or all employees for a given month */
  function pay_run(monthYYYYMM, employeeId){
    if(!SESSION || SESSION.role !== 'admin') return alert('Admin only');
    if(!monthYYYYMM) return alert('Select month');
    STORE.payroll = STORE.payroll || [];
    const targets = employeeId ? (STORE.employees||[]).filter(e=>e.id===employeeId) : (STORE.employees||[]);

    if(targets.length === 0) return alert('No employees to process');

    // remove existing payroll records for that month for the selected employees (to allow re-run)
    STORE.payroll = (STORE.payroll||[]).filter(p => !(p.month === monthYYYYMM && (!employeeId || targets.find(t=>t.id===p.employeeId))));
    const created = [];
    targets.forEach(emp=>{
      const rec = pay_computeForEmployee(emp, monthYYYYMM);
      STORE.payroll.push(rec);
      created.push(rec);
      logActivity(`Payroll generated for ${rec.employeeName} (${rec.month})`);
    });
    saveStore();
    pay_renderRegister();
    alert(`Payroll run complete for ${targets.length} employee(s).`);
    return created;
  }

  /* UI helpers: open payroll run modal */
  function pay_openPayrollRun(){
    if(!SESSION || SESSION.role !== 'admin') return alert('Admin only');
    const modal = document.createElement('div'); modal.className='modal-backdrop';
    // employee options
    const empOptions = '<option value="">All Employees</option>' + (STORE.employees||[]).map(e => `<option value="${e.id}">${escapeHtml(e.fullname)} (${escapeHtml(e.code||'')})</option>`).join('');
    modal.innerHTML = `<div class="modal" style="width:680px;max-width:96vw;">
      <div style="display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:900">Run Payroll</div><div><button class="btn ghost" id="payRunClose">Close</button></div></div>
      <div style="margin-top:8px;">
        <div class="mini muted">Employee (leave empty for all)</div>
        <select id="payrun_emp" class="field small">${empOptions}</select>
        <div style="margin-top:8px" class="mini muted">Month</div>
        <input id="payrun_month" type="month" class="field small" value="${new Date().toISOString().slice(0,7)}" />
        <div style="display:flex;gap:8px;margin-top:10px;">
          <button class="btn primary" id="payRunStart">Start Payroll</button>
          <button class="btn ghost" id="payRunCancel">Cancel</button>
        </div>
      </div>
    </div>`;
    document.body.appendChild(modal);
    document.getElementById('payRunClose').addEventListener('click', ()=> modal.remove());
    document.getElementById('payRunCancel').addEventListener('click', ()=> modal.remove());
    document.getElementById('payRunStart').addEventListener('click', ()=>{
      const empId = document.getElementById('payrun_emp').value || null;
      const month = document.getElementById('payrun_month').value;
      if(!month) return alert('Pick a month');
      pay_run(month, empId);
      modal.remove();
    });
  }

  /* Render payroll register table */
  function pay_renderRegister(){
    const tbody = document.getElementById('payrollTableBody');
    tbody.innerHTML = '';
    STORE.payroll = STORE.payroll || [];
    const filterEmp = document.getElementById('pay_filter_emp');
    // populate employee filter
    if(filterEmp){
      filterEmp.innerHTML = '<option value="">All Employees</option>' + (STORE.employees||[]).map(e=>`<option value="${e.id}">${escapeHtml(e.fullname)} (${escapeHtml(e.code||'')})</option>`).join('');
    }
    const selEmp = document.getElementById('pay_filter_emp').value || '';
    const selMonth = document.getElementById('pay_filter_month').value || '';
    let list = (STORE.payroll||[]).slice().reverse();
    if(selEmp) list = list.filter(p=> p.employeeId === selEmp);
    if(selMonth) list = list.filter(p=> p.month === selMonth);
    list.forEach(p=>{
      tbody.insertAdjacentHTML('beforeend', `<tr>
        <td>${escapeHtml(p.month)}</td>
        <td>${escapeHtml(p.employeeName)} (${escapeHtml(p.employeeCode)})</td>
        <td>${fmt(p.gross)}</td>
        <td>${fmt(p.totalDeductions)}</td>
        <td>${fmt(p.net)}</td>
        <td>
          <button class="btn ghost" onclick="pay_viewPayslip('${p.id}')">View Payslip</button>
          <button class="btn ghost" onclick="pay_downloadRecord('${p.id}')">Download JSON</button>
        </td>
      </tr>`);
    });
    document.getElementById('payTotal').innerText = (STORE.payroll||[]).length;
  }

  /* Download payroll record JSON */
  function pay_downloadRecord(id){
    const p = (STORE.payroll||[]).find(x=>x.id===id);
    if(!p) return alert('Record not found');
    const a = document.createElement('a');
    a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(p,null,2));
    a.download = `Payroll_${p.employeeCode}_${p.month}.json`;
    a.click();
  }

  /* Generate payslip PDF (P3 premium) for a payroll record id */
  async function pay_viewPayslip(payrecId){
    const pr = (STORE.payroll||[]).find(x=>x.id===payrecId);
    if(!pr) return alert('Payroll record not found');
    const emp = emp_find(pr.employeeId) || {};
    // build payslip node (premium layout)
    const node = document.createElement('div');
    node.style.width = '820px';
    node.style.padding = '18px';
    node.style.background = '#fff';
    node.style.color = '#000';
    node.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="display:flex;gap:12px;align-items:center;">
          <img src="logo.png" style="width:90px;height:90px;object-fit:contain" onerror="this.style.display='none'">
          <div>
            <div style="font-weight:900;font-size:20px">Konarak Food & Beverages</div>
            <div style="font-size:13px;color:#666">Payslip for ${escapeHtml(pr.month)}</div>
          </div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:800">${escapeHtml(pr.employeeName)}</div>
          <div class="mini">${escapeHtml(pr.employeeCode)} • ${escapeHtml(emp.department || '')}</div>
          <div class="mini">Pay Date: ${new Date(pr.generatedAt).toLocaleDateString()}</div>
        </div>
      </div>
      <hr style="margin:12px 0;border:none;border-top:1px solid #ddd" />
      <div style="display:flex;gap:12px;">
        <div style="flex:1;">
          <div style="font-weight:800;margin-bottom:6px">Earnings (Monthly)</div>
          <table style="width:100%;border-collapse:collapse;">
            <tr><td style="padding:6px;border:1px solid #eee">Basic</td><td style="padding:6px;border:1px solid #eee">${fmt(pr.basic)}</td></tr>
            <tr><td style="padding:6px;border:1px solid #eee">HRA</td><td style="padding:6px;border:1px solid #eee">${fmt(pr.hra)}</td></tr>
            <tr><td style="padding:6px;border:1px solid #eee">Conveyance</td><td style="padding:6px;border:1px solid #eee">${fmt(pr.convey)}</td></tr>
            <tr><td style="padding:6px;border:1px solid #eee">Special</td><td style="padding:6px;border:1px solid #eee">${fmt(pr.special)}</td></tr>
            <tr><td style="padding:6px;border:1px solid #eee">Bonus (Monthly)</td><td style="padding:6px;border:1px solid #eee">${fmt(pr.bonusMonthly)}</td></tr>
            <tr><td style="padding:6px;border:1px solid #eee"><strong>Gross</strong></td><td style="padding:6px;border:1px solid #eee"><strong>${fmt(pr.gross)}</strong></td></tr>
          </table>
        </div>
        <div style="width:320px;">
          <div style="font-weight:800;margin-bottom:6px">Deductions</div>
          <table style="width:100%;border-collapse:collapse;">
            <tr><td style="padding:6px;border:1px solid #eee">LWP Deduction</td><td style="padding:6px;border:1px solid #eee">${fmt(pr.lopDeduction)}</td></tr>
            <tr><td style="padding:6px;border:1px solid #eee">Employee PF</td><td style="padding:6px;border:1px solid #eee">${fmt(pr.pfEmployee)}</td></tr>
            <tr><td style="padding:6px;border:1px solid #eee">Employee ESI</td><td style="padding:6px;border:1px solid #eee">${fmt(pr.esiEmployee)}</td></tr>
            <tr><td style="padding:6px;border:1px solid #eee">Income Tax</td><td style="padding:6px;border:1px solid #eee">${fmt(pr.incomeTax)}</td></tr>
            <tr><td style="padding:6px;border:1px solid #eee"><strong>Total Deductions</strong></td><td style="padding:6px;border:1px solid #eee"><strong>${fmt(pr.totalDeductions)}</strong></td></tr>
            <tr><td style="padding:6px;border:1px solid #eee"><strong>Net Pay</strong></td><td style="padding:6px;border:1px solid #eee"><strong>${fmt(pr.net)}</strong></td></tr>
          </table>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;">
        <div style="width:60%;">
          <div class="mini muted">Working days: ${pr.presentDays + pr.approvedLeaveDays + pr.lwpDays} • Present: ${pr.presentDays} • Leave: ${pr.approvedLeaveDays} • LWP: ${pr.lwpDays}</div>
          <div style="margin-top:8px;font-size:12px;color:#444">Employer PF Contribution: ${fmt(pr.pfEmployer)} • Employer ESI: ${fmt(pr.esiEmployer)}</div>
        </div>
        <div style="text-align:right;">
          <!-- QR placeholder - simple encoded text -->
          <div style="border:1px solid #eee;padding:8px;border-radius:6px;background:#fafafa;"><div style="font-size:12px">QR: ${escapeHtml(pr.id)}</div></div>
        </div>
      </div>

      <div style="margin-top:16px;font-size:12px;color:#666">
        This is a computer generated payslip and does not require signature. Keep a copy for your records. For discrepancies, contact HR.
      </div>
    `;

    // render and save PDF
    document.body.appendChild(node);
    const canvas = await html2canvas(node, { scale: 2 });
    const img = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit: 'pt', format: 'a4' });
    const pageW = pdf.internal.pageSize.getWidth();
    const imgW = pageW - 40;
    pdf.addImage(img, 'PNG', 20, 20, imgW, 0);
    pdf.save(`Payslip_${pr.employeeCode}_${pr.month}.pdf`);
    document.body.removeChild(node);
  }

  /* Export payroll register (all months or filtered view) */
  function pay_exportRegister(){
    const rows = (STORE.payroll||[]).map(p => ({
      Month: p.month, Employee: p.employeeName, Code: p.employeeCode, Gross: p.gross, Deductions: p.totalDeductions, Net: p.net
    }));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, 'Payroll');
    XLSX.writeFile(wb, 'Payroll_Register.xlsx');
  }

  /* View last payroll run for quick access */
  function pay_viewLast(){
    const last = (STORE.payroll||[]).slice(-1)[0];
    if(!last) return alert('No payroll runs yet');
    pay_viewPayslip(last.id);
  }

  /* Hook into route to render register when view opened */
  const prevRoutePay = route;
  route = function(v){
    prevRoutePay(v);
    try{
      if(v === 'payroll') pay_renderRegister();
    }catch(e){ console.error('payroll route err', e); }
  };

  // Expose functions globally
  window.pay_run = pay_run;
  window.pay_openPayrollRun = pay_openPayrollRun;
  window.pay_renderRegister = pay_renderRegister;
  window.pay_viewPayslip = pay_viewPayslip;
  window.pay_exportRegister = pay_exportRegister;
  window.pay_downloadRecord = pay_downloadRecord;
  window.pay_viewLast = pay_viewLast;

  // initial render if necessary
  if(document.getElementById('payrollView').style.display !== 'none'){
    pay_renderRegister();
  }
}());
/* ===========================
   END PART 6
   =========================== */
 /* ===========================
   PART 7: Letters & Templates Module
   - Offer/Appointment/Experience/Relieving/Salary/Hike/Promotion/Termination
   - Template editor, single & bulk generation, history tracking
   - Dependencies: STORE, saveStore(), uid(), emp_find(), logActivity(), escapeHtml(), html2canvas, jspdf, XLSX, fileToBase64()
   =========================== */

(function(){
  // Default templates (admin-editable). Placeholders: {{name}}, {{code}}, {{designation}}, {{department}}, {{doj}}, {{salary_monthly}}, {{salary_annual}}, {{joining_date}}, {{last_working_date}}, {{manager}}, {{company_name}}, {{date}}, {{address}}
  if(!STORE.templates) {
    STORE.templates = {
      'appointment': {
        title: 'Appointment / Joining Letter',
        description: 'Formal appointment letter when employee joins.',
        body: `Date: {{date}}

To,
{{name}}
{{address}}

Subject: Appointment as {{designation}}

Dear {{name}},

We are pleased to confirm your appointment as {{designation}} with Konarak Food & Beverages. Your employee code is {{code}}. Your date of joining will be {{doj}}.

Compensation: Your gross monthly salary will be ₹{{salary_monthly}} (annual ₹{{salary_annual}}). Your probation period will be 3 months. Please report to {{manager}} at {{branch}}.

Sincerely,
Konarak Food & Beverages`
      },
      'experience': {
        title: 'Experience Letter',
        description: 'Issued on exit, confirms service period and role.',
        body: `Date: {{date}}

To Whom It May Concern,

This is to certify that {{name}} (Employee Code: {{code}}) was employed with Konarak Food & Beverages as {{designation}} in the {{department}} department from {{doj}} to {{last_working_date}}.

During the tenure, {{name}} displayed satisfactory performance. We wish them success in future endeavors.

Sincerely,
HR - Konarak Food & Beverages`
      },
      'relieving': {
        title: 'Relieving Letter',
        description: 'Confirms employee relieved from duties.',
        body: `Date: {{date}}

To,
{{name}}
{{address}}

Subject: Relieving Letter

Dear {{name}},

This is to confirm that you have been relieved from your duties at Konarak Food & Beverages with effect from {{last_working_date}}. All dues have been settled as per company records.

We wish you success in your future endeavors.

Regards,
HR Team`
      },
      'salary_cert': {
        title: 'Salary Certificate',
        description: 'Official salary certificate for bank/loan purposes.',
        body: `Date: {{date}}

To Whom It May Concern,

This is to certify that Mr./Ms. {{name}} (Employee Code: {{code}}) is working with Konarak Food & Beverages as {{designation}} in {{department}} since {{doj}}. The current gross salary is ₹{{salary_monthly}} per month (₹{{salary_annual}} per annum).

This certificate is issued upon request for verification purposes.

Sincerely,
HR Team`
      },
      'hike': {
        title: 'Hike / Increment Letter',
        description: 'Notifies employee of salary increase.',
        body: `Date: {{date}}

Dear {{name}},

We are pleased to inform you that your salary has been revised effective {{date}}. Your new gross monthly salary will be ₹{{salary_monthly}} (annual ₹{{salary_annual}}). This change is due to performance and business factors.

New designation (if applicable): {{designation}}

Regards,
HR`
      },
      'promotion': {
        title: 'Promotion Letter',
        description: 'Promotion confirmation with new designation.',
        body: `Date: {{date}}

Dear {{name}},

Congratulations. You are promoted to the position of {{designation}} effective from {{date}}. Your new salary will be ₹{{salary_monthly}} per month.

Regards,
HR`
      },
      'termination': {
        title: 'Termination Notice',
        description: 'Termination/notice letter (basic).',
        body: `Date: {{date}}

To,
{{name}}

Subject: Termination of employment

Dear {{name}},

This letter is to inform you that your employment with Konarak Food & Beverages will be terminated effective {{last_working_date}}. Please clear all company property before your exit.

Regards,
HR`
      }
    };
    saveStore();
  }

  /* -------------------------
     Helper: build placeholder map from employee
     ------------------------- */
  function letters_buildPlaceholders(emp){
    const placeholders = {};
    placeholders['name'] = emp.fullname || `${emp.email||''}`;
    placeholders['code'] = emp.code || '';
    placeholders['designation'] = emp.designation || '';
    placeholders['department'] = emp.department || '';
    placeholders['doj'] = emp.doj || '';
    placeholders['salary_monthly'] = Number(emp.basic||0) + Number(emp.hra||0) + Number(emp.convey||0) + Number(emp.special||0);
    placeholders['salary_annual'] = Math.round(placeholders['salary_monthly'] * 12);
    placeholders['joining_date'] = emp.doj || '';
    placeholders['last_working_date'] = emp.lastWorkingDate || '';
    placeholders['manager'] = emp.manager || '';
    placeholders['company_name'] = 'Konarak Food & Beverages';
    placeholders['date'] = new Date().toLocaleDateString();
    placeholders['address'] = emp.present_address || emp.permanent_address || '';
    placeholders['branch'] = emp.location || '';
    return placeholders;
  }

  /* -------------------------
     Render template with placeholders
     ------------------------- */
  function letters_renderTemplateText(templateKey, emp){
    const tmpl = STORE.templates[templateKey];
    if(!tmpl) return 'Template not found';
    let body = tmpl.body || '';
    const ph = letters_buildPlaceholders(emp || {});
    Object.keys(ph).forEach(k => {
      const re = new RegExp(`{{\\s*${k}\\s*}}`, 'g');
      body = body.replace(re, escapeHtml(String(ph[k] || '')));
    });
    return body;
  }

  /* -------------------------
     UI: Open single letter creation modal
     ------------------------- */
  function letters_openCreate(){
    if(!SESSION || SESSION.role !== 'admin') return alert('Admin only');
    // build employee dropdown
    const empOptions = (STORE.employees||[]).map(e => `<option value="${e.id}">${escapeHtml(e.fullname)} (${escapeHtml(e.code||'')})</option>`).join('');
    const templateOptions = Object.keys(STORE.templates).map(k => `<option value="${k}">${escapeHtml(STORE.templates[k].title)}</option>`).join('');
    const modal = document.createElement('div'); modal.className = 'modal-backdrop';
    modal.innerHTML = `<div class="modal" style="width:760px;max-width:96vw;">
      <div style="display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:900">Generate Letter</div><div><button class="btn ghost" id="lettersCreateClose">Close</button></div></div>
      <div style="margin-top:8px;">
        <div class="mini muted">Employee</div>
        <select id="letters_emp" class="field small"><option value="">-- Select Employee --</option>${empOptions}</select>
        <div style="margin-top:8px;" class="mini muted">Template</div>
        <select id="letters_template" class="field small">${templateOptions}</select>
        <div style="margin-top:8px;" class="mini muted">Preview</div>
        <textarea id="letters_preview" class="field" rows="8" readonly></textarea>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button class="btn primary" id="lettersGenerateBtn">Generate & Download PDF</button>
          <button class="btn ghost" id="lettersSaveHistory">Generate & Save to History</button>
          <button class="btn ghost" id="lettersPreviewBtn">Refresh Preview</button>
        </div>
      </div>
    </div>`;
    document.body.appendChild(modal);
    document.getElementById('lettersCreateClose').addEventListener('click', ()=> modal.remove());
    document.getElementById('lettersPreviewBtn').addEventListener('click', ()=> {
      const empId = document.getElementById('letters_emp').value;
      const templ = document.getElementById('letters_template').value;
      const emp = emp_find(empId) || {};
      document.getElementById('letters_preview').value = letters_renderTemplateText(templ, emp);
    });
    document.getElementById('lettersGenerateBtn').addEventListener('click', async ()=>{
      const empId = document.getElementById('letters_emp').value;
      const templ = document.getElementById('letters_template').value;
      if(!empId) return alert('Select employee');
      if(!templ) return alert('Select template');
      const emp = emp_find(empId);
      const text = letters_renderTemplateText(templ, emp);
      // produce PDF
      await letters_generatePdfFromText(templ, emp, text);
      logActivity(`Letter generated: ${templ} for ${emp.fullname}`);
    });
    document.getElementById('lettersSaveHistory').addEventListener('click', async ()=>{
      const empId = document.getElementById('letters_emp').value;
      const templ = document.getElementById('letters_template').value;
      if(!empId) return alert('Select employee');
      if(!templ) return alert('Select template');
      const emp = emp_find(empId);
      const text = letters_renderTemplateText(templ, emp);
      // save entry to history with PDF dataURI
      const pdfData = await letters_htmlToPdfDataUrl(templ, emp, text);
      const hist = { id: uid('letter'), template: templ, templateTitle: STORE.templates[templ].title, employeeId: empId, employeeName: emp.fullname, date: new Date().toISOString(), pdf: pdfData };
      STORE.lettersHistory = STORE.lettersHistory || [];
      STORE.lettersHistory.push(hist);
      saveStore();
      letters_renderHistory();
      alert('Letter generated and saved to history');
      logActivity(`Letter saved to history: ${templ} for ${emp.fullname}`);
    });
  }

  /* -------------------------
     Convert HTML/text to printable node then to PDF dataURL
     ------------------------- */
  async function letters_htmlToPdfDataUrl(templKey, emp, text){
    const htmlNode = document.createElement('div');
    htmlNode.style.width='800px'; htmlNode.style.padding='18px'; htmlNode.style.background='#fff'; htmlNode.style.color='#000';
    htmlNode.innerHTML = `<div style="display:flex;gap:12px;align-items:center;">
      <img src="logo.png" style="width:90px;height:90px;object-fit:contain" onerror="this.style.display='none'">
      <div><div style="font-weight:900;font-size:20px">${escapeHtml(STORE.templates[templKey].title)}</div><div style="font-size:12px;color:#666">${escapeHtml(STORE.templates[templKey].description || '')}</div></div>
    </div><hr style="margin:8px 0;border:none;border-top:1px solid #ddd"><pre style="white-space:pre-wrap;font-family:inherit">${escapeHtml(text)}</pre>`;
    document.body.appendChild(htmlNode);
    const canvas = await html2canvas(htmlNode, { scale: 2 });
    const img = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit: 'pt', format: 'a4' });
    const pageW = pdf.internal.pageSize.getWidth();
    const imgW = pageW - 40;
    pdf.addImage(img, 'PNG', 20, 20, imgW, 0);
    document.body.removeChild(htmlNode);
    return pdf.output('datauristring');
  }

  async function letters_generatePdfFromText(templKey, emp, text){
    const dataUri = await letters_htmlToPdfDataUrl(templKey, emp, text);
    // trigger download
    const a = document.createElement('a');
    a.href = dataUri;
    const fname = `${templKey}_${(emp.code||emp.id||'EMP')}_${new Date().toISOString().slice(0,10)}.pdf`.replace(/\s+/g,'_');
    a.download = fname;
    a.click();
  }

  /* -------------------------
     History rendering & actions
     ------------------------- */
  function letters_renderHistory(){
    const body = document.getElementById('lettersHistoryBody');
    if(!body) return;
    body.innerHTML = '';
    STORE.lettersHistory = STORE.lettersHistory || [];
    // filters
    const q = (document.getElementById('lettersSearch').value || '').trim().toLowerCase();
    const typeFilter = (document.getElementById('lettersFilterType').value || '');
    const empFilter = (document.getElementById('lettersFilterEmp').value || '');
    let list = (STORE.lettersHistory||[]).slice().reverse();
    if(q) list = list.filter(h => (h.employeeName||'').toLowerCase().includes(q) || (h.template||'').toLowerCase().includes(q));
    if(typeFilter) list = list.filter(h => h.template === typeFilter);
    if(empFilter) list = list.filter(h => h.employeeId === empFilter);
    list.forEach(h => {
      body.insertAdjacentHTML('beforeend', `<tr>
        <td>${escapeHtml(h.templateTitle || h.template)}</td>
        <td>${escapeHtml(h.employeeName || '')}</td>
        <td>${new Date(h.date).toLocaleString()}</td>
        <td>${escapeHtml(h.template)}</td>
        <td>
          <button class="btn ghost" onclick="letters_download('${h.id}')">Download</button>
          <button class="btn ghost" onclick="letters_view('${h.id}')">View</button>
          <button class="btn ghost" onclick="letters_removeHistory('${h.id}')">Delete</button>
        </td>
      </tr>`);
    });
    document.getElementById('lettersTotal').innerText = (STORE.lettersHistory||[]).length;
    // populate filters
    const tsel = document.getElementById('lettersFilterType');
    if(tsel) tsel.innerHTML = '<option value="">All Types</option>' + Object.keys(STORE.templates).map(k => `<option value="${k}">${escapeHtml(STORE.templates[k].title)}</option>`).join('');
    const esel = document.getElementById('lettersFilterEmp');
    if(esel) esel.innerHTML = '<option value="">All Employees</option>' + (STORE.employees||[]).map(e=>`<option value="${e.id}">${escapeHtml(e.fullname)} (${escapeHtml(e.code||'')})</option>`).join('');
  }

  function letters_download(id){
    const rec = (STORE.lettersHistory||[]).find(x=>x.id===id);
    if(!rec) return alert('Not found');
    const a = document.createElement('a');
    a.href = rec.pdf;
    a.download = `${rec.template}_${rec.employeeName}_${rec.date.slice(0,10)}.pdf`.replace(/\s+/g,'_');
    a.click();
  }

  function letters_view(id){
    const rec = (STORE.lettersHistory||[]).find(x=>x.id===id);
    if(!rec) return alert('Not found');
    const w = window.open('');
    w.document.write(`<iframe src="${rec.pdf}" style="width:100%;height:100vh;border:none"></iframe>`);
  }

  function letters_removeHistory(id){
    if(!confirm('Delete letter from history?')) return;
    STORE.lettersHistory = (STORE.lettersHistory||[]).filter(x=>x.id!==id);
    saveStore();
    letters_renderHistory();
    logActivity(`Letter history removed: ${id}`);
  }

  /* -------------------------
     Template manager (admin) — edit templates
     ------------------------- */
  function letters_openTemplateManager(){
    if(!SESSION || SESSION.role !== 'admin') return alert('Admin only');
    const modal = document.createElement('div'); modal.className = 'modal-backdrop';
    const rows = Object.keys(STORE.templates).map(k => {
      const t = STORE.templates[k];
      return `<div style="border-bottom:1px solid rgba(255,255,255,0.02);padding:8px 0;">
        <div style="display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:800">${escapeHtml(t.title)}</div><div><button class="btn ghost" onclick="letters_editTemplate('${k}')">Edit</button></div></div>
        <div class="mini muted">${escapeHtml(t.description)}</div>
      </div>`;
    }).join('');
    modal.innerHTML = `<div class="modal" style="width:760px;max-width:96vw;">
      <div style="display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:900">Template Manager</div><div><button class="btn ghost" id="tmplClose">Close</button></div></div>
      <div style="margin-top:8px;">${rows}</div>
      <div style="margin-top:8px;display:flex;gap:8px;">
        <input id="new_t_key" placeholder="new_key" class="field small" />
        <input id="new_t_title" placeholder="Title" class="field small" />
        <input id="new_t_desc" placeholder="Short description" class="field small" />
        <button class="btn primary" id="new_t_add">Add Template</button>
      </div>
    </div>`;
    document.body.appendChild(modal);
    document.getElementById('tmplClose').addEventListener('click', ()=> modal.remove());
    document.getElementById('new_t_add').addEventListener('click', ()=>{
      const key = (document.getElementById('new_t_key').value || '').trim();
      const title = (document.getElementById('new_t_title').value || '').trim();
      const desc = (document.getElementById('new_t_desc').value || '').trim();
      if(!key || !title) return alert('Provide key and title');
      if(STORE.templates[key]) return alert('Template key exists');
      STORE.templates[key] = { title, description: desc, body: `Date: {{date}}\n\nDear {{name}},\n\n<content>\n\nRegards,` };
      saveStore();
      modal.remove();
      letters_openTemplateManager();
    });
  }

  function letters_editTemplate(key){
    if(!SESSION || SESSION.role !== 'admin') return alert('Admin only');
    const t = STORE.templates[key];
    if(!t) return alert('Template not found');
    const modal = document.createElement('div'); modal.className='modal-backdrop';
    modal.innerHTML = `<div class="modal" style="width:760px;max-width:96vw;">
      <div style="display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:900">Edit Template — ${escapeHtml(t.title)}</div><div><button class="btn ghost" id="tmplEditClose">Close</button></div></div>
      <div style="margin-top:8px;">
        <div class="mini muted">Title</div>
        <input id="tmpl_title" class="field small" value="${escapeHtml(t.title)}" />
        <div class="mini muted" style="margin-top:8px">Description</div>
        <input id="tmpl_desc" class="field small" value="${escapeHtml(t.description||'')}" />
        <div class="mini muted" style="margin-top:8px">Body</div>
        <textarea id="tmpl_body" class="field" rows="12">${escapeHtml(t.body||'')}</textarea>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button class="btn primary" id="tmplSave">Save</button>
          <button class="btn ghost" id="tmplCancel">Cancel</button>
        </div>
      </div>
    </div>`;
    document.body.appendChild(modal);
    document.getElementById('tmplEditClose').addEventListener('click', ()=> modal.remove());
    document.getElementById('tmplCancel').addEventListener('click', ()=> modal.remove());
    document.getElementById('tmplSave').addEventListener('click', ()=>{
      t.title = document.getElementById('tmpl_title').value || t.title;
      t.description = document.getElementById('tmpl_desc').value || t.description;
      t.body = document.getElementById('tmpl_body').value || t.body;
      STORE.templates[key] = t;
      saveStore();
      alert('Template saved');
      modal.remove();
      letters_openTemplateManager();
    });
  }

  /* -------------------------
     Bulk generation: choose employees + template
     ------------------------- */
  function letters_openBulk(){
    if(!SESSION || SESSION.role !== 'admin') return alert('Admin only');
    const employeesHtml = (STORE.employees||[]).map(e=>`<div style="display:flex;gap:8px;align-items:center;padding:4px 0"><input type="checkbox" class="letters_bulk_cb" value="${e.id}" /> ${escapeHtml(e.fullname)} (${escapeHtml(e.code||'')})</div>`).join('');
    const templateOptions = Object.keys(STORE.templates).map(k => `<option value="${k}">${escapeHtml(STORE.templates[k].title)}</option>`).join('');
    const modal = document.createElement('div'); modal.className='modal-backdrop';
    modal.innerHTML = `<div class="modal" style="width:760px;max-width:96vw;max-height:90vh;overflow:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:900">Bulk Generate Letters</div><div><button class="btn ghost" id="bulkClose">Close</button></div></div>
      <div style="margin-top:8px;">
        <div class="mini muted">Template</div>
        <select id="bulk_template" class="field small">${templateOptions}</select>
        <div style="margin-top:8px" class="mini muted">Select Employees</div>
        <div style="max-height:300px;overflow:auto;border:1px solid rgba(255,255,255,0.03);padding:8px;">${employeesHtml}</div>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button class="btn primary" id="bulkGenerate">Generate for Selected</button>
          <button class="btn ghost" id="bulkGenerateAll">Generate for All</button>
        </div>
      </div>
    </div>`;
    document.body.appendChild(modal);
    document.getElementById('bulkClose').addEventListener('click', ()=> modal.remove());
    document.getElementById('bulkGenerate').addEventListener('click', async ()=>{
      const templ = document.getElementById('bulk_template').value;
      if(!templ) return alert('Select template');
      const checks = Array.from(document.querySelectorAll('.letters_bulk_cb')).filter(ch=>ch.checked).map(ch=>ch.value);
      if(checks.length === 0) return alert('Select employees');
      // sequentially generate and save to history
      for(const empId of checks){
        const emp = emp_find(empId);
        const text = letters_renderTemplateText(templ, emp);
        const pdfData = await letters_htmlToPdfDataUrl(templ, emp, text);
        STORE.lettersHistory = STORE.lettersHistory || [];
        STORE.lettersHistory.push({ id: uid('letter'), template: templ, templateTitle: STORE.templates[templ].title, employeeId: empId, employeeName: emp.fullname, date: new Date().toISOString(), pdf: pdfData });
      }
      saveStore();
      letters_renderHistory();
      alert(`Generated letters for ${checks.length} employee(s).`);
      logActivity(`Bulk generated ${checks.length} letters of type ${templ}`);
    });
    document.getElementById('bulkGenerateAll').addEventListener('click', async ()=>{
      const templ = document.getElementById('bulk_template').value;
      if(!templ) return alert('Select template');
      const all = (STORE.employees||[]).map(e=>e.id);
      for(const empId of all){
        const emp = emp_find(empId);
        const text = letters_renderTemplateText(templ, emp);
        const pdfData = await letters_htmlToPdfDataUrl(templ, emp, text);
        STORE.lettersHistory = STORE.lettersHistory || [];
        STORE.lettersHistory.push({ id: uid('letter'), template: templ, templateTitle: STORE.templates[templ].title, employeeId: empId, employeeName: emp.fullname, date: new Date().toISOString(), pdf: pdfData });
      }
      saveStore();
      letters_renderHistory();
      alert(`Generated letters for ${all.length} employee(s).`);
      logActivity(`Bulk generated all letters of type ${templ}`);
    });
  }

  /* -------------------------
     Export history to Excel
     ------------------------- */
  function letters_exportHistory(){
    const rows = (STORE.lettersHistory||[]).map(h => ({ Template: h.templateTitle || h.template, Employee: h.employeeName, Date: h.date }));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, 'LettersHistory');
    XLSX.writeFile(wb, 'Letters_History.xlsx');
  }

  /* -------------------------
     Generate single HTML employee login page with employee details (for upload to employee folder)
     Returns generated file blob URL or triggers download
     ------------------------- */
  function letters_generateEmployeeHtml(empId){
    const emp = emp_find(empId);
    if(!emp) return alert('Employee not found');
    // simple standalone HTML that reads basic info and shows profile. This file includes embedded JSON for the employee.
    const content = `<!doctype html>
<html>
<head><meta charset="utf-8"><title>${emp.fullname} — Profile</title>
<style>
  body{font-family:Segoe UI,Arial,Helvetica,sans-serif;padding:18px;background:#f6f8fb;color:#111}
  .card{max-width:720px;margin:20px auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
  img{max-width:140px;border-radius:6px}
  .muted{color:#666;font-size:13px}
</style>
</head>
<body>
  <div class="card">
    <div style="display:flex;gap:12px;align-items:center">
      <img src="${emp.photo || ''}" onerror="this.style.display='none'"/>
      <div>
        <h2 style="margin:0">${emp.fullname}</h2>
        <div class="muted">${emp.designation} • ${emp.department}</div>
        <div class="muted">Employee Code: ${emp.code}</div>
        <div style="margin-top:8px"><strong>Email:</strong> ${emp.email} • <strong>Phone:</strong> ${emp.phone}</div>
      </div>
    </div>
    <hr/>
    <div><strong>Joining Date:</strong> ${emp.doj || ''}</div>
    <div><strong>Bank:</strong> ${emp.bank || ''} • <strong>A/C:</strong> ${emp.account || ''}</div>
    <div style="margin-top:8px"><strong>Address:</strong> ${escapeHtml(emp.present_address || '')}</div>
  </div>
  <!-- Embedded employee JSON for further client-side use -->
  <script>window.EMPLOYEE = ${JSON.stringify(emp)};</script>
</body>
</html>`;
    // download as file
    const blob = new Blob([content], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const fname = `${emp.code || emp.id}_profile.html`;
    a.href = url; a.download = fname; a.click();
    URL.revokeObjectURL(url);
    logActivity(`Employee HTML generated: ${fname}`);
  }

  /* -------------------------
     Initialization & hooks
     ------------------------- */
  // ensure history array
  STORE.lettersHistory = STORE.lettersHistory || [];
  // expose
  window.letters_openCreate = letters_openCreate;
  window.letters_openBulk = letters_openBulk;
  window.letters_renderHistory = letters_renderHistory;
  window.letters_download = letters_download;
  window.letters_view = letters_view;
  window.letters_removeHistory = letters_removeHistory;
  window.letters_openTemplateManager = letters_openTemplateManager;
  window.letters_generateEmployeeHtml = letters_generateEmployeeHtml;
  window.letters_exportHistory = letters_exportHistory;
  // hook route to render when view is opened
  const prevRouteLetters = route;
  route = function(v){
    prevRouteLetters(v);
    try{ if(v === 'letters') letters_renderHistory(); }catch(e){ console.error('letters route err', e); }
  };
  // initial population if visible now
  if(document.getElementById('lettersView') && document.getElementById('lettersView').style.display !== 'none'){
    letters_renderHistory();
  }
}());
/* ===========================
   END PART 7
   =========================== */
/* ===========================
   PART 8: ID CARD ENGINE + ESS
   - Gradient: G1 (Blue → Cyan → Purple)
   - QR: Code + Name (Google Chart QR)
   - ESS Features: E1 E2 E3 E4 E5 E6 E8 E9
   Dependencies: STORE, SESSION, saveStore(), uid(), emp_find(), emp_renderList(), logActivity(), escapeHtml(), html2canvas, jspdf, letters_generateEmployeeHtml()
   =========================== */

(function(){
  // Config
  const ID_GRADIENT = 'linear-gradient(135deg,#3b82f6,#06b6d4,#7c3aed)'; // G1 Blue→Cyan→Purple
  const QR_SIZE = 180;
  const ESS_ALLOWED = ['profile','attendance','leaves','payroll','letters','idcard'];

  /* ------------------------
     Helpers
     ------------------------ */
  function id_populateEmployeeSelect(){
    const sel = document.getElementById('id_emp_select');
    if(!sel) return;
    sel.innerHTML = '<option value="">-- Select Employee --</option>' + (STORE.employees||[]).map(e => `<option value="${e.id}">${escapeHtml(e.fullname || e.email)} (${escapeHtml(e.code||'')})</option>`).join('');
    // default to first
    if(sel.options.length > 1) sel.selectedIndex = 1;
  }

  function id_getSelectedEmployee(){
    const sel = document.getElementById('id_emp_select');
    if(!sel) return null;
    const id = sel.value;
    if(!id) return null;
    return emp_find(id);
  }

  /* ------------------------
     Build vertical ID card DOM for an employee
     Returns DOM element (not attached)
     ------------------------ */
  function id_buildCardNode(emp){
    const code = emp.code || emp.id || '';
    const name = emp.fullname || emp.email || '';
    const designation = emp.designation || '';
    const dept = emp.department || '';
    const photo = emp.photo || '';
    const qrText = `${code} | ${name}`; // Q2
    // Google Chart QR URL
    const qrUrl = 'https://chart.googleapis.com/chart?chs=' + QR_SIZE + 'x' + QR_SIZE + '&cht=qr&chl=' + encodeURIComponent(qrText) + '&choe=UTF-8';

    const card = document.createElement('div');
    card.style.width = '320px';
    card.style.borderRadius = '14px';
    card.style.overflow = 'hidden';
    card.style.background = 'white';
    card.style.boxShadow = '0 12px 30px rgba(2,6,23,0.18)';
    card.style.fontFamily = 'Segoe UI, Arial, sans-serif';
    card.innerHTML = `
      <div style="background:${ID_GRADIENT}; padding:18px; display:flex;flex-direction:column;align-items:center;">
        <div style="width:120px;height:120px;border-radius:14px;overflow:hidden;background:#fff;display:flex;align-items:center;justify-content:center;">
          <img src="${photo}" onerror="this.style.display='none'" style="width:100%;height:100%;object-fit:cover"/>
        </div>
        <div style="margin-top:10px;color:white;font-weight:800;font-size:16px">${escapeHtml(name)}</div>
        <div style="color:rgba(255,255,255,0.9);font-size:13px">${escapeHtml(designation)}</div>
      </div>
      <div style="padding:14px;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-weight:800">${escapeHtml(code)}</div>
            <div class="mini muted">${escapeHtml(dept)}</div>
          </div>
          <div style="text-align:center">
            <img src="${qrUrl}" style="width:84px;height:84px;object-fit:contain;border-radius:6px;background:#fff;padding:6px" alt="QR"/>
          </div>
        </div>
        <div style="margin-top:12px;font-size:12px;color:#444">
          <div><strong>Joining:</strong> ${escapeHtml(emp.doj || '')}</div>
          <div style="margin-top:6px"><strong>Phone:</strong> ${escapeHtml(emp.phone || '')}</div>
        </div>
      </div>
      <div style="padding:10px;background:#fafafa;text-align:center;font-size:12px;color:#666">Konarak Food & Beverages</div>
    `;
    return card;
  }

  /* ------------------------
     Preview ID card in page
     ------------------------ */
  function id_preview(){
    const emp = id_getSelectedEmployee();
    const wrap = document.getElementById('idPreviewWrap');
    wrap.innerHTML = '';
    if(!emp) { wrap.innerHTML = '<div class="mini muted">Select an employee to preview</div>'; return; }
    const card = id_buildCardNode(emp);
    wrap.appendChild(card);
  }

  /* ------------------------
     Download ID card as PDF (single)
     ------------------------ */
  async function id_downloadPdf(){
    const emp = id_getSelectedEmployee();
    if(!emp) return alert('Select an employee');
    const fname = (document.getElementById('id_file_name').value || `${emp.code || emp.id}_ID`).replace(/\s+/g,'_') + '.pdf';
    const node = id_buildCardNode(emp);
    // make white background for canvas
    node.style.background = '#fff';
    document.body.appendChild(node);
    const canvas = await html2canvas(node, { scale: 2 });
    const img = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit: 'pt', format: [420, 600] }); // vertical card size
    const pageW = pdf.internal.pageSize.getWidth();
    pdf.addImage(img, 'PNG', 20, 20, pageW - 40, 0);
    pdf.save(fname);
    document.body.removeChild(node);
    logActivity(`ID card PDF generated for ${emp.fullname}`);
  }

  /* ------------------------
     Download standalone HTML for the selected employee (for GitHub pages)
     This is similar to letters_generateEmployeeHtml but produces ID card page
     ------------------------ */
  function id_downloadHtml(){
    const emp = id_getSelectedEmployee();
    if(!emp) return alert('Select an employee');
    const html = `<!doctype html>
<html>
<head><meta charset="utf-8"><title>${escapeHtml(emp.fullname)} — ID Card</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body{font-family:Segoe UI,Arial,sans-serif;background:#f3f6fb;padding:20px}
.card{max-width:360px;margin:20px auto;border-radius:14px;overflow:hidden;box-shadow:0 10px 30px rgba(2,6,23,0.12);background:#fff}
.header{padding:18px;background:${ID_GRADIENT};color:#fff;text-align:center}
.photo{width:120px;height:120px;margin:0 auto;border-radius:12px;overflow:hidden;background:#fff}
.photo img{width:100%;height:100%;object-fit:cover}
.content{padding:14px}
.small{font-size:13px;color:#666}
.qr{width:88px;height:88px;border-radius:8px;padding:6px;background:#fff}
</style>
</head>
<body>
  <div class="card">
    <div class="header">
      <div class="photo"><img src="${emp.photo || ''}" onerror="this.style.display='none'"/></div>
      <h2 style="margin:10px 0 0 0">${escapeHtml(emp.fullname)}</h2>
      <div style="margin-top:6px;font-weight:600">${escapeHtml(emp.designation || '')}</div>
    </div>
    <div class="content">
      <div><strong>Code:</strong> ${escapeHtml(emp.code || '')}</div>
      <div class="small"><strong>Dept:</strong> ${escapeHtml(emp.department || '')}</div>
      <div class="small"><strong>Joining:</strong> ${escapeHtml(emp.doj || '')}</div>
      <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small"><strong>Phone:</strong> ${escapeHtml(emp.phone||'')}</div>
        </div>
        <div><img class="qr" src="https://chart.googleapis.com/chart?chs=${QR_SIZE}x${QR_SIZE}&cht=qr&chl=${encodeURIComponent((emp.code||'') + ' | ' + (emp.fullname||''))}&choe=UTF-8" alt="QR"></div>
      </div>
    </div>
  </div>
</body>
</html>`;
    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const fname = `${(emp.code||emp.id||'EMP')}_idcard.html`.replace(/\s+/g,'_');
    a.href = url; a.download = fname; a.click();
    URL.revokeObjectURL(url);
    logActivity(`ID HTML generated for ${emp.fullname}`);
  }

  /* ------------------------
     Bulk generate standalone HTML for all employees (for GitHub upload)
     Downloads a single zip is not supported client-only easily; we'll trigger multiple downloads sequentially
     ------------------------ */
  async function id_bulkGenerateAll(){
    if(!SESSION || SESSION.role !== 'admin') return alert('Admin only');
    const emps = STORE.employees || [];
    if(emps.length === 0) return alert('No employees found');
    for(const emp of emps){
      // reuse the download function by programmatically selecting
      const prev = document.getElementById('id_emp_select').value;
      document.getElementById('id_emp_select').value = emp.id;
      id_downloadHtml();
      await new Promise(r=>setTimeout(r, 250)); // small gap so browser handles downloads
      document.getElementById('id_emp_select').value = prev;
    }
    alert(`Generated HTML files for ${emps.length} employees (check your downloads).`);
  }

  /* ------------------------
     ESS: Login & session for employee (simple local signin using employee.code and employee.password)
     - On success show ESS UI
     ------------------------ */
  function ess_login(){
    const code = (document.getElementById('ess_login_code').value || '').trim();
    const pass = (document.getElementById('ess_login_pass').value || '').trim();
    if(!code || !pass) return alert('Enter credentials');
    const emp = (STORE.employees||[]).find(e => (e.code||'').toLowerCase() === code.toLowerCase());
    if(!emp) return alert('Employee not found');
    if(emp.password !== pass) return alert('Invalid password'); // passwords stored in clear (client-side)
    // set SESSION object for employee
    SESSION = { role: 'employee', user: { id: emp.id, fullname: emp.fullname, email: emp.email } };
    saveSession();
    ess_renderProfileCard(emp);
    document.getElementById('essContent').style.display = 'block';
    ess_view('profile');
    logActivity(`Employee signed in: ${emp.fullname}`);
    alert(`Welcome ${emp.fullname}`);
  }

  function ess_logout(){
    SESSION = null;
    saveSession();
    document.getElementById('essContent').style.display = 'none';
    document.getElementById('essMainPane').innerHTML = '';
    alert('Signed out');
  }

  /* small helper to persist SESSION (localStorage key used in your app may differ) */
  function saveSession(){
    try{ localStorage.setItem('SESSION', JSON.stringify(SESSION)); } catch(e){}
  }
  function loadSession(){
    try{ const s = localStorage.getItem('SESSION'); if(s) SESSION = JSON.parse(s); } catch(e){}
  }
  loadSession();
  if(SESSION && SESSION.role === 'employee'){
    // if user is already signed in, show ESS content
    document.getElementById('essContent') && (document.getElementById('essContent').style.display = 'block');
    const emp = emp_find(SESSION.user.id);
    emp && ess_renderProfileCard(emp);
    ess_view('profile');
  }

  /* ------------------------
     ESS: render small profile card in sidebar
     ------------------------ */
  function ess_renderProfileCard(emp){
    const wrap = document.getElementById('essProfileCard');
    if(!wrap) return;
    wrap.innerHTML = `<div style="display:flex;gap:12px;align-items:center;">
      <div style="width:64px;height:64px;border-radius:8px;overflow:hidden;background:#fff"><img src="${emp.photo||''}" onerror="this.style.display='none'" style="width:100%;height:100%;object-fit:cover"/></div>
      <div>
        <div style="font-weight:800">${escapeHtml(emp.fullname)}</div>
        <div class="mini muted">${escapeHtml(emp.designation || '')}</div>
        <div class="mini muted">Code: ${escapeHtml(emp.code || '')}</div>
      </div>
    </div>
    <div style="margin-top:8px" class="mini muted">Email: ${escapeHtml(emp.email||'')}</div>
    <div class="mini muted">Phone: ${escapeHtml(emp.phone||'')}</div>`;
  }

  /* ------------------------
     ESS: main pane view router
     ------------------------ */
  function ess_view(view){
    if(!ESS_ALLOWED.includes(view)) return;
    const pane = document.getElementById('essMainPane');
    pane.innerHTML = '';
    const emp = emp_find(SESSION.user.id);
    if(!emp) { pane.innerHTML = '<div class="mini muted">Employee record missing</div>'; return; }
    if(view === 'profile') {
      pane.innerHTML = `<div style="display:flex;gap:12px;align-items:center;">
        <div style="width:120px;height:120px;border-radius:8px;overflow:hidden;background:#fff"><img src="${emp.photo || ''}" onerror="this.style.display='none'" style="width:100%;height:100%;object-fit:cover"/></div>
        <div style="flex:1">
          <h3 style="margin:0">${escapeHtml(emp.fullname)}</h3>
          <div class="mini muted">${escapeHtml(emp.designation || '')} • ${escapeHtml(emp.department || '')}</div>
          <div style="margin-top:8px"><strong>Code:</strong> ${escapeHtml(emp.code || '')}</div>
          <div class="mini muted">DOJ: ${escapeHtml(emp.doj || '')}</div>
          <div style="margin-top:8px"><strong>Bank:</strong> ${escapeHtml(emp.bank || '')} • <strong>A/C:</strong> ${escapeHtml(emp.account || '')}</div>
          <div style="margin-top:8px"><button class="btn ghost" onclick="letters_generateEmployeeHtml('${emp.id}')">Download Profile HTML</button><button class="btn ghost" onclick="id_downloadHtml()">Download ID HTML</button></div>
        </div>
      </div>`;
    } else if(view === 'attendance'){
      // render read-only attendance calendar for employee
      const selDate = new Date().toISOString().slice(0,10);
      // reuse attendance data from STORE.attendance
      let html = `<div style="font-weight:800">Attendance (This Month)</div><div style="margin-top:8px">`;
      const today = new Date();
      const year = today.getFullYear(), month = today.getMonth();
      html += `<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">`;
      for(let d=1; d<= new Date(year, month+1, 0).getDate(); d++){
        const key = new Date(year, month, d).toISOString().slice(0,10);
        const rec = (STORE.attendance||[]).find(r=> r.employeeId === emp.id && r.date === key);
        let cls = 'mini muted';
        let mark = d;
        if(rec){
          if(rec.status === 'Leave' || rec.leaveType) { cls = 'mini'; mark = `<span style="background:#f6e05e;padding:6px;border-radius:6px">${d}</span>`; }
          else if(rec.checkIn) { cls = 'mini'; mark = `<span style="background:#a7f3d0;padding:6px;border-radius:6px">${d}</span>`; }
        } else if([0].includes(new Date(year, month, d).getDay())) {
          // Sunday weekly off
          mark = `<span class="mini muted">${d}</span>`;
        } else {
          mark = `<span style="color:#f87171">${d}</span>`;
        }
        html += `<div style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;margin:4px">${mark}</div>`;
      }
      html += `</div></div>`;
      pane.innerHTML = html;
    } else if(view === 'leaves'){
      // list employee leaves
      const list = (STORE.leaves||[]).filter(l=> l.employeeId === emp.id).sort((a,b)=> new Date(b.appliedAt)-new Date(a.appliedAt));
      let html = `<div style="font-weight:800">My Leaves</div><div style="margin-top:8px"><button class="btn primary" onclick="leave_openApply()">Apply Leave</button></div><div style="margin-top:8px">`;
      if(list.length===0) html += '<div class="mini muted">No leaves applied</div>';
      else {
        html += `<table style="width:100%;border-collapse:collapse"><thead><tr><th>Type</th><th>From</th><th>To</th><th>Days</th><th>Status</th></tr></thead><tbody>`;
        list.forEach(l=> html += `<tr><td>${escapeHtml((leave_getType && leave_getType(l.type) || {}).name||l.type)}</td><td>${escapeHtml(l.from)}</td><td>${escapeHtml(l.to)}</td><td>${l.days}</td><td>${escapeHtml(l.status)}</td></tr>`);
        html += `</tbody></table>`;
      }
      html += `</div>`;
      pane.innerHTML = html;
    } else if(view === 'payroll'){
      const pays = (STORE.payroll||[]).filter(p=> p.employeeId === emp.id).sort((a,b)=> b.generatedAt.localeCompare(a.generatedAt));
      let html = `<div style="font-weight:800">Payroll</div><div style="margin-top:8px">`;
      if(pays.length === 0) html += '<div class="mini muted">No payslips found</div>';
      else {
        html += `<table style="width:100%;border-collapse:collapse"><thead><tr><th>Month</th><th>Gross</th><th>Net</th><th>Action</th></tr></thead><tbody>`;
        pays.forEach(p=> html += `<tr><td>${escapeHtml(p.month)}</td><td>${fmt(p.gross)}</td><td>${fmt(p.net)}</td><td><button class="btn ghost" onclick="pay_viewPayslip('${p.id}')">Download</button></td></tr>`);
        html += `</tbody></table>`;
      }
      html += `</div>`;
      pane.innerHTML = html;
    } else if(view === 'letters'){
      // show letters generated for this employee
      const hist = (STORE.lettersHistory||[]).filter(h=> h.employeeId === emp.id).slice().reverse();
      let html = `<div style="font-weight:800">My Letters</div><div style="margin-top:8px">`;
      if(hist.length === 0) html += '<div class="mini muted">No letters found</div>';
      else {
        html += `<table style="width:100%;border-collapse:collapse"><thead><tr><th>Type</th><th>Date</th><th>Action</th></tr></thead><tbody>`;
        hist.forEach(h=> html += `<tr><td>${escapeHtml(h.templateTitle)}</td><td>${new Date(h.date).toLocaleDateString()}</td><td><button class="btn ghost" onclick="letters_download('${h.id}')">Download</button></td></tr>`);
        html += `</tbody></table>`;
      }
      html += `</div>`;
      pane.innerHTML = html;
    } else if(view === 'idcard'){
      // allow download of ID card PDF and HTML
      pane.innerHTML = `<div style="font-weight:800">My ID Card</div><div style="margin-top:8px"><button class="btn ghost" onclick="id_downloadPdf()">Download ID PDF</button><button class="btn ghost" onclick="id_downloadHtml()">Download ID HTML</button></div>`;
    }
  }

  /* ------------------------
     Utility: currency format used by ESS payroll view
     ------------------------ */
  function fmt(v){ return '₹' + Number(v || 0).toFixed(2); }

  /* ------------------------
     Integrations & exposures
     ------------------------ */
  window.id_openGenerator = function(){
    if(!SESSION || SESSION.role !== 'admin') return alert('Admin only');
    id_populateEmployeeSelect();
    id_preview();
  };
  window.id_preview = id_preview;
  window.id_downloadPdf = id_downloadPdf;
  window.id_downloadHtml = id_downloadHtml;
  window.id_bulkGenerateAll = id_bulkGenerateAll;

  window.ess_login = ess_login;
  window.ess_logout = ess_logout;
  window.ess_view = ess_view;
  window.ess_renderProfileCard = ess_renderProfileCard;

  // Helper used in Employee Leaves view inside ESS
  window.leave_openApply = window.leave_openApply || function(){ alert('Leave apply not available'); };

  // Hook into route to populate when view is opened
  const prevRouteId = route;
  route = function(v){
    prevRouteId(v);
    try{
      if(v === 'idcard'){
        id_populateEmployeeSelect();
        id_preview();
      }
      if(v === 'ess'){
        // prepare employee select and session handling
        const sel = document.getElementById('id_emp_select');
        sel && id_populateEmployeeSelect();
        // if SESSION is employee, show ESS contents
        if(SESSION && SESSION.role === 'employee'){
          document.getElementById('essContent') && (document.getElementById('essContent').style.display = 'block');
          const emp = emp_find(SESSION.user.id);
          emp && ess_renderProfileCard(emp);
          ess_view('profile');
        }
      }
    }catch(e){ console.error('part8 route err', e); }
  };

  // If the idcard/ess view is showing (rare at load), initialize
  if(document.getElementById('idcardView') && document.getElementById('idcardView').style.display !== 'none'){
    id_populateEmployeeSelect(); id_preview();
  }
  if(document.getElementById('essView') && document.getElementById('essView').style.display !== 'none'){
    if(SESSION && SESSION.role === 'employee'){
      document.getElementById('essContent').style.display = 'block';
      const emp = emp_find(SESSION.user.id);
      emp && ess_renderProfileCard(emp);
    }
  }

  /* ===========================
     END PART 8
     =========================== */
}());


/* ===========================
   PART 9/10/11: Reports (R2), Documents (D2), Settings (S3)
   - Reports: Chart.js (dept bar, type pie, attendance line)
   - Documents: categorized repository with Public/Private
   - Settings: full configuration, module toggles, backup/import, audit
   Dependencies: STORE, saveStore(), uid(), emp_find(), emp_renderList(), logActivity(), escapeHtml(), html2canvas, jspdf, XLSX
   =========================== */

(function(){
  // ensure storages
  STORE.documents = STORE.documents || []; // {id,title,category,visibility('public'|'private'),data: base64,dataType,uploadedAt,uploadedBy}
  STORE.docCategories = STORE.docCategories || ['Company Policies','HR Forms','Salary Documents','Legal','Misc'];
  STORE.settings = STORE.settings || {
    companyName: 'Konarak Food & Beverages',
    logo: null,
    colorPrimary: '#3b82f6',
    modules: { recruitment:true, attendance:true, leave:true, payroll:true, ess:true, documents:true },
    lateThreshold: '09:15',
    workHours: 8,
    weeklyOff: [0],
    globalPF: false,
    esiThreshold: 21000,
    departments: ['Operations','Sales','HR'],
    holidays: []
  };
  STORE.activities = STORE.activities || []; // audit

  // ---------- Reports (R2) ----------
  let chartDept = null, chartType = null, chartAttendance = null;

  function reports_refreshAll(){
    reports_renderSummary();
    reports_renderDeptChart();
    reports_renderTypeChart();
    reports_renderAttendanceChart();
    reports_renderDeptTable();
  }

  function reports_renderSummary(){
    const total = (STORE.employees||[]).length;
    const today = new Date().toISOString().slice(0,10);
    const activeToday = (STORE.attendance||[]).filter(a=> a.date === today && a.checkIn).length;
    const onLeave = (STORE.attendance||[]).filter(a=> a.date === today && (a.status === 'Leave' || a.leaveType)).length;
    document.getElementById('r_totalEmployees').innerText = total;
    document.getElementById('r_activeToday').innerText = activeToday;
    document.getElementById('r_onLeaveToday').innerText = onLeave;
  }

  function reports_renderDeptChart(){
    const depts = {};
    (STORE.employees||[]).forEach(e=> {
      const d = (e.department || 'Unassigned');
      depts[d] = (depts[d]||0) + 1;
    });
    const labels = Object.keys(depts);
    const data = labels.map(l=> depts[l]);
    const ctx = document.getElementById('chartDept').getContext('2d');
    if(chartDept) chartDept.destroy();
    chartDept = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label:'Employees', data, backgroundColor: labels.map(()=> 'rgba(59,130,246,0.8)') }]},
      options: { responsive:true, maintainAspectRatio:false }
    });
  }

  function reports_renderTypeChart(){
    const types = { Permanent:0, Contract:0, Intern:0, Other:0 };
    (STORE.employees||[]).forEach(e=>{
      const t = (e.type || 'Permanent');
      types[t] = (types[t]||0) + 1;
    });
    const labels = Object.keys(types);
    const data = labels.map(l=> types[l]);
    const ctx = document.getElementById('chartType').getContext('2d');
    if(chartType) chartType.destroy();
    chartType = new Chart(ctx, {
      type: 'pie',
      data: { labels, datasets:[{ data, backgroundColor: ['#60a5fa','#34d399','#f59e0b','#c084fc'] }]},
      options: { responsive:true, maintainAspectRatio:false }
    });
  }

  function reports_renderAttendanceChart(){
    // show average present per day for current month (line)
    const now = new Date(); const year = now.getFullYear(); const month = now.getMonth();
    const days = new Date(year, month+1, 0).getDate();
    const labels = []; const data = [];
    for(let d=1; d<=days; d++){
      labels.push(String(d));
      const key = new Date(year, month, d).toISOString().slice(0,10);
      const present = (STORE.attendance||[]).filter(a=> a.date === key && a.checkIn).length;
      data.push(present);
    }
    const ctx = document.getElementById('chartAttendance').getContext('2d');
    if(chartAttendance) chartAttendance.destroy();
    chartAttendance = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets:[{ label:'Present count', data, fill:true, tension:0.2, backgroundColor:'rgba(59,130,246,0.15)', borderColor:'#3b82f6' }]},
      options: { responsive:true, maintainAspectRatio:false }
    });
  }

  function reports_renderDeptTable(){
    const tbody = document.querySelector('#r_dept_table tbody');
    tbody.innerHTML = '';
    const depts = {};
    (STORE.employees||[]).forEach(e=> { const d = e.department || 'Unassigned'; depts[d] = (depts[d]||0) + 1; });
    Object.keys(depts).forEach(d=>{
      const onLeave = (STORE.attendance||[]).filter(a=> a.date === new Date().toISOString().slice(0,10) && (emp_find(a.employeeId) || {}).department === d && (a.status === 'Leave' || a.leaveType)).length;
      tbody.insertAdjacentHTML('beforeend', `<tr><td>${escapeHtml(d)}</td><td>${depts[d]}</td><td>${onLeave}</td></tr>`);
    });
  }

  // PDF export of dashboard
  async function reports_exportPdf(){
    const dom = document.querySelector('#reportsView .section');
    const clone = dom.cloneNode(true);
    clone.style.background = '#fff'; clone.style.color = '#000'; clone.style.width = '1000px';
    document.body.appendChild(clone);
    const canvas = await html2canvas(clone, { scale:2 });
    const img = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit:'pt', format:'a4' });
    const pageW = pdf.internal.pageSize.getWidth();
    pdf.addImage(img, 'PNG', 20, 20, pageW-40, 0);
    pdf.save(`Dashboard_${new Date().toISOString().slice(0,10)}.pdf`);
    document.body.removeChild(clone);
  }

  // expose
  window.reports_refreshAll = reports_refreshAll;
  window.reports_exportPdf = reports_exportPdf;

  // ---------- Documents (D2) ----------
  function docs_renderCategories(){
    const wrap = document.getElementById('doc_categories');
    wrap.innerHTML = STORE.docCategories.map(c=> `<div style="padding:6px 4px;"><a href="#" onclick="docs_filterCategory('${escapeHtml(c)}');return false">${escapeHtml(c)}</a></div>`).join('');
  }

  function docs_filterCategory(cat){
    document._docs_activeCategory = cat;
    docs_renderList();
  }

  function docs_addCategory(){
    const v = (document.getElementById('doc_new_cat').value||'').trim();
    if(!v) return alert('Enter category name');
    if(STORE.docCategories.indexOf(v) !== -1) return alert('Category exists');
    STORE.docCategories.push(v);
    saveStore();
    docs_renderCategories();
    document.getElementById('doc_new_cat').value = '';
    logActivity(`Document category added: ${v}`);
    docs_renderList();
  }

  function docs_openUpload(){
    if(!SESSION || SESSION.role !== 'admin') return alert('Admin only');
    const modal = document.createElement('div'); modal.className='modal-backdrop';
    modal.innerHTML = `<div class="modal" style="width:720px;max-width:96vw;">
      <div style="display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:900">Upload Document</div><div><button class="btn ghost" id="docUpClose">Close</button></div></div>
      <div style="margin-top:8px;">
        <div class="mini muted">Title</div><input id="doc_title" class="field small" />
        <div class="mini muted" style="margin-top:8px">Category</div>
        <select id="doc_cat" class="field small">${STORE.docCategories.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('')}</select>
        <div class="mini muted" style="margin-top:8px">Visibility</div>
        <select id="doc_vis" class="field small"><option value="public">Public</option><option value="private">Private</option></select>
        <div class="mini muted" style="margin-top:8px">File</div><input id="doc_file" type="file" class="field small" />
        <div style="margin-top:10px;display:flex;gap:8px"><button class="btn primary" id="docUploadBtn">Upload</button><button class="btn ghost" id="docUploadCancel">Cancel</button></div>
      </div>
    </div>`;
    document.body.appendChild(modal);
    document.getElementById('docUpClose').addEventListener('click', ()=> modal.remove());
    document.getElementById('docUploadCancel').addEventListener('click', ()=> modal.remove());
    document.getElementById('docUploadBtn').addEventListener('click', ()=>{
      const title = (document.getElementById('doc_title').value||'').trim();
      const cat = document.getElementById('doc_cat').value;
      const vis = document.getElementById('doc_vis').value;
      const file = document.getElementById('doc_file').files[0];
      if(!title || !file) return alert('Provide title and file');
      const reader = new FileReader();
      reader.onload = function(e){
        const data = e.target.result;
        const doc = { id: uid('doc'), title, category: cat, visibility: vis, data, dataType: file.type, uploadedAt: new Date().toISOString(), uploadedBy: (SESSION && SESSION.user && SESSION.user.email) || 'admin' };
        STORE.documents.push(doc);
        saveStore();
        logActivity(`Document uploaded: ${title} (${cat}) by ${doc.uploadedBy}`);
        modal.remove();
        docs_renderList();
      };
      reader.readAsDataURL(file);
    });
  }

  function docs_renderList(){
    const tbody = document.querySelector('#docs_table tbody');
    tbody.innerHTML = '';
    const q = (document.getElementById('doc_search').value||'').toLowerCase();
    const activeCat = document._docs_activeCategory || '';
    let list = (STORE.documents||[]).slice().reverse();
    if(activeCat) list = list.filter(d=> d.category === activeCat);
    if(q) list = list.filter(d=> (d.title||'').toLowerCase().includes(q) || (d.category||'').toLowerCase().includes(q));
    list.forEach(d=>{
      const vis = d.visibility || 'public';
      const uploaded = new Date(d.uploadedAt).toLocaleString();
      tbody.insertAdjacentHTML('beforeend', `<tr>
        <td>${escapeHtml(d.title)}</td>
        <td>${escapeHtml(d.category)}</td>
        <td>${escapeHtml(vis)}</td>
        <td>${escapeHtml(uploaded)}</td>
        <td>
          <button class="btn ghost" onclick="docs_view('${d.id}')">View</button>
          ${SESSION && SESSION.role === 'admin' ? `<button class="btn ghost" onclick="docs_toggleVis('${d.id}')">Toggle Vis</button><button class="btn ghost" onclick="docs_delete('${d.id}')">Delete</button>` : ''}
        </td>
      </tr>`);
    });
  }

  function docs_view(id){
    const d = (STORE.documents||[]).find(x=> x.id===id);
    if(!d) return alert('Document not found');
    if(d.visibility === 'private' && !(SESSION && (SESSION.role === 'admin' || (SESSION.user && SESSION.user.id === d.uploadedBy)))) return alert('Private document');
    // open in new window as embedded
    const w = window.open('');
    w.document.write(`<iframe src="${d.data}" style="width:100%;height:100vh;border:none"></iframe>`);
  }

  function docs_toggleVis(id){
    const d = (STORE.documents||[]).find(x=> x.id===id);
    if(!d) return alert('Not found');
    d.visibility = d.visibility === 'public' ? 'private' : 'public';
    saveStore();
    docs_renderList();
    logActivity(`Document visibility toggled: ${d.title} → ${d.visibility}`);
  }

  function docs_delete(id){
    if(!confirm('Delete document?')) return;
    const d = (STORE.documents||[]).find(x=> x.id===id);
    STORE.documents = (STORE.documents||[]).filter(x=> x.id!==id);
    saveStore();
    docs_renderList();
    logActivity(`Document deleted: ${d && d.title}`);
  }

  function docs_exportList(){
    const rows = (STORE.documents||[]).map(d=> ({ Title: d.title, Category: d.category, Visibility: d.visibility, Uploaded: d.uploadedAt, By: d.uploadedBy }));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, 'Documents');
    XLSX.writeFile(wb, 'Documents_List.xlsx');
  }

  // expose docs functions
  window.docs_openUpload = docs_openUpload;
  window.docs_renderList = docs_renderList;
  window.docs_view = docs_view;
  window.docs_toggleVis = docs_toggleVis;
  window.docs_delete = docs_delete;
  window.docs_addCategory = docs_addCategory;
  window.docs_exportList = docs_exportList;
  window.docs_filterCategory = docs_filterCategory;

  // ---------- Settings (S3) ----------
  function settings_load(){
    const s = STORE.settings || {};
    document.getElementById('set_company_name').value = s.companyName || '';
    document.getElementById('set_color_primary').value = s.colorPrimary || '#3b82f6';
    // module toggles
    document.getElementById('mod_recruit').checked = !!(s.modules && s.modules.recruitment);
    document.getElementById('mod_attendance').checked = !!(s.modules && s.modules.attendance);
    document.getElementById('mod_leave').checked = !!(s.modules && s.modules.leave);
    document.getElementById('mod_payroll').checked = !!(s.modules && s.modules.payroll);
    document.getElementById('mod_ess').checked = !!(s.modules && s.modules.ess);
    document.getElementById('mod_documents').checked = !!(s.modules && s.modules.documents);
    document.getElementById('set_late_threshold').value = s.lateThreshold || '09:15';
    document.getElementById('set_work_hours').value = s.workHours || 8;
    document.getElementById('set_weekly_off').value = (s.weeklyOff || [0]).join(',');
    document.getElementById('set_esi_thr').value = s.esiThreshold || 21000;
    document.getElementById('set_departments').value = (s.departments || []).join(',');
    document.getElementById('set_holidays').value = (s.holidays || []).join(',');
    document.getElementById('set_global_pf').checked = !!s.globalPF;
    // logo preview not needed here
    // audit
    renderAudit();
    // categories & docs
    docs_renderCategories();
    docs_renderList();
  }

  function settings_save(){
    const s = STORE.settings;
    s.companyName = document.getElementById('set_company_name').value || s.companyName;
    s.colorPrimary = document.getElementById('set_color_primary').value || s.colorPrimary;
    s.modules = {
      recruitment: document.getElementById('mod_recruit').checked,
      attendance: document.getElementById('mod_attendance').checked,
      leave: document.getElementById('mod_leave').checked,
      payroll: document.getElementById('mod_payroll').checked,
      ess: document.getElementById('mod_ess').checked,
      documents: document.getElementById('mod_documents').checked
    };
    s.lateThreshold = document.getElementById('set_late_threshold').value || s.lateThreshold;
    s.workHours = Number(document.getElementById('set_work_hours').value||s.workHours);
    s.weeklyOff = (document.getElementById('set_weekly_off').value || '0').split(',').map(x=>Number(x.trim())).filter(x=>!isNaN(x));
    s.esiThreshold = Number(document.getElementById('set_esi_thr').value||s.esiThreshold);
    s.departments = (document.getElementById('set_departments').value || '').split(',').map(x=>x.trim()).filter(x=>x);
    s.holidays = (document.getElementById('set_holidays').value || '').split(',').map(x=>x.trim()).filter(x=>x);
    s.globalPF = document.getElementById('set_global_pf').checked;
    // persist
    STORE.settings = s;
    saveStore();
    logActivity('Settings updated');
    alert('Settings saved');
    // apply theme color (optional)
    document.documentElement.style.setProperty('--accent', s.colorPrimary || '#3b82f6');
  }

  function settings_uploadLogo(e){
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(evt){
      STORE.settings.logo = evt.target.result;
      saveStore();
      alert('Logo saved in settings (in localStorage)');
      logActivity('Company logo uploaded');
    };
    reader.readAsDataURL(file);
  }

  function settings_exportBackup(){
    const payload = { STORE };
    const a = document.createElement('a');
    a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(payload, null, 2));
    a.download = `Konarak_HRMS_Backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
  }

  function settings_importBackup(ev){
    const file = ev.target.files[0];
    if(!file) return alert('Select a file');
    const reader = new FileReader();
    reader.onload = function(e){
      try{
        const obj = JSON.parse(e.target.result);
        if(obj && obj.STORE){
          // merge carefully (overwrite)
          Object.assign(STORE, obj.STORE);
          saveStore();
          settings_load();
          reports_refreshAll();
          docs_renderCategories();
          docs_renderList();
          alert('Backup imported (STORE replaced). Please reload view if necessary.');
          logActivity('Backup imported');
        } else alert('Invalid backup file');
      }catch(err){ alert('Import failed'); console.error(err); }
    };
    reader.readAsText(file);
  }

  function settings_clearAudit(){
    if(!confirm('Clear audit log?')) return;
    STORE.activities = [];
    saveStore();
    renderAudit();
    logActivity('Audit cleared');
  }

  function renderAudit(){
    const wrap = document.getElementById('audit_log');
    wrap.innerHTML = '';
    const items = (STORE.activities||[]).slice().reverse();
    items.slice(0,200).forEach(it=>{
      const line = `${new Date(it.time||it.ts||Date.now()).toLocaleString()} — ${escapeHtml(it.msg||JSON.stringify(it))}`;
      wrap.insertAdjacentHTML('beforeend', `<div class="mini muted" style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.02)">${line}</div>`);
    });
  }

  // push to audit
  function auditPush(msg){
    STORE.activities = STORE.activities || [];
    STORE.activities.push({ id: uid('act'), ts: new Date().toISOString(), msg });
    saveStore();
    renderAudit();
  }

  // wire audit to logActivity if exists
  try{
    // if logActivity is available, monkey patch to also push to STORE.activities
    const origLog = window.logActivity;
    window.logActivity = function(msg){
      if(typeof origLog === 'function') origLog(msg);
      auditPush(msg);
    };
  }catch(e){ console.warn('Audit hook error', e); }

  // ---------- Initialization when view opens ----------
  const prevRouteExtra = route;
  route = function(v){
    prevRouteExtra(v);
    try{
      if(v === 'reports'){
        // Wait brief to ensure DOM canvas available
        setTimeout(()=> reports_refreshAll(), 120);
      }
      if(v === 'documents'){
        settings_load();
        docs_renderCategories();
        docs_renderList();
      }
      if(v === 'settings'){
        settings_load();
      }
    }catch(e){ console.error('reports/docs/settings route err', e); }
  };

  // Initial load if views present
  if(document.getElementById('reportsView') && document.getElementById('reportsView').style.display !== 'none'){
    setTimeout(()=> reports_refreshAll(), 120);
  }
  if(document.getElementById('documentsView')){
    docs_renderCategories();
    docs_renderList();
  }
  if(document.getElementById('settingsView')){
    settings_load();
  }

  // Expose settings functions
  window.settings_save = settings_save;
  window.settings_load = settings_load;
  window.settings_exportBackup = settings_exportBackup;
  window.settings_importBackup = settings_importBackup;
  window.settings_uploadLogo = settings_uploadLogo;
  window.settings_clearAudit = settings_clearAudit;

  // ensure charts are cleaned up on unload (defensive)
  window.addEventListener('beforeunload', ()=> {
    try{ chartDept && chartDept.destroy(); chartType && chartType.destroy(); chartAttendance && chartAttendance.destroy(); }catch(e){}
  });

}());
/* ===========================
   END PART 9/10/11
   =========================== */


/* ===========================
   End of Part 1 core file
   Next: Part 2 will add Employee Master UI + CRUD + file/attachments + robust password generation
   =========================== */

</script>
</body>
</html>
