<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Konarak Food & Beverages — HRMS (Frontend Demo)</title>

  <!-- External libraries for later parts (SheetJS, html2canvas, jsPDF will be used later) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ---------- CORE THEME (dark-first) ---------- */
    :root{
      --bg-1: #071026; --bg-2: #0b1830;
      --header: #061426; --card: #071133; --muted: #99a7c0; --accent: #0ea5e9;
      --accent-strong: #00bfff; --text: #e6eef8;
      --danger: #ef4444;
      --glass: rgba(255,255,255,0.02);
    }
    [data-theme="light"]{
      --bg-1:#eef2f3; --bg-2:#d9e4f5; --header:#1f2937; --card:#fff; --muted:#6b7280; --accent:#2563eb; --text:#0f172a; --glass: rgba(0,0,0,0.03);
    }
    html,body{height:100%;}
    body{
      margin:0; font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(135deg,var(--bg-1),var(--bg-2));
      color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* Header */
    .header{
      height:64px; background:var(--header); color:var(--text);
      display:flex; align-items:center; justify-content:space-between;
      padding:0 20px; box-shadow: 0 6px 22px rgba(0,0,0,0.45); position:sticky; top:0; z-index:60;
    }
    .logo-row{display:flex;gap:12px;align-items:center;}
    .logo-image{width:44px;height:44px;object-fit:contain;border-radius:8px;background:var(--glass);padding:6px;}
    .app-title{font-weight:800;font-size:18px;}
    .header-right{display:flex;gap:12px;align-items:center;}

    .menu-icon{font-size:26px;cursor:pointer; user-select:none;}

    /* Side menu */
    .side-menu{
      position:fixed; top:0; left:-320px; width:320px; height:100vh; padding-top:64px;
      background: linear-gradient(180deg, rgba(2,6,23,0.95), rgba(6,10,30,0.95));
      color:var(--muted); transition: left 220ms ease; z-index:70; overflow:auto;
    }
    .side-menu a{display:block;padding:14px 20px;color:var(--muted);text-decoration:none;border-bottom:1px solid rgba(255,255,255,0.02);}
    .side-menu a:hover{background:rgba(255,255,255,0.02); color:var(--text);}

    .menu-backdrop{display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:65;}

    /* App area */
    .app{ padding:28px; margin-left:0; transition: margin-left 220ms ease; min-height:calc(100vh - 64px); }
    .container{ max-width:1180px; margin:0 auto; }

    /* Card grid (home) */
    .grid{ display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:22px; margin-top:12px; }

    .card{
      background:var(--card); border-radius:14px; padding:26px 18px; text-align:center; box-shadow: 0 8px 20px rgba(0,0,0,0.18);
      cursor:pointer; transition: transform 180ms ease, box-shadow 180ms ease; overflow:hidden; position:relative;
    }
    .card:hover{ transform:translateY(-6px); box-shadow: 0 18px 40px rgba(0,0,0,0.28); }
    .card .icon{ width:56px;height:56px;margin:0 auto 12px; opacity:0.95; filter:brightness(1.1); }
    .card .label{ font-weight:800; font-size:16px; color:var(--text); }

    /* sections + forms */
    .section{ background:var(--card); border-radius:12px; padding:18px; margin-bottom:18px; box-shadow: 0 8px 18px rgba(0,0,0,0.12); }
    .section-title{ font-weight:800; font-size:16px; margin-bottom:6px; color:var(--accent-strong); }
    .row{ display:flex; gap:12px; align-items:center; }
    .col{ flex:1; }

    .field{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--text); }
    .field.small{ padding:8px; font-size:13px; }

    .btn{ padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
    .btn.primary{ background:var(--accent-strong); color:#002033; }
    .btn.ghost{ background:transparent; color:var(--text); border:1px solid rgba(255,255,255,0.04); }

    table{ width:100%; border-collapse:collapse; margin-top:8px; }
    th,td{ text-align:left; padding:10px; border-bottom:1px solid rgba(255,255,255,0.03); font-size:13px; color:var(--text); }
    th{ font-weight:700; color:white; background:linear-gradient(90deg, rgba(10,20,40,0.95), rgba(5,15,30,0.9)); }

    .muted{ color:var(--muted); font-size:13px; }
    .mini{ font-size:12px; color:var(--muted); }

    /* login modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:120; }
    .modal{ width:420px; background:var(--card); border-radius:12px; padding:18px; box-shadow: 0 20px 60px rgba(0,0,0,0.6); }

    /* responsive */
    @media(max-width:900px){ .row{ flex-direction:column; } .side-menu{ width:260px; } }

  </style>
</head>
<body data-theme="dark">

  <!-- HEADER -->
  <div class="header">
    <div class="logo-row">
      <img src="logo.png" alt="Konarak Logo" class="logo-image" onerror="this.style.display='none'">
      <div>
        <div class="app-title">Konarak Food & Beverages — HRMS (Frontend)</div>
        <div class="mini muted">Local demo — secure your production deployment</div>
      </div>
    </div>

    <div class="header-right">
      <div class="muted" id="headerUser">Not signed in</div>
      <div class="menu-icon" onclick="toggleMenu()">☰</div>
    </div>
  </div>

  <!-- SIDE MENU -->
  <nav id="sideMenu" class="side-menu" aria-hidden="true">
    <a href="#" onclick="route('home')">Home</a>
    <a href="#" onclick="route('dashboard')">Dashboard</a>
    <a href="#" onclick="route('employees')">Employee Central</a>
    <a href="#" onclick="route('recruitment')">Recruitment</a>
    <a href="#" onclick="route('attendance')">Attendance</a>
    <a href="#" onclick="route('leave')">Leave Management</a>
    <a href="#" onclick="route('payroll')">Payroll</a>
    <a href="#" onclick="route('documents')">Documents</a>
    <a href="#" onclick="route('performance')">Performance</a>
    <a href="#" onclick="route('idcards')">ID Cards</a>
    <a href="#" onclick="route('letters')">Letters & Templates</a>
    <a href="#" onclick="route('reports')">Reports</a>
    <a href="#" onclick="route('settings')">Settings</a>
    <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:8px 0;">
    <a href="#" onclick="signOut()">Sign out</a>
  </nav>
  <div id="menuBackdrop" class="menu-backdrop" onclick="toggleMenu()"></div>

  <!-- APP -->
  <div class="app">
    <div class="container" id="appContainer">

      <!-- HOME VIEW -->
      <div id="homeView">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <div style="font-size:20px;font-weight:800">Welcome to Konarak HRMS (Frontend)</div>
            <div class="muted">Dark theme enabled. All data stored locally (localStorage).</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;">
            <button class="btn ghost" onclick="openLogin()">Sign in</button>
            <button class="btn ghost" onclick="downloadBackup()">Download Backup</button>
            <label style="display:inline-block;">
              <input type="file" id="uploadBackup" class="mini" style="display:none" onchange="importBackup(event)">
              <button class="btn ghost" onclick="document.getElementById('uploadBackup').click()">Upload Backup</button>
            </label>
          </div>
        </div>

        <div class="grid" style="margin-top:18px;">
          <div class="card" onclick="route('dashboard')">
            <img class="icon" src="https://img.icons8.com/ios-filled/100/ffffff/dashboard.png" alt="">
            <div class="label">Dashboard</div>
          </div>
          <div class="card" onclick="route('employees')">
            <img class="icon" src="https://img.icons8.com/ios-filled/100/ffffff/user-group-man-man.png" alt="">
            <div class="label">Employee Central</div>
          </div>
          <div class="card" onclick="route('recruitment')">
            <img class="icon" src="https://img.icons8.com/ios-filled/100/ffffff/resume.png" alt="">
            <div class="label">Recruitment</div>
          </div>
          <div class="card" onclick="route('attendance')">
            <img class="icon" src="https://img.icons8.com/ios-filled/100/ffffff/clock.png" alt="">
            <div class="label">Attendance</div>
          </div>
          <div class="card" onclick="route('payroll')">
            <img class="icon" src="https://img.icons8.com/ios-filled/100/ffffff/money-bag.png" alt="">
            <div class="label">Payroll</div>
          </div>
          <div class="card" onclick="route('documents')">
            <img class="icon" src="https://img.icons8.com/ios-filled/100/ffffff/document--v1.png" alt="">
            <div class="label">Documents</div>
          </div>
          <div class="card" onclick="route('idcards')">
            <img class="icon" src="https://img.icons8.com/ios-filled/100/ffffff/id-card.png" alt="">
            <div class="label">ID Cards</div>
          </div>
          <div class="card" onclick="route('letters')">
            <img class="icon" src="https://img.icons8.com/ios-filled/100/ffffff/new-post.png" alt="">
            <div class="label">Letters & Templates</div>
          </div>
        </div>
      </div>

      <!-- PLACEHOLDER VIEWS (will be replaced as part 2+) -->
      <div id="dashboardView" class="section" style="display:none;">
        <div class="section-title">Dashboard</div>
        <div class="row" style="margin-top:8px;">
          <div class="col section">
            <div class="mini">Total employees</div>
            <div style="font-weight:900;font-size:22px;" id="kpiEmployees">0</div>
            <div class="mini">Use Employee Central to add new employees</div>
          </div>
          <div class="col section">
            <div class="mini">Pending leaves</div>
            <div style="font-weight:900;font-size:22px;" id="kpiLeaves">0</div>
            <div class="mini">Leave management will show approvals</div>
          </div>
          <div class="col section">
            <div class="mini">Attendance logs</div>
            <div style="font-weight:900;font-size:22px;" id="kpiAttendance">0</div>
            <div class="mini">Attendance module will show IN/OUT</div>
          </div>
        </div>

        <div style="margin-top:14px;" id="recentActivity" class="small muted">No activity yet</div>
      </div>

      <!-- Employee central simple placeholder -->
    <!-- ========== EMPLOYEE CENTRAL (Replace the old employeesView block with this) ========== -->
<div id="employeesView" style="display:none;">
  <div class="section">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <div class="section-title">Employee Central</div>
        <div class="mini muted">Full employee master (SAP-style). Admin only: create/edit/delete employees.</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn primary" onclick="emp_openForm()">+ New Employee</button>
        <button class="btn ghost" onclick="emp_exportExcel()">Export Excel</button>
        <button class="btn ghost" onclick="emp_exportPdfAll()">Export PDF (All)</button>
        <button class="btn ghost" onclick="seedDemoData()">Seed Demo Data</button>
      </div>
    </div>

    <!-- SEARCH & FILTERS -->
    <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
      <input id="empSearch" class="field small" placeholder="Search by name,code,email,dept..." oninput="emp_renderList()" />
      <select id="empFilterDept" class="field small" onchange="emp_renderList()">
        <option value="">All Departments</option>
      </select>
      <select id="empFilterType" class="field small" onchange="emp_renderList()">
        <option value="">All Types</option>
        <option value="Permanent">Permanent</option>
        <option value="Contract">Contract</option>
      </select>
      <div style="margin-left:auto"><span class="mini muted">Total: <strong id="empTotal">0</strong></span></div>
    </div>

    <!-- FORM (collapsible) -->
    <div id="empFormWrap" class="section" style="margin-top:12px; display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:800" id="empFormTitle">New Employee</div>
        <div class="mini muted">Fields marked * are required</div>
      </div>

      <div style="margin-top:10px;">
        <!-- Row 1 -->
        <div class="row">
          <div class="col"><input id="f_fullname" class="field" placeholder="Full name *"></div>
          <div style="width:220px"><input id="f_code" class="field" placeholder="Employee code (EMP...)" ></div>
        </div>

        <!-- Row 2 -->
        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="f_email" class="field" placeholder="Email *"></div>
          <div class="col"><input id="f_phone" class="field" placeholder="Mobile"></div>
        </div>

        <!-- Row 3 -->
        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="f_department" class="field" placeholder="Department"></div>
          <div class="col"><input id="f_designation" class="field" placeholder="Designation"></div>
        </div>

        <!-- Row 4 -->
        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="f_doj" type="date" class="field" placeholder="Date of Joining"></div>
          <div class="col"><input id="f_dob" type="date" class="field" placeholder="Date of Birth"></div>
        </div>

        <!-- Row 5 (System & Type) -->
        <div class="row" style="margin-top:8px;">
          <div class="col">
            <select id="f_type" class="field">
              <option value="Permanent">Permanent</option>
              <option value="Contract">Contract</option>
            </select>
          </div>
          <div class="col"><input id="f_manager" class="field" placeholder="Reporting manager (code or name)"></div>
        </div>

        <!-- Salary block -->
        <div style="margin-top:10px; font-weight:800;">Salary & Payroll</div>
        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="f_basic" type="number" class="field" placeholder="Basic salary"></div>
          <div class="col"><input id="f_hra" type="number" class="field" placeholder="HRA"></div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="f_convey" type="number" class="field" placeholder="Conveyance"></div>
          <div class="col"><input id="f_special" type="number" class="field" placeholder="Special allowance"></div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="col"><label class="mini muted">PF Applicable</label><select id="f_pf" class="field small"><option value="yes">Yes</option><option value="no">No</option></select></div>
          <div class="col"><label class="mini muted">ESI Applicable</label><select id="f_esi" class="field small"><option value="yes">Yes</option><option value="no">No</option></select></div>
        </div>

        <!-- KYC & Bank -->
        <div style="margin-top:10px; font-weight:800;">KYC & Bank</div>
        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="f_aadhaar" class="field" placeholder="Aadhaar number"></div>
          <div class="col"><input id="f_pan" class="field" placeholder="PAN number"></div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="f_bank" class="field" placeholder="Bank name"></div>
          <div class="col"><input id="f_account" class="field" placeholder="Bank account number"></div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="f_ifsc" class="field" placeholder="IFSC"></div>
          <div class="col"><input id="f_location" class="field" placeholder="Branch / Location"></div>
        </div>

        <!-- Address -->
        <div style="margin-top:10px; font-weight:800;">Address</div>
        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="f_present" class="field" placeholder="Present address"></div>
          <div class="col"><input id="f_permanent" class="field" placeholder="Permanent address"></div>
        </div>
        <div class="row" style="margin-top:8px;">
          <div class="col"><input id="f_city" class="field" placeholder="City"></div>
          <div class="col"><input id="f_state" class="field" placeholder="State"></div>
        </div>

        <!-- Photo & docs -->
        <div style="margin-top:10px;" class="mini muted">Photo & Documents</div>
        <div class="row" style="margin-top:6px;">
          <div class="col"><input id="f_photo" type="file" accept="image/*" class="field small"></div>
          <div class="col"><input id="f_docs" type="file" accept=".pdf,.jpg,.png" multiple class="field small"></div>
        </div>

        <!-- Buttons -->
        <div style="display:flex;gap:8px;margin-top:12px;">
          <button class="btn primary" id="empSaveBtn" onclick="emp_save()">Save employee</button>
          <button class="btn ghost" onclick="emp_cancel()">Cancel</button>
          <div style="margin-left:auto" class="mini muted">Password will be auto-generated and shown once.</div>
        </div>
      </div>
    </div>

    <!-- Employee list -->
    <div id="empListWrap" class="section" style="margin-top:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:800">Employees</div>
        <div class="mini muted">Actions: View • Edit • Delete • Export • Create login</div>
      </div>

      <div style="margin-top:8px; overflow:auto; max-height:420px;">
        <table id="empTable">
          <thead>
            <tr><th>Name</th><th>Code</th><th>Dept</th><th>Desig</th><th>Phone</th><th>Salary</th><th>Actions</th></tr>
          </thead>
          <tbody id="empTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<!-- ========== END EMPLOYEE CENTRAL ========== -->


      <!-- Recruitment placeholder -->
      <div id="recruitmentView" style="display:none;">
        <div class="section">
          <div class="section-title">Recruitment</div>
          <div class="mini muted">Recruitment module coming next (Part 3)</div>
        </div>
      </div>

      <!-- Attendance placeholder -->
      <div id="attendanceView" style="display:none;">
        <div class="section">
          <div class="section-title">Attendance</div>
          <div class="mini muted">Attendance module coming next (Part 4). Methods: Web IN/OUT + Auto + Manual</div>
        </div>
      </div>

      <!-- Payroll placeholder -->
      <div id="payrollView" style="display:none;">
        <div class="section">
          <div class="section-title">Payroll</div>
          <div class="mini muted">Payroll module coming next (Part 6)</div>
        </div>
      </div>

      <!-- Documents placeholder -->
      <div id="documentsView" style="display:none;">
        <div class="section">
          <div class="section-title">Documents</div>
          <div class="mini muted">Documents module coming next (Part 5)</div>
        </div>
      </div>

      <!-- ID cards placeholder -->
      <div id="idcardsView" style="display:none;">
        <div class="section">
          <div class="section-title">ID Cards</div>
          <div class="mini muted">ID card generator coming in Part 8 (vertical premium design)</div>
        </div>
      </div>

      <!-- Letters placeholder -->
      <div id="lettersView" style="display:none;">
        <div class="section">
          <div class="section-title">Letters & Templates</div>
          <div class="mini muted">Offer/hike/experience etc. will be included in Part 7</div>
        </div>
      </div>

      <!-- Reports placeholder -->
      <div id="reportsView" style="display:none;">
        <div class="section">
          <div class="section-title">Reports</div>
          <div class="mini muted">Reports & exports in Part 9</div>
        </div>
      </div>

      <!-- Settings placeholder -->
      <div id="settingsView" style="display:none;">
        <div class="section">
          <div class="section-title">Settings</div>
          <div style="display:flex;gap:12px;align-items:center;">
            <div>
              <div class="mini muted">Theme</div>
              <select id="themeSelect" class="field small" onchange="applyThemeLocal()">
                <option value="dark">Dark</option>
                <option value="light">Light</option>
                <option value="purple">Purple Accent</option>
                <option value="blue">Blue Accent</option>
              </select>
            </div>
            <div>
              <div class="mini muted">Admin account</div>
              <div class="mini">Admin: <strong>konarakfb@gmail.com</strong></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- LOGIN MODAL (reusable) -->
  <div id="loginModal" style="display:none;" class="modal-backdrop">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:800">Sign in</div>
        <div class="mini muted">Konarak HRMS</div>
      </div>

      <div style="margin-top:12px;">
        <div class="mini muted">Sign in as</div>
        <select id="loginRole" class="field small" style="margin-top:6px;">
          <option value="admin">Admin</option>
          <option value="employee">Employee</option>
        </select>

        <div id="adminLoginFields" style="margin-top:8px;">
          <input id="adminEmail" class="field small" placeholder="Email" value="konarakfb@gmail.com">
          <input id="adminPass" type="password" class="field small" placeholder="Password" value="Money@123">
        </div>

        <div id="empLoginFields" style="display:none;margin-top:8px;">
          <input id="empCode" class="field small" placeholder="Employee Code (e.g. EMP1001)">
          <input id="empPass" type="password" class="field small" placeholder="Password">
        </div>

        <div style="display:flex;gap:8px;margin-top:10px;">
          <button class="btn primary" onclick="performLogin()">Sign in</button>
          <button class="btn ghost" onclick="closeLogin()">Cancel</button>
        </div>

        <div class="mini muted" style="margin-top:8px;">Admin credentials: konarakfb@gmail.com / Money@123</div>
      </div>
    </div>
  </div>

<script>
/* ===========================
   Part 1: Core framework JS
   STORE structure and helpers
   =========================== */

const STORE_KEY = 'konarak_sf_complete_v1';

/* Default store template (safe seed) */
const DEFAULT_STORE = {
  meta: {
    createdAt: new Date().toISOString(),
    theme: 'dark',
    admins: [
      // seeded admin (your requested credentials)
      { email: 'konarakfb@gmail.com', password: 'Money@123', name: 'Konarak Admin', role: 'superadmin' }
    ]
  },
  employees: [],
  candidates: [],
  attendance: [],
  leaves: [],
  payroll: [],
  documents: [],
  goals: [],
  logs: [] // activity logs
};

let STORE = {};

/* Utility: safe load/save */
function loadStore(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw){ STORE = DEFAULT_STORE; saveStore(); return; }
    STORE = JSON.parse(raw);
    // ensure keys exist
    for(const k of Object.keys(DEFAULT_STORE)){
      if(typeof STORE[k] === 'undefined') STORE[k] = DEFAULT_STORE[k];
    }
  } catch(e){
    console.error('loadStore error', e);
    STORE = DEFAULT_STORE;
    saveStore();
  }
}
function saveStore(){
  localStorage.setItem(STORE_KEY, JSON.stringify(STORE));
}

/* UID generator */
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }

/* File to base64 helper (returns dataURL) */
function fileToBase64(file){ return new Promise((res,rej)=>{ const fr = new FileReader(); fr.onload = ()=> res(fr.result); fr.onerror = rej; fr.readAsDataURL(file); }); }

/* Escape for HTML insertion */
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"'`=\/]/g, function (c) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[c]; }); }

/* Logging helper */
function logActivity(text){
  STORE.logs = STORE.logs || [];
  STORE.logs.push({ text, time: new Date().toISOString() });
  if(STORE.logs.length > 5000) STORE.logs.shift();
  saveStore();
}

/* Initialize */
loadStore();

/* ===========================
   Theme engine
   =========================== */
function applyThemeLocal(){
  const sel = document.getElementById('themeSelect');
  const val = sel ? sel.value : (STORE.meta && STORE.meta.theme ? STORE.meta.theme : 'dark');
  if(val === 'light'){ document.body.setAttribute('data-theme','light'); STORE.meta.theme = 'light'; document.documentElement.style.setProperty('--accent-strong','#2563eb'); }
  else if(val === 'purple'){ document.body.setAttribute('data-theme','dark'); STORE.meta.theme = 'purple'; document.documentElement.style.setProperty('--accent-strong','#7c3aed'); }
  else if(val === 'blue'){ document.body.setAttribute('data-theme','dark'); STORE.meta.theme = 'blue'; document.documentElement.style.setProperty('--accent-strong','#0ea5e9'); }
  else { document.body.setAttribute('data-theme','dark'); STORE.meta.theme = 'dark'; document.documentElement.style.setProperty('--accent-strong','#0ea5e9'); }
  saveStore();
}
function applyThemeInitial(){
  const t = (STORE.meta && STORE.meta.theme) || 'dark';
  const sel = document.getElementById('themeSelect');
  if(sel) sel.value = t;
  applyThemeLocal();
}
applyThemeInitial();

/* ===========================
   Navigation + menu
   =========================== */
function toggleMenu(){
  const menu = document.getElementById('sideMenu');
  const backdrop = document.getElementById('menuBackdrop');
  if(menu.style.left === '0px'){ menu.style.left = '-320px'; backdrop.style.display = 'none'; }
  else { menu.style.left = '0px'; backdrop.style.display = 'block'; }
}
function route(view){
  // hide menu
  document.getElementById('sideMenu').style.left = '-320px';
  document.getElementById('menuBackdrop').style.display = 'none';
  // hide all views inside appContainer (direct children)
  const container = document.getElementById('appContainer');
  Array.from(container.children).forEach(ch => ch.style.display = 'none');

  // map view to id
  const map = {
    home: 'homeView',
    dashboard: 'dashboardView',
    employees: 'employeesView',
    recruitment: 'recruitmentView',
    attendance: 'attendanceView',
    leave: 'leaveView',
    payroll: 'payrollView',
    documents: 'documentsView',
    performance: 'performanceView',
    idcards: 'idcardsView',
    letters: 'lettersView',
    reports: 'reportsView',
    settings: 'settingsView'
  };
  const id = map[view] || 'homeView';
  const el = document.getElementById(id);
  if(el) el.style.display = 'block';
  // call renderers for specific pages (if available)
  try{ if(view === 'dashboard') renderDashboard(); if(view === 'employees') renderEmployeesShort(); } catch(e){ console.warn('route render error', e); }
  window.scrollTo({top:0, behavior:'smooth'});
}

/* ===========================
   AUTH: Login / session
   - Front-end session only
   - Admin and employee
   =========================== */

let SESSION = { user: null, role: null }; // role: admin | employee

function openLogin(){
  document.getElementById('loginModal').style.display = 'flex';
  // reset fields
  document.getElementById('loginRole').value = 'admin';
  document.getElementById('adminLoginFields').style.display = 'block';
  document.getElementById('empLoginFields').style.display = 'none';
}
function closeLogin(){ document.getElementById('loginModal').style.display = 'none'; }
document.getElementById('loginRole').addEventListener('change', function(e){
  const v = e.target.value;
  document.getElementById('adminLoginFields').style.display = v === 'admin' ? 'block' : 'none';
  document.getElementById('empLoginFields').style.display = v === 'employee' ? 'block' : 'none';
});

/* Perform login */
function performLogin(){
  const role = document.getElementById('loginRole').value;
  if(role === 'admin'){
    const email = (document.getElementById('adminEmail').value || '').trim();
    const pass = (document.getElementById('adminPass').value || '').trim();
    const found = (STORE.meta && STORE.meta.admins || []).find(a => a.email === email && a.password === pass);
    if(!found){ alert('Invalid admin credentials'); return; }
    SESSION = { user: found, role: 'admin' };
    closeLogin(); onSignedIn();
  } else {
    const code = (document.getElementById('empCode').value || '').trim();
    const pass = (document.getElementById('empPass').value || '').trim();
    if(!code || !pass){ alert('Employee code and password required'); return; }
    const emp = STORE.employees.find(e => (e.code === code || e.email === code) && e.password === pass);
    if(!emp){ alert('Invalid employee credentials'); return; }
    SESSION = { user: emp, role: 'employee' };
    closeLogin(); onSignedIn();
  }
}

/* Sign out */
function signOut(){
  SESSION = { user: null, role: null };
  document.getElementById('headerUser').innerText = 'Not signed in';
  route('home');
}

/* On sign-in */
function onSignedIn(){
  const role = SESSION.role;
  const name = SESSION.user && (SESSION.user.name || SESSION.user.fullname || SESSION.user.email) || 'user';
  document.getElementById('headerUser').innerText = `${name} (${role})`;
  logActivity(`${name} signed in as ${role}`);
  if(role === 'admin'){ route('dashboard'); }
  else { route('dashboard'); showEmployeeDashboard(); }
}

/* If a page needs to show employee-specific views, use this helper */
function requireAdmin(actionIfOk){
  if(SESSION.role !== 'admin') { alert('Admin access required'); return; }
  actionIfOk();
}

/* ===========================
   Simple UI renderers for Part1
   (will be expanded in later parts)
   =========================== */

function renderDashboard(){
  document.getElementById('kpiEmployees').innerText = (STORE.employees || []).length;
  document.getElementById('kpiLeaves').innerText = (STORE.leaves || []).filter(l=>l.status==='pending').length;
  document.getElementById('kpiAttendance').innerText = (STORE.attendance || []).length;
  // recent activity
  const recent = (STORE.logs || []).slice(-10).reverse();
  const out = recent.map(r => `<div class="mini" style="margin-bottom:6px">${escapeHtml(new Date(r.time).toLocaleString())} — ${escapeHtml(r.text)}</div>`).join('') || '<div class="mini muted">No recent activity</div>';
  document.getElementById('recentActivity').innerHTML = out;
}

/* Short employees render used on dashboard route */
function renderEmployeesShort(){
  const el = document.getElementById('empListPlaceholder');
  if(!el) return;
  if((STORE.employees||[]).length === 0) { el.innerHTML = '<div class="mini muted">No employees yet. Use Recruitment to add candidates and hire.</div>'; return; }
  const rows = STORE.employees.map(e => `<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.02)"><div><strong>${escapeHtml(e.fullname)}</strong><div class="mini muted">${escapeHtml(e.designation||'')} — ${escapeHtml(e.department||'')}</div></div><div class="mini muted">${escapeHtml(e.code||'')}</div></div>`).join('');
  el.innerHTML = rows;
}

/* Employee dashboard view for employees after login (basic) */
function showEmployeeDashboard(){
  // Ensure employee logged in
  if(!SESSION || SESSION.role !== 'employee') return;
  route('dashboard');
  // Add a custom welcome message for employee
  document.getElementById('recentActivity').innerHTML = `<div class="mini">Welcome ${escapeHtml(SESSION.user.fullname || SESSION.user.email)}. Use the left menu to view your data.</div>`;
}

/* ===========================
   Backup / Restore (single JSON)
   =========================== */
function downloadBackup(){
  const data = JSON.stringify(STORE, null, 2);
  const a = document.createElement('a');
  a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(data);
  a.download = `konarak_hrms_backup_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'_')}.json`;
  a.click();
  logActivity('Downloaded backup');
}
function importBackup(e){
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = () => {
    try{
      const parsed = JSON.parse(r.result);
      // Very small validation
      if(!parsed || typeof parsed !== 'object' || !parsed.meta) return alert('Invalid backup file');
      if(!confirm('Import backup will overwrite current local data. Continue?')) return;
      STORE = parsed;
      saveStore();
      renderDashboard();
      alert('Backup imported successfully.');
      logActivity('Imported backup');
    } catch(err){ alert('Invalid JSON file'); }
  };
  r.readAsText(f);
}

/* ===========================
   Prevent duplicate hires (recruitment safety)
   - Example usage in recruitment module (Part 3)
   =========================== */
function isDuplicateCandidate(candidate){
  // crude duplicate check: same email or phone or name+source
  const c = (STORE.candidates || []).find(x => (x.email && x.email === candidate.email) || (x.phone && x.phone === candidate.phone));
  if(c) return true;
  // also check employees
  const e = (STORE.employees || []).find(x => (x.email && x.email === candidate.email) || (x.phone && x.phone === candidate.phone));
  if(e) return true;
  return false;
}

/* ===========================
   Helper: seed sample data (for testing) - only when store empty and on admin action
   =========================== */
function seedDemoData(){
  if((STORE.employees||[]).length>0) { alert('Store already contains employees'); return; }
  // create 6 demo employees with passwords
  const demo = [
    {fullname:'Rahul Kumar', code:'EMP1001', email:'rahul@example.com', phone:'9876500011', department:'Operations', designation:'Manager', basic:30000},
    {fullname:'Asha Rani', code:'EMP1002', email:'asha@example.com', phone:'9876500022', department:'Sales', designation:'Executive', basic:22000},
    {fullname:'Siva Prasad', code:'EMP1003', email:'siva@example.com', phone:'9876500033', department:'Production', designation:'Supervisor', basic:25000},
    {fullname:'Maya Singh', code:'EMP1004', email:'maya@example.com', phone:'9876500044', department:'HR', designation:'HR Executive', basic:24000},
    {fullname:'Vikram Rao', code:'EMP1005', email:'vikram@example.com', phone:'9876500055', department:'Logistics', designation:'Lead', basic:26000},
    {fullname:'Neha Gupta', code:'EMP1006', email:'neha@example.com', phone:'9876500066', department:'Finance', designation:'Accountant', basic:27000}
  ];
  demo.forEach(d=>{
    const pwd = 'Welcome@' + Math.floor(Math.random()*900 + 100);
    const e = {...d, id: uid('emp'), password: pwd, photo:null, docs: [], doj: new Date().toISOString().slice(0,10), hra: Math.round(d.basic*0.2)};
    STORE.employees.push(e);
    logActivity(`Seed employee ${e.fullname} created (pwd:${pwd})`);
  });
  saveStore();
  alert('Demo employees seeded. Use Employee Central to see details. Default passwords created and logged to activity.');
  renderEmployeesShort();
}

/* Expose seed function to admin in console */
window.seedDemoData = seedDemoData;

/* ===========================
   Initial render
   =========================== */
renderDashboard();
renderEmployeesShort();
populateInitialUIState();

/* small helper to wire UI state on load */
function populateInitialUIState(){
  // header
  document.getElementById('headerUser').innerText = 'Not signed in';
  // set theme selector
  const sel = document.getElementById('themeSelect');
  if(sel) sel.value = STORE.meta.theme || 'dark';
  // route home
  route('home');
}


/* ===========================
   PART 2: Employee Central - Full SAP-style master
   Paste this block BEFORE the "End of Part 1 core file" comment
   It uses the existing STORE, saveStore(), uid(), fileToBase64(), escapeHtml(), logActivity(), requireAdmin()
   =========================== */

/* --- internal helper: get employee by id --- */
function emp_find(id){ return (STORE.employees||[]).find(e=>e.id===id); }

/* --- open form to create or edit --- */
function emp_openForm(editId){
  // Admin only
  if(SESSION.role !== 'admin') return alert('Admin access required');
  document.getElementById('empFormWrap').style.display = 'block';
  document.getElementById('empFormTitle').innerText = editId ? 'Edit Employee' : 'New Employee';
  // clear fields
  const ids = ['f_fullname','f_code','f_email','f_phone','f_department','f_designation','f_doj','f_dob','f_type','f_manager','f_basic','f_hra','f_convey','f_special','f_pf','f_esi','f_aadhaar','f_pan','f_bank','f_account','f_ifsc','f_location','f_present','f_permanent','f_city','f_state'];
  ids.forEach(i=> { const el=document.getElementById(i); if(el) el.value=''; });
  document.getElementById('f_photo').value=''; document.getElementById('f_docs').value='';
  // set defaults
  document.getElementById('f_type').value = 'Permanent';
  // store edit id on save button
  const saveBtn = document.getElementById('empSaveBtn');
  if(editId) saveBtn.dataset.edit = editId; else saveBtn.removeAttribute('data-edit');
  // preload existing when editing
  if(editId){
    const e = emp_find(editId);
    if(!e) return alert('Employee not found');
    document.getElementById('f_fullname').value = e.fullname || '';
    document.getElementById('f_code').value = e.code || '';
    document.getElementById('f_email').value = e.email || '';
    document.getElementById('f_phone').value = e.phone || '';
    document.getElementById('f_department').value = e.department || '';
    document.getElementById('f_designation').value = e.designation || '';
    document.getElementById('f_doj').value = e.doj || '';
    document.getElementById('f_dob').value = e.dob || '';
    document.getElementById('f_type').value = e.type || 'Permanent';
    document.getElementById('f_manager').value = e.manager || '';
    document.getElementById('f_basic').value = e.basic || 0;
    document.getElementById('f_hra').value = e.hra || 0;
    document.getElementById('f_convey').value = e.convey || 0;
    document.getElementById('f_special').value = e.special || 0;
    document.getElementById('f_pf').value = e.pf || 'yes';
    document.getElementById('f_esi').value = e.esi || 'no';
    document.getElementById('f_aadhaar').value = e.aadhaar || '';
    document.getElementById('f_pan').value = e.pan || '';
    document.getElementById('f_bank').value = e.bank || '';
    document.getElementById('f_account').value = e.account || '';
    document.getElementById('f_ifsc').value = e.ifsc || '';
    document.getElementById('f_location').value = e.location || '';
    document.getElementById('f_present').value = e.present_address || '';
    document.getElementById('f_permanent').value = e.permanent_address || '';
    document.getElementById('f_city').value = e.city || '';
    document.getElementById('f_state').value = e.state || '';
  }
  // scroll to form
  document.getElementById('empFormWrap').scrollIntoView({behavior:'smooth'});
}

/* --- cancel form --- */
function emp_cancel(){
  document.getElementById('empFormWrap').style.display = 'none';
  const saveBtn = document.getElementById('empSaveBtn'); if(saveBtn) saveBtn.removeAttribute('data-edit');
}

/* --- validate email basic --- */
function emp_isEmailValid(e){ return /\S+@\S+\.\S+/.test(e); }

/* --- generate secure password --- */
function emp_generatePassword(){
  const part = Math.random().toString(36).slice(-6);
  const special = ['@','!','#','$','%'][Math.floor(Math.random()*5)];
  return 'KF' + Math.floor(100+Math.random()*899) + part + special;
}

/* --- save employee (create/update) --- */
async function emp_save(){
  if(SESSION.role !== 'admin') return alert('Admin only');
  const saveBtn = document.getElementById('empSaveBtn');
  const editId = saveBtn && saveBtn.dataset && saveBtn.dataset.edit ? saveBtn.dataset.edit : null;

  // collect fields
  const data = {
    fullname: document.getElementById('f_fullname').value.trim(),
    code: document.getElementById('f_code').value.trim() || ('EMP' + Math.floor(1000 + Math.random()*8999)),
    email: document.getElementById('f_email').value.trim(),
    phone: document.getElementById('f_phone').value.trim(),
    department: document.getElementById('f_department').value.trim(),
    designation: document.getElementById('f_designation').value.trim(),
    doj: document.getElementById('f_doj').value,
    dob: document.getElementById('f_dob').value,
    type: document.getElementById('f_type').value,
    manager: document.getElementById('f_manager').value.trim(),
    basic: Number(document.getElementById('f_basic').value || 0),
    hra: Number(document.getElementById('f_hra').value || 0),
    convey: Number(document.getElementById('f_convey').value || 0),
    special: Number(document.getElementById('f_special').value || 0),
    pf: document.getElementById('f_pf').value,
    esi: document.getElementById('f_esi').value,
    aadhaar: document.getElementById('f_aadhaar').value.trim(),
    pan: document.getElementById('f_pan').value.trim(),
    bank: document.getElementById('f_bank').value.trim(),
    account: document.getElementById('f_account').value.trim(),
    ifsc: document.getElementById('f_ifsc').value.trim(),
    location: document.getElementById('f_location').value.trim(),
    present_address: document.getElementById('f_present').value.trim(),
    permanent_address: document.getElementById('f_permanent').value.trim(),
    city: document.getElementById('f_city').value.trim(),
    state: document.getElementById('f_state').value.trim()
  };

  // basic validation
  if(!data.fullname) return alert('Full name required');
  if(!data.email || !emp_isEmailValid(data.email)) return alert('Valid email required');

  // duplicate checks (code/email)
  const dupCode = (STORE.employees||[]).find(e => e.code === data.code && (!editId || e.id !== editId));
  if(dupCode) return alert('Employee code already exists');
  const dupEmail = (STORE.employees||[]).find(e => e.email === data.email && (!editId || e.id !== editId));
  if(dupEmail) return alert('Employee email already exists');

  // handle photo and docs
  const photoInput = document.getElementById('f_photo');
  if(photoInput && photoInput.files && photoInput.files[0]){
    data.photo = await fileToBase64(photoInput.files[0]);
  }

  const docsInput = document.getElementById('f_docs');
  data.docs = [];
  if(docsInput && docsInput.files && docsInput.files.length){
    for(const f of docsInput.files){
      const b = await fileToBase64(f);
      data.docs.push({ id: uid('doc'), name: f.name, data: b, uploadedAt: new Date().toISOString() });
    }
  }

  const now = new Date().toISOString();

  if(editId){
    // update
    const idx = (STORE.employees||[]).findIndex(x=>x.id===editId);
    if(idx === -1) return alert('Employee not found for update');
    const prev = STORE.employees[idx];
    // merge values, append docs if any
    const merged = {...prev, ...data, updatedAt: now};
    if(data.photo) merged.photo = data.photo;
    if(data.docs && data.docs.length) merged.docs = (prev.docs||[]).concat(data.docs);
    STORE.employees[idx] = merged;
    saveStore();
    emp_cancel();
    emp_renderList();
    emp_showMessage('Employee updated');
    logActivity(`Employee updated: ${merged.fullname} (${merged.code})`);
  } else {
    // create
    const id = uid('emp');
    const password = emp_generatePassword();
    const employee = {...data, id, createdAt: now, updatedAt: now, docs: data.docs || [], photo: data.photo || null, password};
    STORE.employees.push(employee);
    saveStore();
    emp_cancel();
    emp_renderList();
    emp_showMessage(`Employee created. Password: ${password}\n(Share with employee once)`);
    logActivity(`Employee created: ${employee.fullname} (${employee.code})`);
  }
  // refresh selects/filters
  emp_buildDeptFilter();
}

/* --- show transient message (small popup using alert fallback) --- */
function emp_showMessage(txt){
  // simple non-blocking toast
  try{
    const t = document.createElement('div');
    t.style.position='fixed'; t.style.right='20px'; t.style.bottom='20px'; t.style.background='var(--accent-strong)'; t.style.color='#001'; t.style.padding='10px 14px'; t.style.borderRadius='8px'; t.style.zIndex=9999; t.style.fontWeight=700; t.innerText = txt;
    document.body.appendChild(t);
    setTimeout(()=> t.remove(), 6000);
  } catch(e){ alert(txt); }
}

/* --- render employee list table --- */
function emp_renderList(){
  const tbody = document.getElementById('empTableBody');
  tbody.innerHTML = '';
  const q = (document.getElementById('empSearch').value || '').trim().toLowerCase();
  const deptFilter = document.getElementById('empFilterDept').value || '';
  const typeFilter = document.getElementById('empFilterType').value || '';
  let list = (STORE.employees||[]).slice().reverse(); // latest first
  if(q) list = list.filter(e => (e.fullname||'').toLowerCase().includes(q) || (e.code||'').toLowerCase().includes(q) || (e.email||'').toLowerCase().includes(q) || (e.department||'').toLowerCase().includes(q));
  if(deptFilter) list = list.filter(e=> (e.department||'') === deptFilter);
  if(typeFilter) list = list.filter(e=> (e.type||'') === typeFilter);
  list.forEach(e=>{
    const salary = Number(e.basic||0) + Number(e.hra||0) + Number(e.convey||0) + Number(e.special||0);
    tbody.insertAdjacentHTML('beforeend', `<tr>
      <td>${escapeHtml(e.fullname||'')}</td>
      <td>${escapeHtml(e.code||'')}</td>
      <td>${escapeHtml(e.department||'')}</td>
      <td>${escapeHtml(e.designation||'')}</td>
      <td>${escapeHtml(e.phone||'')}</td>
      <td>₹${salary.toFixed(2)}</td>
      <td>
        <button class="btn ghost" onclick="emp_view('${e.id}')">View</button>
        <button class="btn ghost" onclick="emp_edit('${e.id}')">Edit</button>
        <button class="btn ghost" onclick="emp_delete('${e.id}')">Delete</button>
        <button class="btn ghost" onclick="emp_exportPdf('${e.id}')">Export</button>
      </td>
    </tr>`);
  });
  document.getElementById('empTotal').innerText = (STORE.employees||[]).length;
}

/* --- view employee profile (modal) --- */
function emp_view(id){
  const e = emp_find(id);
  if(!e) return alert('Employee not found');
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  const html = `<div class="modal" style="width:760px;max-width:94vw;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:900">${escapeHtml(e.fullname)} (${escapeHtml(e.code||'')})</div>
      <div><button class="btn ghost" id="empCloseBtn">Close</button></div>
    </div>
    <div style="display:flex;gap:12px;margin-top:12px;">
      <div style="width:160px;height:200px;border-radius:8px;overflow:hidden;background:rgba(255,255,255,0.02);">
        ${e.photo ? `<img src="${e.photo}" style="width:100%;height:100%;object-fit:cover" />` : `<div style="padding:12px" class="mini muted">No photo</div>`}
      </div>
      <div style="flex:1">
        <div class="mini muted"><strong>Email:</strong> ${escapeHtml(e.email||'')}</div>
        <div class="mini muted"><strong>Phone:</strong> ${escapeHtml(e.phone||'')}</div>
        <div class="mini muted"><strong>Dept:</strong> ${escapeHtml(e.department||'')} • <strong>Desig:</strong> ${escapeHtml(e.designation||'')}</div>
        <div class="mini muted"><strong>Joining:</strong> ${escapeHtml(e.doj||'')} • <strong>Type:</strong> ${escapeHtml(e.type||'')}</div>
        <div style="margin-top:8px">
          <button class="btn primary" onclick="emp_downloadJson('${e.id}')">Download JSON</button>
          <button class="btn ghost" onclick="emp_exportPdf('${e.id}')">Download PDF</button>
        </div>
      </div>
      <div style="width:220px">
        <div class="mini muted"><strong>Salary</strong></div>
        <div class="mini">Basic: ₹${Number(e.basic||0).toFixed(2)}</div>
        <div class="mini">HRA: ₹${Number(e.hra||0).toFixed(2)}</div>
        <div class="mini">Conveyance: ₹${Number(e.convey||0).toFixed(2)}</div>
        <div style="margin-top:8px"><button class="btn ghost" onclick="emp_createPayslip('${e.id}')">Create Payslip</button></div>
      </div>
    </div>
    <div style="margin-top:12px;">
      <div style="font-weight:800;margin-bottom:6px">KYC & Bank</div>
      <div class="mini muted">Aadhaar: ${escapeHtml(e.aadhaar||'')}</div>
      <div class="mini muted">PAN: ${escapeHtml(e.pan||'')}</div>
      <div class="mini muted">Bank: ${escapeHtml(e.bank||'')} / ${escapeHtml(e.account||'')} / IFSC: ${escapeHtml(e.ifsc||'')}</div>
      <div style="margin-top:8px">
        <div style="font-weight:800;margin-bottom:6px">Documents</div>
        ${(e.docs || []).map(d=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(0,0,0,0.04)">${escapeHtml(d.name)}<div><button class="btn ghost" onclick="emp_downloadDoc('${e.id}','${d.id}')">Download</button></div></div>`).join('') || '<div class="mini muted">No documents</div>'}
      </div>
    </div>
  </div>`;
  modal.innerHTML = html;
  document.body.appendChild(modal);
  document.getElementById('empCloseBtn').addEventListener('click', ()=> modal.remove());
}

/* --- edit employee --- */
function emp_edit(id){
  requireAdmin(()=> {
    emp_openForm(id);
    // set dataset on save button
    document.getElementById('empSaveBtn').dataset.edit = id;
  });
}

/* --- delete employee --- */
function emp_delete(id){
  requireAdmin(()=> {
    if(!confirm('Delete employee and associated records?')) return;
    STORE.employees = (STORE.employees || []).filter(x=>x.id !== id);
    // purge attendance, leaves, payroll pointing to this employee
    STORE.attendance = (STORE.attendance||[]).filter(a=>a.employeeId !== id);
    STORE.leaves = (STORE.leaves||[]).filter(l=>l.employeeId !== id);
    STORE.payroll = (STORE.payroll||[]).filter(p=>p.employeeId !== id);
    saveStore();
    emp_renderList();
    logActivity(`Employee deleted: ${id}`);
  });
}

/* --- download employee JSON --- */
function emp_downloadJson(id){
  const e = emp_find(id);
  if(!e) return alert('Not found');
  const a = document.createElement('a');
  a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(e,null,2));
  a.download = `${e.code||e.id}.json`;
  a.click();
}

/* --- download employee document --- */
function emp_downloadDoc(empId, docId){
  const e = emp_find(empId);
  if(!e) return alert('Employee not found');
  const d = (e.docs||[]).find(x=>x.id===docId);
  if(!d) return alert('Document not found');
  const a = document.createElement('a');
  a.href = d.data;
  a.download = d.name;
  a.click();
}

/* --- export single employee as PDF --- */
async function emp_exportPdf(id){
  const e = emp_find(id);
  if(!e) return alert('Employee not found');
  // build a printable node
  const node = document.createElement('div');
  node.style.width = '800px';
  node.style.padding = '18px';
  node.style.background = '#fff';
  node.style.color = '#000';
  node.innerHTML = `
    <div style="display:flex;gap:12px;align-items:center;">
      <img src="logo.png" style="width:90px;height:90px;object-fit:contain" onerror="this.style.display='none'">
      <div>
        <div style="font-weight:900;font-size:20px">Konarak Food & Beverages</div>
        <div style="font-size:14px">Employee Profile</div>
      </div>
    </div>
    <hr style="margin:10px 0;border:none;border-top:1px solid #ddd">
    <div style="display:flex;gap:12px;">
      <div style="width:160px;height:160px;border:1px solid #ddd">${e.photo ? `<img src="${e.photo}" style="width:100%;height:100%;object-fit:cover">` : ''}</div>
      <div style="flex:1;">
        <div style="font-weight:800;font-size:18px">${escapeHtml(e.fullname)}</div>
        <div class="mini">Code: ${escapeHtml(e.code||'')}</div>
        <div class="mini">Email: ${escapeHtml(e.email||'')}</div>
        <div class="mini">Phone: ${escapeHtml(e.phone||'')}</div>
        <div style="margin-top:8px">
          <div class="mini"><strong>Department:</strong> ${escapeHtml(e.department||'')}</div>
          <div class="mini"><strong>Designation:</strong> ${escapeHtml(e.designation||'')}</div>
          <div class="mini"><strong>Joining:</strong> ${escapeHtml(e.doj||'')}</div>
          <div class="mini"><strong>Type:</strong> ${escapeHtml(e.type||'')}</div>
        </div>
      </div>
    </div>
    <hr style="margin:10px 0;border:none;border-top:1px solid #ddd">
    <div>
      <div style="font-weight:800;margin-bottom:6px">Salary & Bank</div>
      <div class="mini">Basic: ₹${Number(e.basic||0).toFixed(2)} • HRA: ₹${Number(e.hra||0).toFixed(2)} • Convey: ₹${Number(e.convey||0).toFixed(2)}</div>
      <div class="mini">Bank: ${escapeHtml(e.bank||'')} • A/C: ${escapeHtml(e.account||'')} • IFSC: ${escapeHtml(e.ifsc||'')}</div>
    </div>
  `;
  document.body.appendChild(node);
  const canvas = await html2canvas(node, { scale: 2 });
  const img = canvas.toDataURL('image/png');
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });
  const pageW = pdf.internal.pageSize.getWidth();
  const imgW = pageW - 40;
  pdf.addImage(img, 'PNG', 20, 20, imgW, 0);
  pdf.save(`Employee_${e.code||e.id}.pdf`);
  document.body.removeChild(node);
}

/* --- export all employees to Excel --- */
function emp_exportExcel(){
  const rows = (STORE.employees||[]).map(e => ({ Code: e.code, Name: e.fullname, Email: e.email, Dept: e.department, Desig: e.designation, Basic: e.basic }));
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'Employees');
  XLSX.writeFile(wb, 'Employees.xlsx');
}

/* --- export pdf for all (simple concatenation) --- */
async function emp_exportPdfAll(){
  const all = STORE.employees || [];
  if(all.length === 0) return alert('No employees');
  // For each employee create a small pdf page and combine (simple sequential saves to multiple PDFs is heavy)
  // We'll create a single PDF with pages appended
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit: 'pt', format: 'a4' });
  for(let i=0;i<all.length;i++){
    const e=all[i];
    const node = document.createElement('div');
    node.style.width='800px'; node.style.padding='18px'; node.style.background='#fff'; node.style.color='#000';
    node.innerHTML = `<div style="font-weight:800;font-size:18px">${escapeHtml(e.fullname)} — ${escapeHtml(e.code||'')}</div>
      <div class="mini">Email: ${escapeHtml(e.email||'')} • Dept: ${escapeHtml(e.department||'')}</div>
      <div style="margin-top:8px">Basic: ₹${Number(e.basic||0).toFixed(2)}</div>`;
    document.body.appendChild(node);
    // render
    // eslint-disable-next-line no-await-in-loop
    const canvas = await html2canvas(node, { scale: 2 });
    const img = canvas.toDataURL('image/png');
    const w = pdf.internal.pageSize.getWidth() - 40;
    if(i>0) pdf.addPage();
    pdf.addImage(img, 'PNG', 20, 20, w, 0);
    document.body.removeChild(node);
  }
  pdf.save('Employees_All.pdf');
}

/* --- create payslip for employee (basic) --- */
function emp_createPayslip(empId){
  const e = emp_find(empId);
  if(!e) return alert('Employee not found');
  // simple net calculation (similar to Part1 payroll)
  const basic = Number(e.basic||0);
  const hra = Number(e.hra||0);
  const conv = Number(e.convey||0);
  const special = Number(e.special||0);
  const gross = basic + hra + conv + special;
  const pf = e.pf === 'yes' ? Math.round(basic*0.12) : 0;
  const net = gross - pf;
  const rec = { id: uid('pay'), employeeId: empId, month: new Date().toISOString().slice(0,7), basic, hra, conv, special, gross, pf, net, generatedAt: new Date().toISOString() };
  STORE.payroll = STORE.payroll || [];
  STORE.payroll.push(rec);
  saveStore();
  emp_showMessage('Payslip created (Payroll record saved)');
  logActivity(`Payslip created for ${e.fullname}`);
}

/* --- build department filter options --- */
function emp_buildDeptFilter(){
  const sel = document.getElementById('empFilterDept');
  if(!sel) return;
  const depts = Array.from(new Set((STORE.employees||[]).map(e => e.department).filter(Boolean)));
  sel.innerHTML = '<option value="">All Departments</option>' + depts.map(d=>`<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`).join('');
}

/* --- create employee login page (not creating files — creates credentials only) --- */
function emp_generateLoginCredentials(empId){
  const e = emp_find(empId);
  if(!e) return alert('Employee not found');
  // set or reset password
  const pwd = emp_generatePassword();
  e.password = pwd;
  saveStore();
  emp_showMessage(`Password set for ${e.fullname}: ${pwd}`);
  logActivity(`Password generated for ${e.code}`);
  // NOTE: you'll need to distribute the password to the employee securely
}

/* initial render hook */
(function emp_init(){
  emp_buildDeptFilter();
  emp_renderList();
}());

/* expose some functions to global for button onclicks */
window.emp_openForm = emp_openForm;
window.emp_cancel = emp_cancel;
window.emp_save = emp_save;
window.emp_renderList = emp_renderList;
window.emp_view = emp_view;
window.emp_edit = emp_edit;
window.emp_delete = emp_delete;
window.emp_exportPdf = emp_exportPdf;
window.emp_exportExcel = emp_exportExcel;
window.emp_exportPdfAll = emp_exportPdfAll;
window.emp_createPayslip = emp_createPayslip;
window.emp_downloadJson = emp_downloadJson;
window.emp_generateLoginCredentials = emp_generateLoginCredentials;

/* ===========================
   End PART 2 code block
   =========================== */


  

/* ===========================
   End of Part 1 core file
   Next: Part 2 will add Employee Master UI + CRUD + file/attachments + robust password generation
   =========================== */

</script>
</body>
</html>
